<!DOCTYPE html>
<html>
<head>
  <title>shell.c</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../", thisFile = "node_modules/sqlite3/deps/sqlite3/shell.c", defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>shell.c</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>2001 September 15
*</li>
<li>The author disclaims copyright to this source code.  In place of</li>
<li>a legal notice, here is a blessing:
*</li>
<li>May you do good and not evil.</li>
<li>May you find forgiveness for yourself and forgive others.</li>
<li>May you share freely, never taking more than you give.
*</li>
</ul>

<hr />

<ul>
<li>This file contains code to implement the "sqlite" command line</li>
<li>utility for accessing SQLite databases.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="cp">#if (defined(_WIN32) || defined(WIN32)) &amp;&amp; !defined(_CRT_SECURE_NO_WARNINGS)</span>
<span class="cm">/* This needs to come before any includes for MSVC compiler */</span>
<span class="cp">#define _CRT_SECURE_NO_WARNINGS</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Enable large-file support for fopen() and friends on unix.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#ifndef SQLITE_DISABLE_LFS</span>
<span class="cp"># define _LARGE_FILE       1</span>
<span class="cp"># ifndef _FILE_OFFSET_BITS</span>
<span class="cp">#   define _FILE_OFFSET_BITS 64</span>
<span class="cp"># endif</span>
<span class="cp"># define _LARGEFILE_SOURCE 1</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;assert.h&gt;</span>
<span class="cp">#include &quot;sqlite3.h&quot;</span>
<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(WIN32) &amp;&amp; !defined(__OS2__)</span>
<span class="cp"># include &lt;signal.h&gt;</span>
<span class="cp"># if !defined(__RTP__) &amp;&amp; !defined(_WRS_KERNEL)</span>
<span class="cp">#  include &lt;pwd.h&gt;</span>
<span class="cp"># endif</span>
<span class="cp"># include &lt;unistd.h&gt;</span>
<span class="cp"># include &lt;sys/types.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __OS2__</span>
<span class="cp"># include &lt;unistd.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HAVE_EDITLINE</span>
<span class="cp"># include &lt;editline/editline.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(HAVE_READLINE) &amp;&amp; HAVE_READLINE==1</span>
<span class="cp"># include &lt;readline/readline.h&gt;</span>
<span class="cp"># include &lt;readline/history.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#if !defined(HAVE_EDITLINE) &amp;&amp; (!defined(HAVE_READLINE) || HAVE_READLINE!=1)</span>
<span class="cp"># define readline(p) local_getline(p,stdin,0)</span>
<span class="cp"># define add_history(X)</span>
<span class="cp"># define read_history(X)</span>
<span class="cp"># define write_history(X)</span>
<span class="cp"># define stifle_history(X)</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(_WIN32) || defined(WIN32)</span>
<span class="cp"># include &lt;io.h&gt;</span>
<span class="cp">#define isatty(h) _isatty(h)</span>
<span class="cp">#define access(f,m) _access((f),(m))</span>
<span class="cp">#define popen(a,b) _popen((a),(b))</span>
<span class="cp">#define pclose(x) _pclose(x)</span>
<span class="cp">#else</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Make sure isatty() has a prototype.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">isatty</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(_WIN32_WCE)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Windows CE (arm-wince-mingw32ce-gcc) does not provide isatty()
thus we always assume that we have a console. That can be
overridden with the -batch command line option.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#define isatty(x) 1</span>
<span class="cp">#endif</span>

<span class="cm">/* True if the timer is enabled */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enableTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* ctype macros that work with signed characters */</span>
<span class="cp">#define IsSpace(X)  isspace((unsigned char)X)</span>
<span class="cp">#define IsDigit(X)  isdigit((unsigned char)X)</span>
<span class="cp">#define ToLower(X)  (char)tolower((unsigned char)X)</span>

<span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(WIN32) &amp;&amp; !defined(__OS2__) &amp;&amp; !defined(__RTP__) &amp;&amp; !defined(_WRS_KERNEL)</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;sys/resource.h&gt;</span>

<span class="cm">/* Saved resource information for the beginning of an operation */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rusage</span> <span class="n">sBegin</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Begin timing an operation</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">beginTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">enableTimer</span> <span class="p">){</span>
    <span class="n">getrusage</span><span class="p">(</span><span class="n">RUSAGE_SELF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sBegin</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Return the difference of two time_structs in seconds */</span>
<span class="k">static</span> <span class="kt">double</span> <span class="nf">timeDiff</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">pStart</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">pEnd</span><span class="p">){</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">pStart</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">*</span><span class="mf">0.000001</span> <span class="o">+</span> 
         <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">pStart</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Print the timing results.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">endTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">enableTimer</span> <span class="p">){</span>
    <span class="k">struct</span> <span class="n">rusage</span> <span class="n">sEnd</span><span class="p">;</span>
    <span class="n">getrusage</span><span class="p">(</span><span class="n">RUSAGE_SELF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sEnd</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;CPU Time: user %f sys %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
       <span class="n">timeDiff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sBegin</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sEnd</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">),</span>
       <span class="n">timeDiff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sBegin</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sEnd</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define BEGIN_TIMER beginTimer()</span>
<span class="cp">#define END_TIMER endTimer()</span>
<span class="cp">#define HAS_TIMER 1</span>

<span class="cp">#elif (defined(_WIN32) || defined(WIN32))</span>

<span class="cp">#include &lt;windows.h&gt;</span>

<span class="cm">/* Saved resource information for the beginning of an operation */</span>
<span class="k">static</span> <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">;</span>
<span class="k">static</span> <span class="n">FILETIME</span> <span class="n">ftKernelBegin</span><span class="p">;</span>
<span class="k">static</span> <span class="n">FILETIME</span> <span class="n">ftUserBegin</span><span class="p">;</span>
<span class="k">typedef</span> <span class="nf">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">GETPROCTIMES</span><span class="p">)(</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">LPFILETIME</span><span class="p">,</span> <span class="n">LPFILETIME</span><span class="p">,</span> <span class="n">LPFILETIME</span><span class="p">,</span> <span class="n">LPFILETIME</span><span class="p">);</span>
<span class="k">static</span> <span class="n">GETPROCTIMES</span> <span class="n">getProcessTimesAddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Check to see if we have timer support.  Return 1 if necessary</li>
<li>support found (or found previously).</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hasTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">getProcessTimesAddr</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>GetProcessTimes() isn't supported in WIN95 and some other Windows versions.
* See if the version we are running on has it, and if it does, save off
* a pointer to it and the current process handle.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">hProcess</span> <span class="o">=</span> <span class="n">GetCurrentProcess</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">hProcess</span> <span class="p">){</span>
      <span class="n">HINSTANCE</span> <span class="n">hinstLib</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Kernel32.dll&quot;</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span> <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">hinstLib</span> <span class="p">){</span>
        <span class="n">getProcessTimesAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">GETPROCTIMES</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hinstLib</span><span class="p">,</span> <span class="s">&quot;GetProcessTimes&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">getProcessTimesAddr</span> <span class="p">){</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">hinstLib</span><span class="p">);</span> 
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Begin timing an operation</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">beginTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">enableTimer</span> <span class="o">&amp;&amp;</span> <span class="n">getProcessTimesAddr</span> <span class="p">){</span>
    <span class="n">FILETIME</span> <span class="n">ftCreation</span><span class="p">,</span> <span class="n">ftExit</span><span class="p">;</span>
    <span class="n">getProcessTimesAddr</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftCreation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftExit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftKernelBegin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftUserBegin</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Return the difference of two FILETIME structs in seconds */</span>
<span class="k">static</span> <span class="kt">double</span> <span class="nf">timeDiff</span><span class="p">(</span><span class="n">FILETIME</span> <span class="o">*</span><span class="n">pStart</span><span class="p">,</span> <span class="n">FILETIME</span> <span class="o">*</span><span class="n">pEnd</span><span class="p">){</span>
  <span class="n">sqlite_int64</span> <span class="n">i64Start</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">sqlite_int64</span> <span class="o">*</span><span class="p">)</span> <span class="n">pStart</span><span class="p">);</span>
  <span class="n">sqlite_int64</span> <span class="n">i64End</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">sqlite_int64</span> <span class="o">*</span><span class="p">)</span> <span class="n">pEnd</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="p">((</span><span class="n">i64End</span> <span class="o">-</span> <span class="n">i64Start</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10000000.0</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Print the timing results.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">endTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">enableTimer</span> <span class="o">&amp;&amp;</span> <span class="n">getProcessTimesAddr</span><span class="p">){</span>
    <span class="n">FILETIME</span> <span class="n">ftCreation</span><span class="p">,</span> <span class="n">ftExit</span><span class="p">,</span> <span class="n">ftKernelEnd</span><span class="p">,</span> <span class="n">ftUserEnd</span><span class="p">;</span>
    <span class="n">getProcessTimesAddr</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftCreation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftExit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftKernelEnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftUserEnd</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;CPU Time: user %f sys %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
       <span class="n">timeDiff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftUserBegin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftUserEnd</span><span class="p">),</span>
       <span class="n">timeDiff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftKernelBegin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftKernelEnd</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define BEGIN_TIMER beginTimer()</span>
<span class="cp">#define END_TIMER endTimer()</span>
<span class="cp">#define HAS_TIMER hasTimer()</span>

<span class="cp">#else</span>
<span class="cp">#define BEGIN_TIMER </span>
<span class="cp">#define END_TIMER</span>
<span class="cp">#define HAS_TIMER 0</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Used to prevent warnings about unused parameters</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#define UNUSED_PARAMETER(x) (void)(x)</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>If the following flag is set, then command execution stops</li>
<li>at an error if we are not interactive.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bail_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Threat stdin as an interactive input if the following variable</li>
<li>is true.  Otherwise, assume stdin is connected to a file or pipe.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="n">stdin_is_interactive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>The following is the open SQLite database.  We make a pointer</li>
<li>to this database a static variable so that it can be accessed</li>
<li>by the SIGINT handler to interrupt database processing.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>True if an interrupt (Control-C) has been received.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">seenInterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This is the name of our program. It is set in main(), used</li>
<li>in a number of other places, mostly for error messages.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Argv0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Prompt strings. Initialized in main. Settable with</li>
<li>.prompt main continue</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="n">mainPrompt</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>     <span class="cm">/* First line prompt. default: &quot;sqlite&gt; &quot;*/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">continuePrompt</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span> <span class="cm">/* Continuation prompt. default: &quot;   ...&gt; &quot; */</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Write I/O traces to the following stream.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#ifdef SQLITE_ENABLE_IOTRACE</span>
<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">iotrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This routine works like printf in that its first argument is a</li>
<li>format string and subsequent arguments are values to be substituted</li>
<li>in place of % fields.  The result of formatting this string</li>
<li>is written to iotrace.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#ifdef SQLITE_ENABLE_IOTRACE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iotracePrintf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFormat</span><span class="p">,</span> <span class="p">...){</span>
  <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">iotrace</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">zFormat</span><span class="p">);</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">sqlite3_vmprintf</span><span class="p">(</span><span class="n">zFormat</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">iotrace</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
  <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Determines if a string is a number of not.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isNumber</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">realnum</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;+&#39;</span> <span class="p">)</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">z</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">realnum</span> <span class="p">)</span> <span class="o">*</span><span class="n">realnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;.&#39;</span> <span class="p">){</span>
    <span class="n">z</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">realnum</span> <span class="p">)</span> <span class="o">*</span><span class="n">realnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;e&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;E&#39;</span> <span class="p">){</span>
    <span class="n">z</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="p">)</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">IsDigit</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">realnum</span> <span class="p">)</span> <span class="o">*</span><span class="n">realnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>A global char* and an SQL function to access its current value </li>
<li>from within an SQL statement. This program used to use the </li>
<li>sqlite_exec_printf() API to substitue a string into an SQL statement.</li>
<li>The correct way to do this with sqlite3 is to use the bind API, but</li>
<li>since the shell is built around the callback paradigm it would be a lot</li>
<li>of work. Instead just use this hack, which is quite harmless.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zShellStatic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellstaticFunc</span><span class="p">(</span>
  <span class="n">sqlite3_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
  <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
  <span class="n">sqlite3_value</span> <span class="o">**</span><span class="n">argv</span>
<span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span> <span class="mi">0</span><span class="o">==</span><span class="n">argc</span> <span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span> <span class="n">zShellStatic</span> <span class="p">);</span>
  <span class="n">UNUSED_PARAMETER</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
  <span class="n">UNUSED_PARAMETER</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
  <span class="n">sqlite3_result_text</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">zShellStatic</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_STATIC</span><span class="p">);</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This routine reads a line of text from FILE in, stores</li>
<li>the text in memory obtained from malloc() and returns a pointer</li>
<li>to the text.  NULL is returned at end of file, or if malloc()</li>
<li>fails.
*</li>
<li>The interface is like "readline" but no command-line editing</li>
<li>is done.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">local_getline</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">zPrompt</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csvFlag</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zLine</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nLine</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">inQuote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">zPrompt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">zPrompt</span> <span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zPrompt</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">nLine</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="n">zLine</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">nLine</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">n</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;</span><span class="n">nLine</span> <span class="p">){</span>
      <span class="n">nLine</span> <span class="o">=</span> <span class="n">nLine</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
      <span class="n">zLine</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">zLine</span><span class="p">,</span> <span class="n">nLine</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">nLine</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">in</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">free</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">)</span> <span class="n">inQuote</span> <span class="o">=</span> <span class="o">!</span><span class="n">inQuote</span><span class="p">;</span>
      <span class="n">n</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">inQuote</span> <span class="o">||</span> <span class="o">!</span><span class="n">csvFlag</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">n</span><span class="o">--</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\r&#39;</span> <span class="p">)</span> <span class="n">n</span><span class="o">--</span><span class="p">;</span>
      <span class="n">zLine</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">zLine</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span> <span class="n">zLine</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">zLine</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Retrieve a single line of input text.
*</li>
<li>zPrior is a string of prior text retrieved.  If not the empty</li>
<li>string, then issue a continuation prompt.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">one_input_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zPrior</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zPrompt</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zResult</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">in</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">return</span> <span class="n">local_getline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zPrior</span> <span class="o">&amp;&amp;</span> <span class="n">zPrior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">){</span>
    <span class="n">zPrompt</span> <span class="o">=</span> <span class="n">continuePrompt</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">zPrompt</span> <span class="o">=</span> <span class="n">mainPrompt</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">zResult</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">zPrompt</span><span class="p">);</span>
<span class="cp">#if defined(HAVE_READLINE) &amp;&amp; HAVE_READLINE==1</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zResult</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">zResult</span> <span class="p">)</span> <span class="n">add_history</span><span class="p">(</span><span class="n">zResult</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="k">return</span> <span class="n">zResult</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">previous_mode_data</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>        <span class="cm">/* Is there legit data in here? */</span>
  <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">showHeader</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">colWidth</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>An pointer to an instance of this structure is passed from</li>
<li>the main program to the callback.  This is used to communicate</li>
<li>state and mode information.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">struct</span> <span class="n">callback_data</span> <span class="p">{</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>           <span class="cm">/* The database */</span>
  <span class="kt">int</span> <span class="n">echoOn</span><span class="p">;</span>            <span class="cm">/* True to echo input commands */</span>
  <span class="kt">int</span> <span class="n">statsOn</span><span class="p">;</span>           <span class="cm">/* True to display memory stats before each finalize */</span>
  <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>               <span class="cm">/* Number of records displayed so far */</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>             <span class="cm">/* Write results here */</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">traceOut</span><span class="p">;</span>        <span class="cm">/* Output for sqlite3_trace() */</span>
  <span class="kt">int</span> <span class="n">nErr</span><span class="p">;</span>              <span class="cm">/* Number of errors seen */</span>
  <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>              <span class="cm">/* An output mode setting */</span>
  <span class="kt">int</span> <span class="n">writableSchema</span><span class="p">;</span>    <span class="cm">/* True if PRAGMA writable_schema=ON */</span>
  <span class="kt">int</span> <span class="n">showHeader</span><span class="p">;</span>        <span class="cm">/* True to show column names in List or Column mode */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zDestTable</span><span class="p">;</span>      <span class="cm">/* Name of destination table when MODE_Insert */</span>
  <span class="kt">char</span> <span class="n">separator</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>    <span class="cm">/* Separator character for MODE_List */</span>
  <span class="kt">int</span> <span class="n">colWidth</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>     <span class="cm">/* Requested width of each column when in column mode*/</span>
  <span class="kt">int</span> <span class="n">actualWidth</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>  <span class="cm">/* Actual width of each column */</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>char nullvalue[20];       The text to print when a NULL comes back from
* the database   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">struct</span> <span class="n">previous_mode_data</span> <span class="n">explainPrev</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Holds the mode information just before
* .explain ON   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kt">char</span> <span class="n">outfile</span><span class="p">[</span><span class="n">FILENAME_MAX</span><span class="p">];</span> <span class="cm">/* Filename for *out */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDbFilename</span><span class="p">;</span>    <span class="cm">/* name of the database file */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zVfs</span><span class="p">;</span>           <span class="cm">/* Name of VFS to use */</span>
  <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pStmt</span><span class="p">;</span>   <span class="cm">/* Current statement if any. */</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">pLog</span><span class="p">;</span>            <span class="cm">/* Write log output here */</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>These are the allowed modes.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#define MODE_Line     0  </span><span class="cm">/* One column per line.  Blank line between records */</span><span class="cp"></span>
<span class="cp">#define MODE_Column   1  </span><span class="cm">/* One record per line in neat columns */</span><span class="cp"></span>
<span class="cp">#define MODE_List     2  </span><span class="cm">/* One record per line with a separator */</span><span class="cp"></span>
<span class="cp">#define MODE_Semi     3  </span><span class="cm">/* Same as MODE_List but append &quot;;&quot; to each line */</span><span class="cp"></span>
<span class="cp">#define MODE_Html     4  </span><span class="cm">/* Generate an XHTML table */</span><span class="cp"></span>
<span class="cp">#define MODE_Insert   5  </span><span class="cm">/* Generate SQL &quot;insert&quot; statements */</span><span class="cp"></span>
<span class="cp">#define MODE_Tcl      6  </span><span class="cm">/* Generate ANSI-C or TCL quoted elements */</span><span class="cp"></span>
<span class="cp">#define MODE_Csv      7  </span><span class="cm">/* Quote strings, numbers are plain */</span><span class="cp"></span>
<span class="cp">#define MODE_Explain  8  </span><span class="cm">/* Like MODE_Column, but do not truncate data */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modeDescr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&quot;line&quot;</span><span class="p">,</span>
  <span class="s">&quot;column&quot;</span><span class="p">,</span>
  <span class="s">&quot;list&quot;</span><span class="p">,</span>
  <span class="s">&quot;semi&quot;</span><span class="p">,</span>
  <span class="s">&quot;html&quot;</span><span class="p">,</span>
  <span class="s">&quot;insert&quot;</span><span class="p">,</span>
  <span class="s">&quot;tcl&quot;</span><span class="p">,</span>
  <span class="s">&quot;csv&quot;</span><span class="p">,</span>
  <span class="s">&quot;explain&quot;</span><span class="p">,</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Number of elements in an array</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#define ArraySize(X)  (int)(sizeof(X)/sizeof(X[0]))</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Compute a string length that is limited to what can be stored in</li>
<li>lower 30 bits of a 32-bit signed integer.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">strlen30</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z2</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="o">*</span><span class="n">z2</span> <span class="p">){</span> <span class="n">z2</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">return</span> <span class="mh">0x3fffffff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>A callback for the sqlite3_log() interface.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellLog</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iErrCode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zMsg</span><span class="p">){</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span><span class="o">*</span><span class="p">)</span><span class="n">pArg</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pLog</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pLog</span><span class="p">,</span> <span class="s">&quot;(%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iErrCode</span><span class="p">,</span> <span class="n">zMsg</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pLog</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Output the given string as a hex-encoded blob (eg. X'1234' )</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_hex_blob</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pBlob</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nBlob</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zBlob</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pBlob</span><span class="p">;</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;X&#39;&quot;</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nBlob</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span><span class="n">zBlob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Output the given string as a quoted string using SQL quoting conventions.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_quoted_string</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nSingle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="p">)</span> <span class="n">nSingle</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">nSingle</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&#39;%s&#39;&quot;</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span> <span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">);</span>
        <span class="n">z</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%.*s&#39;&#39;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Output the given string as a quoted according to C or TCL quoting rules.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_c_string</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">++</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\\&#39;</span> <span class="p">){</span>
      <span class="n">fputc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
      <span class="n">fputc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\t&#39;</span> <span class="p">){</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\n&#39;</span> <span class="p">){</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;n&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\r&#39;</span> <span class="p">){</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
      <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">isprint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">%03o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fputc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Output the given string with characters that are special to</li>
<li>HTML escaped.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_html_string</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span> <span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>   <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
            <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;&lt;&#39;</span> 
            <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;&amp;&#39;</span> 
            <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;&gt;&#39;</span> 
            <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\&quot;&#39;</span> 
            <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">){}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%.*s&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&lt;&#39;</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&amp;lt;&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&amp;&#39;</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&amp;amp;&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&amp;gt;&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&quot;&#39;</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&amp;quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&amp;#39;&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">z</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>If a field contains any character identified by a 1 in the following</li>
<li>array, then the string must be quoted for CSV.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">needCsvQuote</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Output a single term of CSV.  Actually, p->separator is used for</li>
<li>the separator, which may or may not be a comma.  p->nullvalue is</li>
<li>the null value.  Strings are quoted if necessary.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_csv</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bSep</span><span class="p">){</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nSep</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">needCsvQuote</span><span class="p">[((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">z</span><span class="p">)[</span><span class="n">i</span><span class="p">]]</span> 
         <span class="o">||</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> 
             <span class="p">(</span><span class="n">nSep</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span> <span class="n">nSep</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="p">){</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">putc</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">)</span> <span class="n">putc</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
        <span class="n">putc</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">putc</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">bSep</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef SIGINT</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This routine runs when the user presses Ctrl-C</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">NotUsed</span><span class="p">){</span>
  <span class="n">UNUSED_PARAMETER</span><span class="p">(</span><span class="n">NotUsed</span><span class="p">);</span>
  <span class="n">seenInterrupt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">db</span> <span class="p">)</span> <span class="n">sqlite3_interrupt</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This is the callback routine that the shell</li>
<li>invokes for each row of a query result.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">shell_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azCol</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">aiType</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span><span class="o">*</span><span class="p">)</span><span class="n">pArg</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="p">){</span>
    <span class="k">case</span> <span class="n">MODE_Line</span>: <span class="p">{</span>
      <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">len</span><span class="o">&gt;</span><span class="n">w</span> <span class="p">)</span> <span class="n">w</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%*s = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Explain</span>:
    <span class="k">case</span> <span class="n">MODE_Column</span>: <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">)</span> <span class="p">){</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">w</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="p">){</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">w</span><span class="o">&lt;</span><span class="mi">10</span> <span class="p">)</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span> <span class="o">&amp;&amp;</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">n</span> <span class="p">)</span> <span class="n">w</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">)</span> <span class="p">){</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%-*.*s%s&quot;</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="o">==</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">:</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
          <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="kt">int</span> <span class="n">w</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">)</span> <span class="p">){</span>
               <span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
               <span class="n">w</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%-*.*s%s&quot;</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="s">&quot;-----------------------------------&quot;</span>
                   <span class="s">&quot;----------------------------------------------------------&quot;</span><span class="p">,</span>
                    <span class="n">i</span><span class="o">==</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">:</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">w</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">)</span> <span class="p">){</span>
           <span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">actualWidth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
           <span class="n">w</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">MODE_Explain</span> <span class="o">&amp;&amp;</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> 
           <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="n">w</span> <span class="p">){</span>
          <span class="n">w</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%-*.*s%s&quot;</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">,</span>
            <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">,</span> <span class="n">i</span><span class="o">==</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">:</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Semi</span>:
    <span class="k">case</span> <span class="n">MODE_List</span>: <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="o">==</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">;</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">MODE_Semi</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Html</span>: <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;TR&gt;&quot;</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;TH&gt;&quot;</span><span class="p">);</span>
          <span class="n">output_html_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;/TH&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;TR&gt;&quot;</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;TD&gt;&quot;</span><span class="p">);</span>
        <span class="n">output_html_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;/TD&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Tcl</span>: <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="n">output_c_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">output_c_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Csv</span>: <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="n">output_csv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">output_csv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">MODE_Insert</span>: <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;INSERT INTO %s VALUES(&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">zDestTable</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">zSep</span> <span class="o">=</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">aiType</span> <span class="o">&amp;&amp;</span> <span class="n">aiType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">SQLITE_NULL</span><span class="p">)</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%sNULL&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">aiType</span> <span class="o">&amp;&amp;</span> <span class="n">aiType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">SQLITE_TEXT</span> <span class="p">){</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">zSep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">);</span>
          <span class="n">output_quoted_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">aiType</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aiType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">SQLITE_INTEGER</span> <span class="o">||</span> <span class="n">aiType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">SQLITE_FLOAT</span><span class="p">)</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">aiType</span> <span class="o">&amp;&amp;</span> <span class="n">aiType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">SQLITE_BLOB</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pStmt</span> <span class="p">){</span>
          <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pBlob</span> <span class="o">=</span> <span class="n">sqlite3_column_blob</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
          <span class="kt">int</span> <span class="n">nBlob</span> <span class="o">=</span> <span class="n">sqlite3_column_bytes</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">zSep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">);</span>
          <span class="n">output_hex_blob</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">pBlob</span><span class="p">,</span> <span class="n">nBlob</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">isNumber</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">zSep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zSep</span><span class="p">);</span>
          <span class="n">output_quoted_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This is the callback routine that the SQLite library</li>
<li>invokes for each row of a query result.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azCol</span><span class="p">){</span>
  <span class="cm">/* since we don&#39;t have type info, call the shell_callback with a NULL value */</span>
  <span class="k">return</span> <span class="n">shell_callback</span><span class="p">(</span><span class="n">pArg</span><span class="p">,</span> <span class="n">nArg</span><span class="p">,</span> <span class="n">azArg</span><span class="p">,</span> <span class="n">azCol</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Set the destination table field of the callback_data structure to</li>
<li>the name of the table given.  Escape any quote characters in the</li>
<li>table name.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_table_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zName</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">needQuote</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">zDestTable</span> <span class="p">){</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">zDestTable</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">zDestTable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zName</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">needQuote</span> <span class="o">=</span> <span class="o">!</span><span class="n">isalpha</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">zName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">zName</span><span class="o">!=</span><span class="sc">&#39;_&#39;</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">isalnum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;_&#39;</span> <span class="p">){</span>
      <span class="n">needQuote</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="p">)</span> <span class="n">n</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">needQuote</span> <span class="p">)</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">zDestTable</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">needQuote</span> <span class="p">)</span> <span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="p">)</span> <span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">needQuote</span> <span class="p">)</span> <span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">;</span>
  <span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>zIn is either a pointer to a NULL-terminated string in memory obtained
* from malloc(), or a NULL pointer. The string pointed to by zAppend is
* added to zIn, and the result returned in memory obtained from malloc().
* zIn, if it was not NULL, is freed.
*
* If the third argument, quote, is not '\0', then it is used as a 
* quote character for zAppend.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">appendText</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">zIn</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">zAppend</span><span class="p">,</span> <span class="kt">char</span> <span class="n">quote</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nAppend</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zAppend</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">nIn</span> <span class="o">=</span> <span class="p">(</span><span class="n">zIn</span><span class="o">?</span><span class="n">strlen30</span><span class="p">(</span><span class="n">zIn</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">len</span> <span class="o">=</span> <span class="n">nAppend</span><span class="o">+</span><span class="n">nIn</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">quote</span> <span class="p">){</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nAppend</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zAppend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">quote</span> <span class="p">)</span> <span class="n">len</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">zIn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">zIn</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">zIn</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">quote</span> <span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zCsr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zIn</span><span class="p">[</span><span class="n">nIn</span><span class="p">];</span>
    <span class="o">*</span><span class="n">zCsr</span><span class="o">++</span> <span class="o">=</span> <span class="n">quote</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nAppend</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="o">*</span><span class="n">zCsr</span><span class="o">++</span> <span class="o">=</span> <span class="n">zAppend</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zAppend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">quote</span> <span class="p">)</span> <span class="o">*</span><span class="n">zCsr</span><span class="o">++</span> <span class="o">=</span> <span class="n">quote</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">zCsr</span><span class="o">++</span> <span class="o">=</span> <span class="n">quote</span><span class="p">;</span>
    <span class="o">*</span><span class="n">zCsr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span> <span class="p">(</span><span class="n">zCsr</span><span class="o">-</span><span class="n">zIn</span><span class="p">)</span><span class="o">==</span><span class="n">len</span> <span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zIn</span><span class="p">[</span><span class="n">nIn</span><span class="p">],</span> <span class="n">zAppend</span><span class="p">,</span> <span class="n">nAppend</span><span class="p">);</span>
    <span class="n">zIn</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">zIn</span><span class="p">;</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Execute a query statement that will generate SQL output.  Print</li>
<li>the result columns, comma-separated, on a line and then add a</li>
<li>semicolon terminator to the end of that line.
*</li>
<li>If the number of columns is 1 and that column contains text "--"</li>
<li>then write the semicolon on a separate line.  That way, if a </li>
<li>"--" comment occurs at the end of the statement, the comment</li>
<li>won't consume the semicolon terminator.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">run_table_dump_query</span><span class="p">(</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* Query context */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSelect</span><span class="p">,</span>     <span class="cm">/* SELECT statement to extract content */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFirstRow</span>    <span class="cm">/* Print before first row, if not NULL */</span>
<span class="p">){</span>
  <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pSelect</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nResult</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zSelect</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSelect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="o">||</span> <span class="o">!</span><span class="n">pSelect</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/**** ERROR: (%d) %s *****/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">));</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">nErr</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pSelect</span><span class="p">);</span>
  <span class="n">nResult</span> <span class="o">=</span> <span class="n">sqlite3_column_count</span><span class="p">(</span><span class="n">pSelect</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_ROW</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zFirstRow</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">zFirstRow</span><span class="p">);</span>
      <span class="n">zFirstRow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pSelect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nResult</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span> 
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;,%s&quot;</span><span class="p">,</span> <span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pSelect</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>    
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pSelect</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pSelect</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/**** ERROR: (%d) %s *****/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">));</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">nErr</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Allocate space and save off current error string.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">save_err_msg</span><span class="p">(</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span>            <span class="cm">/* Database to query */</span>
<span class="p">){</span>
  <span class="kt">int</span> <span class="n">nErrMsg</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">strlen30</span><span class="p">(</span><span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="n">sqlite3_malloc</span><span class="p">(</span><span class="n">nErrMsg</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span> <span class="p">){</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">),</span> <span class="n">nErrMsg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">zErrMsg</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Display memory stats.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">display_stats</span><span class="p">(</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>                <span class="cm">/* Database to query */</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="cm">/* Pointer to struct callback_data */</span>
  <span class="kt">int</span> <span class="n">bReset</span>                  <span class="cm">/* True to reset the stats */</span>
<span class="p">){</span>
  <span class="kt">int</span> <span class="n">iCur</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iHiwtr</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span> <span class="p">){</span>
    
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_MEMORY_USED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Memory Used:                         %d (max %d) bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_MALLOC_COUNT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Number of Outstanding Allocations:   %d (max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Not currently used by the CLI.</li>
<li>iHiwtr = iCur = -1;</li>
<li>sqlite3_status(SQLITE_STATUS_PAGECACHE_USED, &amp;iCur, &amp;iHiwtr, bReset);</li>
<li>fprintf(pArg->out, "Number of Pcache Pages Used:         %d (max %d) pages\n", iCur, iHiwtr);</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_PAGECACHE_OVERFLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Number of Pcache Overflow Bytes:     %d (max %d) bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Not currently used by the CLI.</li>
<li>iHiwtr = iCur = -1;</li>
<li>sqlite3_status(SQLITE_STATUS_SCRATCH_USED, &amp;iCur, &amp;iHiwtr, bReset);</li>
<li>fprintf(pArg->out, "Number of Scratch Allocations Used:  %d (max %d)\n", iCur, iHiwtr);</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_SCRATCH_OVERFLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Number of Scratch Overflow Bytes:    %d (max %d) bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_MALLOC_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Largest Allocation:                  %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_PAGECACHE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Largest Pcache Allocation:           %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_SCRATCH_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Largest Scratch Allocation:          %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
<span class="cp">#ifdef YYTRACKMAXSTACKDEPTH</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_status</span><span class="p">(</span><span class="n">SQLITE_STATUS_PARSER_STACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Deepest Parser Stack:                %d (max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">db</span> <span class="p">){</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_LOOKASIDE_USED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Lookaside Slots Used:                %d (max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_LOOKASIDE_HIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Successful lookaside attempts:       %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_LOOKASIDE_MISS_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Lookaside failures due to size:      %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_LOOKASIDE_MISS_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Lookaside failures due to OOM:       %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iHiwtr</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_CACHE_USED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Pager Heap Usage:                    %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span>    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_CACHE_HIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Page cache hits:                     %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span>
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_CACHE_MISS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Page cache misses:                   %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span> 
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_CACHE_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Page cache writes:                   %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span> 
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_SCHEMA_USED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Schema Heap Usage:                   %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span> 
    <span class="n">iHiwtr</span> <span class="o">=</span> <span class="n">iCur</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sqlite3_db_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLITE_DBSTATUS_STMT_USED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iHiwtr</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Statement Heap/Lookaside Usage:      %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span> 
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">db</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span> <span class="p">){</span>
    <span class="n">iCur</span> <span class="o">=</span> <span class="n">sqlite3_stmt_status</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">SQLITE_STMTSTATUS_FULLSCAN_STEP</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Fullscan Steps:                      %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span>
    <span class="n">iCur</span> <span class="o">=</span> <span class="n">sqlite3_stmt_status</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">SQLITE_STMTSTATUS_SORT</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Sort Operations:                     %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span>
    <span class="n">iCur</span> <span class="o">=</span> <span class="n">sqlite3_stmt_status</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">SQLITE_STMTSTATUS_AUTOINDEX</span><span class="p">,</span> <span class="n">bReset</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Autoindex Inserts:                   %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iCur</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Execute a statement or set of statements.  Print </li>
<li>any result rows/columns depending on the current mode </li>
<li>set via the supplied callback.
*</li>
<li>This is very similar to SQLite's built-in sqlite3_exec() </li>
<li>function except it takes a slightly different callback </li>
<li>and callback data argument.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">shell_exec</span><span class="p">(</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>                                <span class="cm">/* An open database */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span><span class="p">,</span>                           <span class="cm">/* SQL to be evaluated */</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xCallback</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">,</span><span class="kt">int</span><span class="o">*</span><span class="p">),</span>   <span class="cm">/* Callback function */</span>
                                              <span class="cm">/* (not the same as sqlite3_exec) */</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span>                 <span class="cm">/* Pointer to struct callback_data */</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">pzErrMsg</span>                             <span class="cm">/* Error msg written here */</span>
<span class="p">){</span>
  <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pStmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>     <span class="cm">/* Statement to execute. */</span>
  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>             <span class="cm">/* Return Code */</span>
  <span class="kt">int</span> <span class="n">rc2</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zLeftover</span><span class="p">;</span>          <span class="cm">/* Tail of unprocessed SQL */</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">pzErrMsg</span> <span class="p">){</span>
    <span class="o">*</span><span class="n">pzErrMsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">while</span><span class="p">(</span> <span class="n">zSql</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SQLITE_OK</span> <span class="o">==</span> <span class="n">rc</span><span class="p">)</span> <span class="p">){</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pStmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zLeftover</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">SQLITE_OK</span> <span class="o">!=</span> <span class="n">rc</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pzErrMsg</span> <span class="p">){</span>
        <span class="o">*</span><span class="n">pzErrMsg</span> <span class="o">=</span> <span class="n">save_err_msg</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pStmt</span> <span class="p">){</span>
        <span class="cm">/* this happens for a comment or white-space */</span>
        <span class="n">zSql</span> <span class="o">=</span> <span class="n">zLeftover</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">zSql</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="n">zSql</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* save off the prepared statment handle and reset row count */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="p">){</span>
        <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span> <span class="o">=</span> <span class="n">pStmt</span><span class="p">;</span>
        <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* echo the sql statement if echo on */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">echoOn</span> <span class="p">){</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zStmtSql</span> <span class="o">=</span> <span class="n">sqlite3_sql</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zStmtSql</span> <span class="o">?</span> <span class="n">zStmtSql</span> <span class="o">:</span> <span class="n">zSql</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="cm">/* Output TESTCTRL_EXPLAIN text of requested */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">MODE_Explain</span> <span class="p">){</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zExplain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">SQLITE_TESTCTRL_EXPLAIN_STMT</span><span class="p">,</span> <span class="n">pStmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zExplain</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">zExplain</span> <span class="o">&amp;&amp;</span> <span class="n">zExplain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">pArg</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">zExplain</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>perform the first step.  this will tell us if we
* have a result set or not and how wide it is.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="cm">/* if we have a result set... */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">SQLITE_ROW</span> <span class="o">==</span> <span class="n">rc</span> <span class="p">){</span>
        <span class="cm">/* if we have a callback... */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">xCallback</span> <span class="p">){</span>
          <span class="cm">/* allocate space for col name ptr, value ptr, and type */</span>
          <span class="kt">int</span> <span class="n">nCol</span> <span class="o">=</span> <span class="n">sqlite3_column_count</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
          <span class="kt">void</span> <span class="o">*</span><span class="n">pData</span> <span class="o">=</span> <span class="n">sqlite3_malloc</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nCol</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pData</span> <span class="p">){</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_NOMEM</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="kt">char</span> <span class="o">**</span><span class="n">azCols</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">pData</span><span class="p">;</span>      <span class="cm">/* Names of result columns */</span>
            <span class="kt">char</span> <span class="o">**</span><span class="n">azVals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">azCols</span><span class="p">[</span><span class="n">nCol</span><span class="p">];</span>       <span class="cm">/* Results */</span>
            <span class="kt">int</span> <span class="o">*</span><span class="n">aiTypes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">azVals</span><span class="p">[</span><span class="n">nCol</span><span class="p">];</span> <span class="cm">/* Result types */</span>
            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span> 
            <span class="cm">/* save off ptrs to column names */</span>
            <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCol</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
              <span class="n">azCols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_name</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">do</span><span class="p">{</span>
              <span class="cm">/* extract the data and data types */</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCol</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                <span class="n">azVals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">aiTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqlite3_column_type</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">azVals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aiTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">SQLITE_NULL</span><span class="p">)</span> <span class="p">){</span>
                  <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_NOMEM</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span> <span class="cm">/* from for */</span>
                <span class="p">}</span>
              <span class="p">}</span> <span class="cm">/* end for */</span>

              <span class="cm">/* if data and types extracted successfully... */</span>
              <span class="k">if</span><span class="p">(</span> <span class="n">SQLITE_ROW</span> <span class="o">==</span> <span class="n">rc</span> <span class="p">){</span> 
                <span class="cm">/* call the supplied callback with the result row data */</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">xCallback</span><span class="p">(</span><span class="n">pArg</span><span class="p">,</span> <span class="n">nCol</span><span class="p">,</span> <span class="n">azVals</span><span class="p">,</span> <span class="n">azCols</span><span class="p">,</span> <span class="n">aiTypes</span><span class="p">)</span> <span class="p">){</span>
                  <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">SQLITE_ROW</span> <span class="o">==</span> <span class="n">rc</span> <span class="p">);</span>
            <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">do</span><span class="p">{</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">SQLITE_ROW</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="cm">/* print usage stats if stats on */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="o">&amp;&amp;</span> <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">statsOn</span> <span class="p">){</span>
        <span class="n">display_stats</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">pArg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Finalize the statement just executed. If this fails, save a 
* copy of the error message. Otherwise, set zSql to point to the
* next statement to execute.   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="n">rc2</span> <span class="o">=</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_NOMEM</span> <span class="p">)</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">rc2</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
        <span class="n">zSql</span> <span class="o">=</span> <span class="n">zLeftover</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">zSql</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="n">zSql</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pzErrMsg</span> <span class="p">){</span>
        <span class="o">*</span><span class="n">pzErrMsg</span> <span class="o">=</span> <span class="n">save_err_msg</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="cm">/* clear saved stmt handle */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pArg</span> <span class="p">){</span>
        <span class="n">pArg</span><span class="o">-&gt;</span><span class="n">pStmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="cm">/* end while */</span>

  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>This is a different callback routine used for dumping the database.</li>
<li>Each row received by this callback consists of a table name,</li>
<li>the table type ("index" or "table") and SQL to create the table.</li>
<li>This routine should print text sufficient to recreate the table.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azArg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azCol</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zTable</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zType</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zPrepStmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="p">)</span><span class="n">pArg</span><span class="p">;</span>

  <span class="n">UNUSED_PARAMETER</span><span class="p">(</span><span class="n">azCol</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">!=</span><span class="mi">3</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">zTable</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">zType</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">zSql</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  
  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zTable</span><span class="p">,</span> <span class="s">&quot;sqlite_sequence&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">zPrepStmt</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM sqlite_sequence;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zTable</span><span class="p">,</span> <span class="s">&quot;sqlite_stat1&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;ANALYZE sqlite_master;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">zTable</span><span class="p">,</span> <span class="s">&quot;sqlite_&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">zSql</span><span class="p">,</span> <span class="s">&quot;CREATE VIRTUAL TABLE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zIns</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">writableSchema</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;PRAGMA writable_schema=ON;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">writableSchema</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zIns</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span>
       <span class="s">&quot;INSERT INTO sqlite_master(type,name,tbl_name,rootpage,sql)&quot;</span>
       <span class="s">&quot;VALUES(&#39;table&#39;,&#39;%q&#39;,&#39;%q&#39;,0,&#39;%q&#39;);&quot;</span><span class="p">,</span>
       <span class="n">zTable</span><span class="p">,</span> <span class="n">zTable</span><span class="p">,</span> <span class="n">zSql</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zIns</span><span class="p">);</span>
    <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zIns</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zSql</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zType</span><span class="p">,</span> <span class="s">&quot;table&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pTableInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zTableInfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zTmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nRow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
    <span class="n">zTableInfo</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zTableInfo</span><span class="p">,</span> <span class="s">&quot;PRAGMA table_info(&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">zTableInfo</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zTableInfo</span><span class="p">,</span> <span class="n">zTable</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="n">zTableInfo</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zTableInfo</span><span class="p">,</span> <span class="s">&quot;);&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zTableInfo</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTableInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zTableInfo</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="o">||</span> <span class="o">!</span><span class="n">pTableInfo</span> <span class="p">){</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot;SELECT &#39;INSERT INTO &#39; || &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Always quote the table name, even if it appears to be pure ascii,
* in case it is a keyword. Ex:  INSERT INTO "table" ...   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">zTmp</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zTmp</span><span class="p">,</span> <span class="n">zTable</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zTmp</span> <span class="p">){</span>
      <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="n">zTmp</span><span class="p">,</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">zTmp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot; || &#39; VALUES(&#39; || &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pTableInfo</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_ROW</span> <span class="p">){</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zText</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pTableInfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot;quote(&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="n">zText</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pTableInfo</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_ROW</span> <span class="p">){</span>
        <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot;), &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot;) &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">nRow</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pTableInfo</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="o">||</span> <span class="n">nRow</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">free</span><span class="p">(</span><span class="n">zSelect</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot;|| &#39;)&#39; FROM  &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="n">zTable</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">run_table_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zSelect</span><span class="p">,</span> <span class="n">zPrepStmt</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_CORRUPT</span> <span class="p">){</span>
      <span class="n">zSelect</span> <span class="o">=</span> <span class="n">appendText</span><span class="p">(</span><span class="n">zSelect</span><span class="p">,</span> <span class="s">&quot; ORDER BY rowid DESC&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">run_table_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zSelect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zSelect</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Run zQuery.  Use dump_callback() as the callback routine so that</li>
<li>the contents of the query are output as SQL statements.
*</li>
<li>If we get a SQLITE_CORRUPT error, rerun the query after appending</li>
<li>"ORDER BY rowid DESC" to the end.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">run_schema_dump_query</span><span class="p">(</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> 
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zQuery</span>
<span class="p">){</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zErr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zQuery</span><span class="p">,</span> <span class="n">dump_callback</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErr</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_CORRUPT</span> <span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zQ2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zQuery</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/****** CORRUPTION ERROR *******/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zErr</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/****** %s ******/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErr</span><span class="p">);</span>
      <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErr</span><span class="p">);</span>
      <span class="n">zErr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zQ2</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">len</span><span class="o">+</span><span class="mi">100</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zQ2</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">100</span><span class="p">,</span> <span class="n">zQ2</span><span class="p">,</span> <span class="s">&quot;%s ORDER BY rowid DESC&quot;</span><span class="p">,</span> <span class="n">zQuery</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zQ2</span><span class="p">,</span> <span class="n">dump_callback</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErr</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/****** ERROR: %s ******/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErr</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErr</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zQ2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Text of a help message</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="n">zHelp</span><span class="p">[]</span> <span class="o">=</span>
  <span class="s">&quot;.backup ?DB? FILE      Backup DB (default </span><span class="se">\&quot;</span><span class="s">main</span><span class="se">\&quot;</span><span class="s">) to FILE</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.bail ON|OFF           Stop after hitting an error.  Default OFF</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.databases             List names and files of attached databases</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.dump ?TABLE? ...      Dump the database in an SQL text format</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         If TABLE specified, only dump tables matching</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         LIKE pattern TABLE.</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.echo ON|OFF           Turn command echo on or off</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.exit                  Exit this program</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.explain ?ON|OFF?      Turn output mode suitable for EXPLAIN on or off.</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         With no args, it turns EXPLAIN on.</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.header(s) ON|OFF      Turn display of headers on or off</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.help                  Show this message</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.import FILE TABLE     Import data from FILE into TABLE</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.indices ?TABLE?       Show names of all indices</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         If TABLE specified, only show indices for tables</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         matching LIKE pattern TABLE.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef SQLITE_ENABLE_IOTRACE</span>
  <span class="s">&quot;.iotrace FILE          Enable I/O diagnostic logging to FILE</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef SQLITE_OMIT_LOAD_EXTENSION</span>
  <span class="s">&quot;.load FILE ?ENTRY?     Load an extension library</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
  <span class="s">&quot;.log FILE|off          Turn logging on or off.  FILE can be stderr/stdout</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.mode MODE ?TABLE?     Set output mode where MODE is one of:</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         csv      Comma-separated values</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         column   Left-aligned columns.  (See .width)</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         html     HTML &lt;table&gt; code</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         insert   SQL insert statements for TABLE</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         line     One value per line</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         list     Values delimited by .separator string</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         tabs     Tab-separated values</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         tcl      TCL list elements</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.nullvalue STRING      Print STRING in place of NULL values</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.output FILENAME       Send output to FILENAME</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.output stdout         Send output to the screen</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.prompt MAIN CONTINUE  Replace the standard prompts</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.quit                  Exit this program</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.read FILENAME         Execute SQL in FILENAME</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.restore ?DB? FILE     Restore content of DB (default </span><span class="se">\&quot;</span><span class="s">main</span><span class="se">\&quot;</span><span class="s">) from FILE</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.schema ?TABLE?        Show the CREATE statements</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         If TABLE specified, only show tables matching</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         LIKE pattern TABLE.</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.separator STRING      Change separator used by output mode and .import</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.show                  Show the current values for various settings</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.stats ON|OFF          Turn stats on or off</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.tables ?TABLE?        List names of tables</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         If TABLE specified, only list tables matching</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;                         LIKE pattern TABLE.</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.timeout MS            Try opening locked tables for MS milliseconds</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.trace FILE|off        Output each SQL statement as it is run</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.vfsname ?AUX?         Print the name of the VFS stack</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;.width NUM1 NUM2 ...   Set column widths for </span><span class="se">\&quot;</span><span class="s">column</span><span class="se">\&quot;</span><span class="s"> mode</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">zTimerHelp</span><span class="p">[]</span> <span class="o">=</span>
  <span class="s">&quot;.timer ON|OFF          Turn the CPU timer measurement on or off</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">;</span>

<span class="cm">/* Forward reference */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Make sure the database is open.  If it is not, then open it.  If</li>
<li>the database fails to open, print an error message and exit.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">open_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">zDbFilename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">db</span> <span class="o">&amp;&amp;</span> <span class="n">sqlite3_errcode</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">sqlite3_create_function</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;shellstatic&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SQLITE_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
          <span class="n">shellstaticFunc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">db</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">SQLITE_OK</span><span class="o">!=</span><span class="n">sqlite3_errcode</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: unable to open database </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">zDbFilename</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifndef SQLITE_OMIT_LOAD_EXTENSION</span>
    <span class="n">sqlite3_enable_load_extension</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Do C-language style dequoting.
*</li>
<li>\t    -> tab</li>
<li>\n    -> newline</li>
<li>\r    -> carriage return</li>
<li>\NNN  -> ascii character NNN in octal</li>
<li>\    -> backslash</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resolve_backslashes</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\\&#39;</span> <span class="p">){</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;n&#39;</span> <span class="p">){</span>
        <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="p">){</span>
        <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\t&#39;</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;r&#39;</span> <span class="p">){</span>
        <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">&gt;=</span><span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">&lt;=</span><span class="sc">&#39;7&#39;</span> <span class="p">){</span>
        <span class="n">c</span> <span class="o">-=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="sc">&#39;7&#39;</span> <span class="p">){</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="sc">&#39;7&#39;</span> <span class="p">){</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Interpret zArg as a boolean value.  Return either 0 or 1.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">booleanValue</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">zArg</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">zArg</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">zArg</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="n">zArg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ToLower</span><span class="p">(</span><span class="n">zArg</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zArg</span><span class="p">,</span><span class="s">&quot;on&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zArg</span><span class="p">,</span><span class="s">&quot;yes&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Close an output file, assuming it is not stderr or stdout</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_file_close</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">f</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">!=</span><span class="n">stdout</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">!=</span><span class="n">stderr</span> <span class="p">)</span> <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Try to open an output file.   The names "stdout" and "stderr" are</li>
<li>recognized and do the right thing.  NULL is returned if the output </li>
<li>filename is "off".</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="nf">output_file_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFile</span><span class="p">){</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zFile</span><span class="p">,</span><span class="s">&quot;stdout&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zFile</span><span class="p">,</span> <span class="s">&quot;stderr&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">stderr</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zFile</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">zFile</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">f</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zFile</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>A routine for handling output from sqlite3_trace().</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sql_trace_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pArg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">FILE</span><span class="o">*</span><span class="p">)</span><span class="n">pArg</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>A no-op routine that runs with the ".breakpoint" doc-command.  This is</li>
<li>a useful spot to set a debugger breakpoint.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_breakpoint</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">nCall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">nCall</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>If an input line begins with "." then invoke this routine to</li>
<li>process that line.
*</li>
<li>Return 1 on error, 2 to exit, and 0 otherwise.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_meta_command</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">zLine</span><span class="p">,</span> <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nArg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">azArg</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Parse the input line into tokens.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">while</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">azArg</span><span class="p">)</span> <span class="p">){</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">){</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">){</span>
      <span class="kt">int</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
      <span class="n">azArg</span><span class="p">[</span><span class="n">nArg</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">while</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">delim</span> <span class="p">){</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">delim</span> <span class="p">){</span>
        <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">delim</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">)</span> <span class="n">resolve_backslashes</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">azArg</span><span class="p">[</span><span class="n">nArg</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">while</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IsSpace</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">){</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">resolve_backslashes</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">nArg</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Process the input line.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no tokens, no error */</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;b&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;backup&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">){</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDestFile</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDb</span><span class="p">;</span>
    <span class="n">sqlite3</span> <span class="o">*</span><span class="n">pDest</span><span class="p">;</span>
    <span class="n">sqlite3_backup</span> <span class="o">*</span><span class="n">pBackup</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
      <span class="n">zDestFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">zDb</span> <span class="o">=</span> <span class="s">&quot;main&quot;</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">zDestFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">zDb</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">zDestFile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pDest</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zDestFile</span><span class="p">);</span>
      <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pDest</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">pBackup</span> <span class="o">=</span> <span class="n">sqlite3_backup_init</span><span class="p">(</span><span class="n">pDest</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zDb</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pBackup</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">pDest</span><span class="p">));</span>
      <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pDest</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span>  <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_backup_step</span><span class="p">(</span><span class="n">pBackup</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){}</span>
    <span class="n">sqlite3_backup_finish</span><span class="p">(</span><span class="n">pBackup</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_DONE</span> <span class="p">){</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">pDest</span><span class="p">));</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pDest</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;b&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;bail&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">bail_on_error</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>The undocumented ".breakpoint" command causes a call to the no-op
* routine named test_breakpoint().</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;b&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;breakpoint&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">test_breakpoint</span><span class="p">();</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;d&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;databases&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
    <span class="k">struct</span> <span class="n">callback_data</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="n">data</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Column</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">58</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;PRAGMA database_list; &quot;</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;d&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;dump&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>When playing back a "dump", the content might appear in an order
* which causes immediate foreign key constraints to be violated.
* So disable foreign-key constraint enforcement to prevent problems.   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;PRAGMA foreign_keys=OFF;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;BEGIN TRANSACTION;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">writableSchema</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;SAVEPOINT dump; PRAGMA writable_schema=ON&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">nErr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
      <span class="n">run_schema_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> 
        <span class="s">&quot;SELECT name, type, sql FROM sqlite_master &quot;</span>
        <span class="s">&quot;WHERE sql NOT NULL AND type==&#39;table&#39; AND name!=&#39;sqlite_sequence&#39;&quot;</span>
      <span class="p">);</span>
      <span class="n">run_schema_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> 
        <span class="s">&quot;SELECT name, type, sql FROM sqlite_master &quot;</span>
        <span class="s">&quot;WHERE name==&#39;sqlite_sequence&#39;&quot;</span>
      <span class="p">);</span>
      <span class="n">run_table_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
        <span class="s">&quot;SELECT sql FROM sqlite_master &quot;</span>
        <span class="s">&quot;WHERE sql NOT NULL AND type IN (&#39;index&#39;,&#39;trigger&#39;,&#39;view&#39;)&quot;</span><span class="p">,</span> <span class="mi">0</span>
      <span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nArg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">zShellStatic</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">run_schema_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
          <span class="s">&quot;SELECT name, type, sql FROM sqlite_master &quot;</span>
          <span class="s">&quot;WHERE tbl_name LIKE shellstatic() AND type==&#39;table&#39;&quot;</span>
          <span class="s">&quot;  AND sql NOT NULL&quot;</span><span class="p">);</span>
        <span class="n">run_table_dump_query</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
          <span class="s">&quot;SELECT sql FROM sqlite_master &quot;</span>
          <span class="s">&quot;WHERE sql NOT NULL&quot;</span>
          <span class="s">&quot;  AND type IN (&#39;index&#39;,&#39;trigger&#39;,&#39;view&#39;)&quot;</span>
          <span class="s">&quot;  AND tbl_name LIKE shellstatic()&quot;</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">);</span>
        <span class="n">zShellStatic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">writableSchema</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;PRAGMA writable_schema=OFF;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">writableSchema</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;PRAGMA writable_schema=OFF;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;RELEASE dump;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nErr</span> <span class="o">?</span> <span class="s">&quot;ROLLBACK; -- due to errors</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;COMMIT;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;e&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;echo&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">echoOn</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;e&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;exit&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>  <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;e&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;explain&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nArg</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="o">?</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">colWidth</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">));</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>We could put this code under the !p->explainValid
* condition so that it does not execute if we are already in
* explain mode. However, always executing it allows us an easy
* was to reset to explain mode in case the user previously
* did an .explain followed by a .width, .mode or .header
* command.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Explain</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">));</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                  <span class="cm">/* addr */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>                 <span class="cm">/* opcode */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                  <span class="cm">/* P1 */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                  <span class="cm">/* P2 */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                  <span class="cm">/* P3 */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>                 <span class="cm">/* P4 */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>                  <span class="cm">/* P5 */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>                  <span class="cm">/* Comment */</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">showHeader</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">colWidth</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;header&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span>
                 <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;headers&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zHelp</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">HAS_TIMER</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">zTimerHelp</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;i&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;import&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zTable</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>    <span class="cm">/* Insert data into this table */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>     <span class="cm">/* The file from which to extract data */</span>
    <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pStmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* A statement */</span>
    <span class="kt">int</span> <span class="n">nCol</span><span class="p">;</span>                   <span class="cm">/* Number of columns in the table */</span>
    <span class="kt">int</span> <span class="n">nByte</span><span class="p">;</span>                  <span class="cm">/* Number of bytes in an SQL string */</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>                   <span class="cm">/* Loop counters */</span>
    <span class="kt">int</span> <span class="n">nSep</span><span class="p">;</span>                   <span class="cm">/* Number of bytes in p-&gt;separator[] */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span><span class="p">;</span>                 <span class="cm">/* An SQL statement */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zLine</span><span class="p">;</span>                <span class="cm">/* A single line of input from the file */</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">azCol</span><span class="p">;</span>               <span class="cm">/* zLine[] broken up into columns */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zCommit</span><span class="p">;</span>              <span class="cm">/* How to commit changes */</span>   
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>                   <span class="cm">/* The input file */</span>
    <span class="kt">int</span> <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>             <span class="cm">/* Line number of input file */</span>

    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">nSep</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nSep</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: non-null separator required for import</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zSql</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span><span class="s">&quot;SELECT * FROM %s&quot;</span><span class="p">,</span> <span class="n">zTable</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nByte</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pStmt</span><span class="p">)</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nCol</span> <span class="o">=</span> <span class="n">sqlite3_column_count</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
    <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
    <span class="n">pStmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nCol</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no columns, no error */</span>
    <span class="n">zSql</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">nByte</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">nCol</span><span class="o">*</span><span class="mi">2</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="n">nByte</span><span class="o">+</span><span class="mi">20</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="s">&quot;INSERT INTO %s VALUES(?&quot;</span><span class="p">,</span> <span class="n">zTable</span><span class="p">);</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCol</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="n">zSql</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
      <span class="n">zSql</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zSql</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;)&#39;</span><span class="p">;</span>
    <span class="n">zSql</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pStmt</span><span class="p">)</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">in</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">zFile</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">in</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zFile</span><span class="p">);</span>
      <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">azCol</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">azCol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">nCol</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">azCol</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">fclose</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
      <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;BEGIN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">zCommit</span> <span class="o">=</span> <span class="s">&quot;COMMIT&quot;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">zLine</span> <span class="o">=</span> <span class="n">local_getline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">inQuote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">lineno</span><span class="o">++</span><span class="p">;</span>
      <span class="n">azCol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zLine</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">zLine</span><span class="p">;</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">)</span> <span class="n">inQuote</span> <span class="o">=</span> <span class="o">!</span><span class="n">inQuote</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;\n&#39;</span> <span class="p">)</span> <span class="n">lineno</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">inQuote</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">==</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span><span class="n">nSep</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
          <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCol</span> <span class="p">){</span>
            <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="n">nSep</span><span class="p">];</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="n">nSep</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="cm">/* end for */</span>
      <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">!=</span><span class="n">nCol</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
                <span class="s">&quot;Error: %s line %d: expected %d columns of data but found %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">zFile</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">nCol</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">zCommit</span> <span class="o">=</span> <span class="s">&quot;ROLLBACK&quot;</span><span class="p">;</span>
        <span class="n">free</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span> <span class="cm">/* from while */</span>
      <span class="p">}</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCol</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">){</span>
          <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
          <span class="k">for</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;&quot;&#39;</span> <span class="p">){</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span> <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
            <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">azCol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_STATIC</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_reset</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
        <span class="n">zCommit</span> <span class="o">=</span> <span class="s">&quot;ROLLBACK&quot;</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span> <span class="cm">/* from while */</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="cm">/* end while */</span>
    <span class="n">free</span><span class="p">(</span><span class="n">azCol</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
    <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
    <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zCommit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;i&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;indices&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="k">struct</span> <span class="n">callback_data</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="n">data</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_List</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
        <span class="s">&quot;SELECT name FROM sqlite_master &quot;</span>
        <span class="s">&quot;WHERE type=&#39;index&#39; AND name NOT LIKE &#39;sqlite_%&#39; &quot;</span>
        <span class="s">&quot;UNION ALL &quot;</span>
        <span class="s">&quot;SELECT name FROM sqlite_temp_master &quot;</span>
        <span class="s">&quot;WHERE type=&#39;index&#39; &quot;</span>
        <span class="s">&quot;ORDER BY 1&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span>
      <span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">zShellStatic</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
        <span class="s">&quot;SELECT name FROM sqlite_master &quot;</span>
        <span class="s">&quot;WHERE type=&#39;index&#39; AND tbl_name LIKE shellstatic() &quot;</span>
        <span class="s">&quot;UNION ALL &quot;</span>
        <span class="s">&quot;SELECT name FROM sqlite_temp_master &quot;</span>
        <span class="s">&quot;WHERE type=&#39;index&#39; AND tbl_name LIKE shellstatic() &quot;</span>
        <span class="s">&quot;ORDER BY 1&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span>
      <span class="p">);</span>
      <span class="n">zShellStatic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: querying sqlite_master and sqlite_temp_master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

<span class="cp">#ifdef SQLITE_ENABLE_IOTRACE</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;i&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;iotrace&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">extern</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">sqlite3IoTrace</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">iotrace</span> <span class="o">&amp;&amp;</span> <span class="n">iotrace</span><span class="o">!=</span><span class="n">stdout</span> <span class="p">)</span> <span class="n">fclose</span><span class="p">(</span><span class="n">iotrace</span><span class="p">);</span>
    <span class="n">iotrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">){</span>
      <span class="n">sqlite3IoTrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">sqlite3IoTrace</span> <span class="o">=</span> <span class="n">iotracePrintf</span><span class="p">;</span>
      <span class="n">iotrace</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">iotrace</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">iotrace</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">sqlite3IoTrace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">sqlite3IoTrace</span> <span class="o">=</span> <span class="n">iotracePrintf</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef SQLITE_OMIT_LOAD_EXTENSION</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;l&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="p">){</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFile</span><span class="p">,</span> <span class="o">*</span><span class="n">zProc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">zFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">zProc</span> <span class="o">=</span> <span class="n">nArg</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_load_extension</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zFile</span><span class="p">,</span> <span class="n">zProc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>
<span class="cp">#endif</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;l&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;log&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="p">){</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">output_file_close</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pLog</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">pLog</span> <span class="o">=</span> <span class="n">output_file_open</span><span class="p">(</span><span class="n">zFile</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;m&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">n2</span><span class="o">==</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;line&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">||</span>
        <span class="p">(</span><span class="n">n2</span><span class="o">==</span><span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;lines&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Line</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">n2</span><span class="o">==</span><span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;column&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
              <span class="o">||</span>
              <span class="p">(</span><span class="n">n2</span><span class="o">==</span><span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;columns&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Column</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;list&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_List</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;html&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Html</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;tcl&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Tcl</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;csv&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Csv</span><span class="p">;</span>
      <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;tabs&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_List</span><span class="p">;</span>
      <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;insert&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Insert</span><span class="p">;</span>
      <span class="n">set_table_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;table&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: mode should be one of: &quot;</span>
         <span class="s">&quot;column csv html insert line list tabs tcl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;m&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">n2</span><span class="o">==</span><span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;insert&quot;</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Insert</span><span class="p">;</span>
      <span class="n">set_table_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: invalid arguments: &quot;</span>
        <span class="s">&quot; </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">. Enter </span><span class="se">\&quot;</span><span class="s">.help</span><span class="se">\&quot;</span><span class="s"> for help</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;nullvalue&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">,</span>
                     <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;o&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;|&#39;</span> <span class="p">){</span>
      <span class="n">pclose</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">output_file_close</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;|&#39;</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: cannot open pipe </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">output_file_open</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;off&quot;</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: cannot write to </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;p&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;prompt&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="o">||</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span><span class="p">)){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strncpy</span><span class="p">(</span><span class="n">mainPrompt</span><span class="p">,</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="kt">int</span><span class="p">)</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">mainPrompt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strncpy</span><span class="p">(</span><span class="n">continuePrompt</span><span class="p">,</span><span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">],(</span><span class="kt">int</span><span class="p">)</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">continuePrompt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;q&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;quit&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;r&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">alt</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">alt</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
      <span class="n">fclose</span><span class="p">(</span><span class="n">alt</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;r&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;restore&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">){</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSrcFile</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDb</span><span class="p">;</span>
    <span class="n">sqlite3</span> <span class="o">*</span><span class="n">pSrc</span><span class="p">;</span>
    <span class="n">sqlite3_backup</span> <span class="o">*</span><span class="n">pBackup</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nTimeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
      <span class="n">zSrcFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">zDb</span> <span class="o">=</span> <span class="s">&quot;main&quot;</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">zSrcFile</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">zDb</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">zSrcFile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSrc</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: cannot open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zSrcFile</span><span class="p">);</span>
      <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pSrc</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">pBackup</span> <span class="o">=</span> <span class="n">sqlite3_backup_init</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zDb</span><span class="p">,</span> <span class="n">pSrc</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pBackup</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">));</span>
      <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pSrc</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_backup_step</span><span class="p">(</span><span class="n">pBackup</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span><span class="o">==</span><span class="n">SQLITE_OK</span>
          <span class="o">||</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_BUSY</span>  <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_BUSY</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">nTimeout</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">sqlite3_sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sqlite3_backup_finish</span><span class="p">(</span><span class="n">pBackup</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_DONE</span> <span class="p">){</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_BUSY</span> <span class="o">||</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_LOCKED</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: source database is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">));</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">pSrc</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;schema&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="k">struct</span> <span class="n">callback_data</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="n">data</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Semi</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">){</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ToLower</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;sqlite_master&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">new_argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">new_colv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">new_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CREATE TABLE sqlite_master (</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  type text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  name text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  tbl_name text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  rootpage integer,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  sql text</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;)&quot;</span><span class="p">;</span>
        <span class="n">new_argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">new_colv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;sql&quot;</span><span class="p">;</span>
        <span class="n">new_colv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_argv</span><span class="p">,</span> <span class="n">new_colv</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;sqlite_temp_master&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">new_argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">new_colv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">new_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CREATE TEMP TABLE sqlite_temp_master (</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  type text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  name text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  tbl_name text,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  rootpage integer,</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;  sql text</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="s">&quot;)&quot;</span><span class="p">;</span>
        <span class="n">new_argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">new_colv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;sql&quot;</span><span class="p">;</span>
        <span class="n">new_colv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_argv</span><span class="p">,</span> <span class="n">new_colv</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">zShellStatic</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
          <span class="s">&quot;SELECT sql FROM &quot;</span>
          <span class="s">&quot;  (SELECT sql sql, type type, tbl_name tbl_name, name name, rowid x&quot;</span>
          <span class="s">&quot;     FROM sqlite_master UNION ALL&quot;</span>
          <span class="s">&quot;   SELECT sql, type, tbl_name, name, rowid FROM sqlite_temp_master) &quot;</span>
          <span class="s">&quot;WHERE lower(tbl_name) LIKE shellstatic()&quot;</span>
          <span class="s">&quot;  AND type!=&#39;meta&#39; AND sql NOTNULL &quot;</span>
          <span class="s">&quot;ORDER BY substr(type,2,1), &quot;</span>
                  <span class="s">&quot; CASE type WHEN &#39;view&#39; THEN rowid ELSE name END&quot;</span><span class="p">,</span>
          <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
        <span class="n">zShellStatic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
         <span class="s">&quot;SELECT sql FROM &quot;</span>
         <span class="s">&quot;  (SELECT sql sql, type type, tbl_name tbl_name, name name, rowid x&quot;</span>
         <span class="s">&quot;     FROM sqlite_master UNION ALL&quot;</span>
         <span class="s">&quot;   SELECT sql, type, tbl_name, name, rowid FROM sqlite_temp_master) &quot;</span>
         <span class="s">&quot;WHERE type!=&#39;meta&#39; AND sql NOTNULL AND name NOT LIKE &#39;sqlite_%&#39;&quot;</span>
         <span class="s">&quot;ORDER BY substr(type,2,1),&quot;</span>
                  <span class="s">&quot; CASE type WHEN &#39;view&#39; THEN rowid ELSE name END&quot;</span><span class="p">,</span>
         <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: querying schema information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;separator&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
    <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span>
                     <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;show&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">1</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;echo&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">echoOn</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;explain&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">explainPrev</span><span class="p">.</span><span class="n">valid</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span><span class="s">&quot;off&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;headers&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">modeDescr</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: &quot;</span><span class="p">,</span> <span class="s">&quot;nullvalue&quot;</span><span class="p">);</span>
      <span class="n">output_c_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nullvalue</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;output&quot;</span><span class="p">,</span>
            <span class="n">strlen30</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span><span class="p">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">outfile</span> <span class="o">:</span> <span class="s">&quot;stdout&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: &quot;</span><span class="p">,</span> <span class="s">&quot;separator&quot;</span><span class="p">);</span>
      <span class="n">output_c_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;stats&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">statsOn</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%9.9s: &quot;</span><span class="p">,</span><span class="s">&quot;width&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;%d &quot;</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;stats&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">statsOn</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;tables&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&lt;</span><span class="mi">3</span> <span class="p">){</span>
    <span class="n">sqlite3_stmt</span> <span class="o">*</span><span class="n">pStmt</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">azResult</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nRow</span><span class="p">,</span> <span class="n">nAlloc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="s">&quot;PRAGMA database_list&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">zSql</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span>
        <span class="s">&quot;SELECT name FROM sqlite_master&quot;</span>
        <span class="s">&quot; WHERE type IN (&#39;table&#39;,&#39;view&#39;)&quot;</span>
        <span class="s">&quot;   AND name NOT LIKE &#39;sqlite_%%&#39;&quot;</span>
        <span class="s">&quot;   AND name LIKE ?1&quot;</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">)</span><span class="o">==</span><span class="n">SQLITE_ROW</span> <span class="p">){</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDbName</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zDbName</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zDbName</span><span class="p">,</span><span class="s">&quot;main&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">zDbName</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">zSql</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span>
                 <span class="s">&quot;%z UNION ALL &quot;</span>
                 <span class="s">&quot;SELECT &#39;temp.&#39; || name FROM sqlite_temp_master&quot;</span>
                 <span class="s">&quot; WHERE type IN (&#39;table&#39;,&#39;view&#39;)&quot;</span>
                 <span class="s">&quot;   AND name NOT LIKE &#39;sqlite_%%&#39;&quot;</span>
                 <span class="s">&quot;   AND name LIKE ?1&quot;</span><span class="p">,</span> <span class="n">zSql</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">zSql</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span>
                 <span class="s">&quot;%z UNION ALL &quot;</span>
                 <span class="s">&quot;SELECT &#39;%q.&#39; || name FROM </span><span class="se">\&quot;</span><span class="s">%w</span><span class="se">\&quot;</span><span class="s">.sqlite_master&quot;</span>
                 <span class="s">&quot; WHERE type IN (&#39;table&#39;,&#39;view&#39;)&quot;</span>
                 <span class="s">&quot;   AND name NOT LIKE &#39;sqlite_%%&#39;&quot;</span>
                 <span class="s">&quot;   AND name LIKE ?1&quot;</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="n">zDbName</span><span class="p">,</span> <span class="n">zDbName</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>
    <span class="n">zSql</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span><span class="s">&quot;%z ORDER BY 1&quot;</span><span class="p">,</span> <span class="n">zSql</span><span class="p">);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">nRow</span> <span class="o">=</span> <span class="n">nAlloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">azResult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">){</span>
      <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_STATIC</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">pStmt</span><span class="p">)</span><span class="o">==</span><span class="n">SQLITE_ROW</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">nRow</span><span class="o">&gt;=</span><span class="n">nAlloc</span> <span class="p">){</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">azNew</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nAlloc</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">azNew</span> <span class="o">=</span> <span class="n">sqlite3_realloc</span><span class="p">(</span><span class="n">azResult</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">azResult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">n</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">azNew</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nAlloc</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">azResult</span> <span class="o">=</span> <span class="n">azNew</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">azResult</span><span class="p">[</span><span class="n">nRow</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">pStmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">azResult</span><span class="p">[</span><span class="n">nRow</span><span class="p">]</span> <span class="p">)</span> <span class="n">nRow</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">pStmt</span><span class="p">);</span>        
    <span class="k">if</span><span class="p">(</span> <span class="n">nRow</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
      <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">nPrintCol</span><span class="p">,</span> <span class="n">nPrintRow</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nRow</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azResult</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">len</span><span class="o">&gt;</span><span class="n">maxlen</span> <span class="p">)</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">nPrintCol</span> <span class="o">=</span> <span class="mi">80</span><span class="o">/</span><span class="p">(</span><span class="n">maxlen</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">nPrintCol</span><span class="o">&lt;</span><span class="mi">1</span> <span class="p">)</span> <span class="n">nPrintCol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">nPrintRow</span> <span class="o">=</span> <span class="p">(</span><span class="n">nRow</span> <span class="o">+</span> <span class="n">nPrintCol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nPrintCol</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nPrintRow</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nRow</span><span class="p">;</span> <span class="n">j</span><span class="o">+=</span><span class="n">nPrintRow</span><span class="p">){</span>
          <span class="kt">char</span> <span class="o">*</span><span class="n">zSp</span> <span class="o">=</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nPrintRow</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;  &quot;</span><span class="p">;</span>
          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s%-*s&quot;</span><span class="p">,</span> <span class="n">zSp</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">azResult</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">?</span> <span class="n">azResult</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">nRow</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">azResult</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
    <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">azResult</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;testctrl&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="p">){</span>
    <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zCtrlName</span><span class="p">;</span>   <span class="cm">/* Name of a test-control option */</span>
       <span class="kt">int</span> <span class="n">ctrlCode</span><span class="p">;</span>            <span class="cm">/* Integer code for that option */</span>
    <span class="p">}</span> <span class="n">aCtrl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">{</span> <span class="s">&quot;prng_save&quot;</span><span class="p">,</span>             <span class="n">SQLITE_TESTCTRL_PRNG_SAVE</span>              <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;prng_restore&quot;</span><span class="p">,</span>          <span class="n">SQLITE_TESTCTRL_PRNG_RESTORE</span>           <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;prng_reset&quot;</span><span class="p">,</span>            <span class="n">SQLITE_TESTCTRL_PRNG_RESET</span>             <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;bitvec_test&quot;</span><span class="p">,</span>           <span class="n">SQLITE_TESTCTRL_BITVEC_TEST</span>            <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;fault_install&quot;</span><span class="p">,</span>         <span class="n">SQLITE_TESTCTRL_FAULT_INSTALL</span>          <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;benign_malloc_hooks&quot;</span><span class="p">,</span>   <span class="n">SQLITE_TESTCTRL_BENIGN_MALLOC_HOOKS</span>    <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;pending_byte&quot;</span><span class="p">,</span>          <span class="n">SQLITE_TESTCTRL_PENDING_BYTE</span>           <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;assert&quot;</span><span class="p">,</span>                <span class="n">SQLITE_TESTCTRL_ASSERT</span>                 <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;always&quot;</span><span class="p">,</span>                <span class="n">SQLITE_TESTCTRL_ALWAYS</span>                 <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;reserve&quot;</span><span class="p">,</span>               <span class="n">SQLITE_TESTCTRL_RESERVE</span>                <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;optimizations&quot;</span><span class="p">,</span>         <span class="n">SQLITE_TESTCTRL_OPTIMIZATIONS</span>          <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;iskeyword&quot;</span><span class="p">,</span>             <span class="n">SQLITE_TESTCTRL_ISKEYWORD</span>              <span class="p">},</span>
      <span class="p">{</span> <span class="s">&quot;scratchmalloc&quot;</span><span class="p">,</span>         <span class="n">SQLITE_TESTCTRL_SCRATCHMALLOC</span>          <span class="p">},</span>
    <span class="p">};</span>
    <span class="kt">int</span> <span class="n">testctrl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>convert testctrl text option to value. allow any unique prefix
* of the option name, or a numerical value.   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">n</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aCtrl</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aCtrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">aCtrl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zCtrlName</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">testctrl</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">testctrl</span> <span class="o">=</span> <span class="n">aCtrl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrlCode</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ambiguous option name: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="n">testctrl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">testctrl</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="n">testctrl</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">testctrl</span><span class="o">&lt;</span><span class="n">SQLITE_TESTCTRL_FIRST</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">testctrl</span><span class="o">&gt;</span><span class="n">SQLITE_TESTCTRL_LAST</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: invalid testctrl option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">testctrl</span><span class="p">){</span>

        <span class="cm">/* sqlite3_test_control(int, db, int) */</span>
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_OPTIMIZATIONS</span>:
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_RESERVE</span>:             
          <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
            <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strtol</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>        
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">testctrl</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: testctrl %s takes a single int option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="cm">/* sqlite3_test_control(int) */</span>
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_PRNG_SAVE</span>:           
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_PRNG_RESTORE</span>:        
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_PRNG_RESET</span>:
          <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">testctrl</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: testctrl %s takes no options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="cm">/* sqlite3_test_control(int, uint) */</span>
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_PENDING_BYTE</span>:        
          <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">atoi</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>        
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">testctrl</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: testctrl %s takes a single unsigned&quot;</span>
                           <span class="s">&quot; int option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
          
        <span class="cm">/* sqlite3_test_control(int, int) */</span>
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_ASSERT</span>:              
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_ALWAYS</span>:              
          <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
            <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>        
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">testctrl</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: testctrl %s takes a single int option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="cm">/* sqlite3_test_control(int, char *) */</span>
<span class="cp">#ifdef SQLITE_N_KEYWORD</span>
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_ISKEYWORD</span>:           
          <span class="k">if</span><span class="p">(</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">3</span> <span class="p">){</span>
            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>        
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_test_control</span><span class="p">(</span><span class="n">testctrl</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: testctrl %s takes a single char * option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_BITVEC_TEST</span>:         
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_FAULT_INSTALL</span>:       
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_BENIGN_MALLOC_HOOKS</span>: 
        <span class="k">case</span> <span class="n">SQLITE_TESTCTRL_SCRATCHMALLOC</span>:       
        <span class="k">default</span><span class="o">:</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: CLI support for testctrl %s not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;timeout&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">sqlite3_busy_timeout</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
  <span class="p">}</span><span class="k">else</span>
    
  <span class="k">if</span><span class="p">(</span> <span class="n">HAS_TIMER</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;timer&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
   <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span>
  <span class="p">){</span>
    <span class="n">enableTimer</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span><span class="k">else</span>
  
  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;trace&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">){</span>
    <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">output_file_close</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">traceOut</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">traceOut</span> <span class="o">=</span> <span class="n">output_file_open</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#ifndef SQLITE_OMIT_TRACE</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">traceOut</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">sqlite3_trace</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">sqlite3_trace</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">sql_trace_callback</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">traceOut</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;v&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SQLite %s %s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/*extra-version-info*/</span><span class="p">,</span>
        <span class="n">sqlite3_libversion</span><span class="p">(),</span> <span class="n">sqlite3_sourceid</span><span class="p">());</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;v&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;vfsname&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zDbName</span> <span class="o">=</span> <span class="n">nArg</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;main&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zVfsName</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span> <span class="p">){</span>
      <span class="n">sqlite3_file_control</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zDbName</span><span class="p">,</span> <span class="n">SQLITE_FCNTL_VFSNAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zVfsName</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zVfsName</span> <span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zVfsName</span><span class="p">);</span>
        <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zVfsName</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;w&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nArg</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span> <span class="n">nArg</span><span class="o">&lt;=</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">azArg</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nArg</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">ArraySize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">colWidth</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">azArg</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span>

  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: unknown command or invalid arguments: &quot;</span>
      <span class="s">&quot; </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">. Enter </span><span class="se">\&quot;</span><span class="s">.help</span><span class="se">\&quot;</span><span class="s"> for help</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">azArg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Return TRUE if a semicolon occurs anywhere in the first N characters</li>
<li>of string z[].</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_contains_semicolon</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>  <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;;&#39;</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Test to see if a line consists entirely of whitespace.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_all_whitespace</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">){</span>
  <span class="k">for</span><span class="p">(;</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;*&#39;</span> <span class="p">){</span>
      <span class="n">z</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="o">!=</span><span class="sc">&#39;*&#39;</span> <span class="o">||</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">z</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="p">){</span>
      <span class="n">z</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">z</span><span class="o">!=</span><span class="sc">&#39;\n&#39;</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">z</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Return TRUE if the line typed in is an SQL command terminator other</li>
<li>than a semi-colon.  The SQL Server style "go" command is understood</li>
<li>as is the Oracle "/".</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_is_command_terminator</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zLine</span><span class="p">){</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">){</span> <span class="n">zLine</span><span class="o">++</span><span class="p">;</span> <span class="p">};</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">_all_whitespace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zLine</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Oracle */</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">ToLower</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="sc">&#39;g&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ToLower</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="sc">&#39;o&#39;</span>
         <span class="o">&amp;&amp;</span> <span class="n">_all_whitespace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zLine</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">){</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* SQL Server */</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Return true if zSql is a complete SQL statement.  Return false if it</li>
<li>ends in the middle of a string literal or C-style comment.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_is_complete</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nSql</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">zSql</span><span class="p">[</span><span class="n">nSql</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>
  <span class="n">zSql</span><span class="p">[</span><span class="n">nSql</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_complete</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
  <span class="n">zSql</span><span class="p">[</span><span class="n">nSql</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Read input from *in and process it.  If *in==0 then input</li>
<li>is interactive - the user is typing it it.  Otherwise, input</li>
<li>is coming from a file or device.  A prompt is issued and history</li>
<li>is saved only if input is interactive.  An interrupt signal will</li>
<li>cause this routine to exit immediately, unless input is interactive.
*</li>
<li>Return the number of errors.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zLine</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nSql</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nSqlPrior</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">errCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">startline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span> <span class="n">errCnt</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">bail_on_error</span> <span class="o">||</span> <span class="p">(</span><span class="n">in</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">stdin_is_interactive</span><span class="p">)</span> <span class="p">){</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
    <span class="n">zLine</span> <span class="o">=</span> <span class="n">one_input_line</span><span class="p">(</span><span class="n">zSql</span><span class="p">,</span> <span class="n">in</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="cm">/* End of input */</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">stdin_is_interactive</span> <span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">seenInterrupt</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">in</span><span class="o">!=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">seenInterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">lineno</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">zSql</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_all_whitespace</span><span class="p">(</span><span class="n">zLine</span><span class="p">)</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span> <span class="o">&amp;&amp;</span> <span class="n">zLine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">nSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">echoOn</span> <span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zLine</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">do_meta_command</span><span class="p">(</span><span class="n">zLine</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="mi">2</span> <span class="p">){</span> <span class="cm">/* exit requested */</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
        <span class="n">errCnt</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">_is_command_terminator</span><span class="p">(</span><span class="n">zLine</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_is_complete</span><span class="p">(</span><span class="n">zSql</span><span class="p">,</span> <span class="n">nSql</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">zLine</span><span class="p">,</span><span class="s">&quot;;&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">nSqlPrior</span> <span class="o">=</span> <span class="n">nSql</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">IsSpace</span><span class="p">(</span><span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">){}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">nSql</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
        <span class="n">zSql</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">nSql</span><span class="o">+</span><span class="mi">3</span> <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">zSql</span><span class="p">,</span> <span class="n">zLine</span><span class="p">,</span> <span class="n">nSql</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">startline</span> <span class="o">=</span> <span class="n">lineno</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
      <span class="n">zSql</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span> <span class="n">zSql</span><span class="p">,</span> <span class="n">nSql</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">zSql</span><span class="p">[</span><span class="n">nSql</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zSql</span><span class="p">[</span><span class="n">nSql</span><span class="p">],</span> <span class="n">zLine</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">nSql</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span> <span class="o">&amp;&amp;</span> <span class="n">_contains_semicolon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zSql</span><span class="p">[</span><span class="n">nSqlPrior</span><span class="p">],</span> <span class="n">nSql</span><span class="o">-</span><span class="n">nSqlPrior</span><span class="p">)</span>
                <span class="o">&amp;&amp;</span> <span class="n">sqlite3_complete</span><span class="p">(</span><span class="n">zSql</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">open_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">BEGIN_TIMER</span><span class="p">;</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">shell_exec</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">zSql</span><span class="p">,</span> <span class="n">shell_callback</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="n">END_TIMER</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="o">||</span> <span class="n">zErrMsg</span> <span class="p">){</span>
        <span class="kt">char</span> <span class="n">zPrefix</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">in</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">stdin_is_interactive</span> <span class="p">){</span>
          <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">zPrefix</span><span class="p">),</span> <span class="n">zPrefix</span><span class="p">,</span> 
                           <span class="s">&quot;Error: near line %d:&quot;</span><span class="p">,</span> <span class="n">startline</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">zPrefix</span><span class="p">),</span> <span class="n">zPrefix</span><span class="p">,</span> <span class="s">&quot;Error:&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zPrefix</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
          <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zErrMsg</span><span class="p">);</span>
          <span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zPrefix</span><span class="p">,</span> <span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">errCnt</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">free</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
      <span class="n">zSql</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">nSql</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">zSql</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">_all_whitespace</span><span class="p">(</span><span class="n">zSql</span><span class="p">)</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: incomplete SQL: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zSql</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">free</span><span class="p">(</span><span class="n">zSql</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">zLine</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">errCnt</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Return a pathname which is the user's home directory.  A</li>
<li>0 return indicates an error of some kind.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_home_dir</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">home_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">home_dir</span> <span class="p">)</span> <span class="k">return</span> <span class="n">home_dir</span><span class="p">;</span>

<span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(WIN32) &amp;&amp; !defined(__OS2__) &amp;&amp; !defined(_WIN32_WCE) &amp;&amp; !defined(__RTP__) &amp;&amp; !defined(_WRS_KERNEL)</span>
  <span class="k">struct</span> <span class="n">passwd</span> <span class="o">*</span><span class="n">pwent</span><span class="p">;</span>
  <span class="kt">uid_t</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pwent</span><span class="o">=</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">pwent</span><span class="o">-&gt;</span><span class="n">pw_dir</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(_WIN32_WCE)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Windows CE (arm-wince-mingw32ce-gcc) does not provide getenv()</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="n">home_dir</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>
<span class="cp">#else</span>

<span class="cp">#if defined(_WIN32) || defined(WIN32) || defined(__OS2__)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home_dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;USERPROFILE&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home_dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#if defined(_WIN32) || defined(WIN32) || defined(__OS2__)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home_dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">zDrive</span><span class="p">,</span> <span class="o">*</span><span class="n">zPath</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">zDrive</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOMEDRIVE&quot;</span><span class="p">);</span>
    <span class="n">zPath</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOMEPATH&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">zDrive</span> <span class="o">&amp;&amp;</span> <span class="n">zPath</span> <span class="p">){</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zDrive</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zPath</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">home_dir</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">home_dir</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">home_dir</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">zDrive</span><span class="p">,</span> <span class="n">zPath</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">home_dir</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="s">&quot;c:</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* !_WIN32_WCE */</span><span class="cp"></span>

  <span class="k">if</span><span class="p">(</span> <span class="n">home_dir</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span> <span class="p">)</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">home_dir</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">home_dir</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Read input from the file given by sqliterc_override.  Or if that</li>
<li>parameter is NULL, take input from ~/.sqliterc
*</li>
<li>Returns the number of errors.</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_sqliterc</span><span class="p">(</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>        <span class="cm">/* Configuration data */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sqliterc_override</span>   <span class="cm">/* Name of config file. NULL to use default */</span>
<span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">home_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sqliterc</span> <span class="o">=</span> <span class="n">sqliterc_override</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zBuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">sqliterc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">find_home_dir</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">home_dir</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
<span class="cp">#if !defined(__RTP__) &amp;&amp; !defined(_WRS_KERNEL)</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: cannot locate your home directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Argv0</span><span class="p">);</span>
<span class="cp">#endif</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">zBuf</span> <span class="o">=</span> <span class="n">sqlite3_mprintf</span><span class="p">(</span><span class="s">&quot;%s/.sqliterc&quot;</span><span class="p">,</span><span class="n">home_dir</span><span class="p">);</span>
    <span class="n">sqliterc</span> <span class="o">=</span> <span class="n">zBuf</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">in</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">sqliterc</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">in</span> <span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">stdin_is_interactive</span> <span class="p">){</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;-- Loading resources from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sqliterc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">in</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">sqlite3_free</span><span class="p">(</span><span class="n">zBuf</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Show available command line options</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zOptions</span><span class="p">[]</span> <span class="o">=</span> 
  <span class="s">&quot;   -bail                stop after hitting an error</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -batch               force batch I/O</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -column              set output mode to &#39;column&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -cmd command         run </span><span class="se">\&quot;</span><span class="s">command</span><span class="se">\&quot;</span><span class="s"> before reading stdin</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -csv                 set output mode to &#39;csv&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -echo                print commands before execution</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -init filename       read/process named file</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -[no]header          turn headers on or off</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -help                show this message</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -html                set output mode to HTML</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -interactive         force interactive I/O</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -line                set output mode to &#39;line&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -list                set output mode to &#39;list&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef SQLITE_ENABLE_MULTIPLEX</span>
  <span class="s">&quot;   -multiplex           enable the multiplexor VFS</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
  <span class="s">&quot;   -nullvalue &#39;text&#39;    set text string for NULL values</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -separator &#39;x&#39;       set output field separator (|)</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -stats               print memory stats before each finalize</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -version             show SQLite version</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="s">&quot;   -vfs NAME            use NAME as the default VFS</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef SQLITE_ENABLE_VFSTRACE</span>
  <span class="s">&quot;   -vfstrace            enable tracing of all VFS calls</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
<span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="kt">int</span> <span class="n">showDetail</span><span class="p">){</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
      <span class="s">&quot;Usage: %s [OPTIONS] FILENAME [SQL]</span><span class="se">\n</span><span class="s">&quot;</span>  
      <span class="s">&quot;FILENAME is the name of an SQLite database. A new database is created</span><span class="se">\n</span><span class="s">&quot;</span>
      <span class="s">&quot;if the file does not previously exist.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Argv0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">showDetail</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;OPTIONS include:</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">zOptions</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Use the -help option for additional information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><ul>
<li>Initialize the state information in data</li>
</ul>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">main_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_List</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">separator</span><span class="p">,</span><span class="s">&quot;|&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">sqlite3_config</span><span class="p">(</span><span class="n">SQLITE_CONFIG_URI</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">sqlite3_config</span><span class="p">(</span><span class="n">SQLITE_CONFIG_LOG</span><span class="p">,</span> <span class="n">shellLog</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mainPrompt</span><span class="p">),</span> <span class="n">mainPrompt</span><span class="p">,</span><span class="s">&quot;sqlite&gt; &quot;</span><span class="p">);</span>
  <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">continuePrompt</span><span class="p">),</span> <span class="n">continuePrompt</span><span class="p">,</span><span class="s">&quot;   ...&gt; &quot;</span><span class="p">);</span>
  <span class="n">sqlite3_config</span><span class="p">(</span><span class="n">SQLITE_CONFIG_SINGLETHREAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">callback_data</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zInitFile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">zFirstCmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">sqlite3_sourceid</span><span class="p">(),</span><span class="n">SQLITE_SOURCE_ID</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SQLite header and source version mismatch</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">sqlite3_sourceid</span><span class="p">(),</span> <span class="n">SQLITE_SOURCE_ID</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Argv0</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">main_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="n">stdin_is_interactive</span> <span class="o">=</span> <span class="n">isatty</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Make sure we have a valid signal handler early, before anything
* else is done.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="cp">#ifdef SIGINT</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt_handler</span><span class="p">);</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Do an initial pass through the command-line argument to locate
* the name of the database file, the name of the initialization file,
* the size of the alternative malloc heap,
* and the first command to execute.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;-&#39;</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="p">)</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-separator&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
     <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-nullvalue&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
     <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-cmd&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
    <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-init&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="n">zInitFile</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Need to check for batch mode here to so we can avoid printing
* informational messages (like from process_sqliterc) before 
* we do the actual processing of arguments later in a second pass.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-batch&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">stdin_is_interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-heap&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
<span class="cp">#if defined(SQLITE_ENABLE_MEMSYS3) || defined(SQLITE_ENABLE_MEMSYS5)</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSize</span><span class="p">;</span>
      <span class="n">sqlite3_int64</span> <span class="n">szHeap</span><span class="p">;</span>

      <span class="n">zSize</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">];</span>
      <span class="n">szHeap</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">zSize</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">zSize</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;M&#39;</span> <span class="p">){</span> <span class="n">szHeap</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;K&#39;</span> <span class="p">){</span> <span class="n">szHeap</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="sc">&#39;G&#39;</span> <span class="p">){</span> <span class="n">szHeap</span> <span class="o">*=</span> <span class="mi">1000000000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">szHeap</span><span class="o">&gt;</span><span class="mh">0x7fff0000</span> <span class="p">)</span> <span class="n">szHeap</span> <span class="o">=</span> <span class="mh">0x7fff0000</span><span class="p">;</span>
      <span class="n">sqlite3_config</span><span class="p">(</span><span class="n">SQLITE_CONFIG_HEAP</span><span class="p">,</span> <span class="n">malloc</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">szHeap</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">szHeap</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SQLITE_ENABLE_VFSTRACE</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-vfstrace&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="k">extern</span> <span class="kt">int</span> <span class="n">vfstrace_register</span><span class="p">(</span>
         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zTraceName</span><span class="p">,</span>
         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zOldVfsName</span><span class="p">,</span>
         <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xOut</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span>
         <span class="kt">void</span> <span class="o">*</span><span class="n">pOutArg</span><span class="p">,</span>
         <span class="kt">int</span> <span class="n">makeDefault</span>
      <span class="p">);</span>
      <span class="n">vfstrace_register</span><span class="p">(</span><span class="s">&quot;trace&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">))</span><span class="n">fputs</span><span class="p">,</span><span class="n">stderr</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SQLITE_ENABLE_MULTIPLEX</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-multiplex&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="k">extern</span> <span class="kt">int</span> <span class="n">sqlite3_multiple_initialize</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
      <span class="n">sqlite3_multiplex_initialize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-vfs&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">sqlite3_vfs</span> <span class="o">*</span><span class="n">pVfs</span> <span class="o">=</span> <span class="n">sqlite3_vfs_find</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">pVfs</span> <span class="p">){</span>
        <span class="n">sqlite3_vfs_register</span><span class="p">(</span><span class="n">pVfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;no such VFS: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span> <span class="p">){</span>
<span class="cp">#if defined(SQLITE_OS_OS2) &amp;&amp; SQLITE_OS_OS2</span>
    <span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">convertCpPathToUtf8</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
<span class="cp">#endif</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="cp">#ifndef SQLITE_OMIT_MEMORYDB</span>
    <span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span> <span class="o">=</span> <span class="s">&quot;:memory:&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span> <span class="p">){</span>
    <span class="n">zFirstCmd</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: too many options: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Argv0</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Use -help for a list of options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">data</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">;</span>

<span class="cp">#ifdef SQLITE_OMIT_MEMORYDB</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: no database filename specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Argv0</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Go ahead and open the database file if it already exists.  If the
* file does not exist, delay opening it.  This prevents empty database
* files from being created if a user mistypes the database name argument
* to the sqlite command-line tool.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span><span class="p">(</span> <span class="n">access</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">zDbFilename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
    <span class="n">open_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Process the initialization file if there is one.  If no -init option
* is given on the command line, look for a file named ~/.sqliterc and
* try to process it.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">process_sqliterc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="n">zInitFile</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Make a second pass through the command-line argument and set
* options.  This second pass is delayed until after the initialization
* file is processed so that the command-line arguments will override
* settings in the initialization file.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;-&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="p">){</span> <span class="n">z</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-init&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-html&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Html</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-list&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_List</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-line&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Line</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-column&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Column</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-csv&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_Csv</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-separator&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">argc</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: missing argument for option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">Argv0</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Use -help for a list of options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">separator</span><span class="p">),</span> <span class="n">data</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span>
                       <span class="s">&quot;%.*s&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">separator</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-nullvalue&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">argc</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: missing argument for option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">Argv0</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Use -help for a list of options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">nullvalue</span><span class="p">),</span> <span class="n">data</span><span class="p">.</span><span class="n">nullvalue</span><span class="p">,</span>
                       <span class="s">&quot;%.*s&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">nullvalue</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-header&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-noheader&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">showHeader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-echo&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">echoOn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-stats&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">data</span><span class="p">.</span><span class="n">statsOn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-bail&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">bail_on_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-version&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sqlite3_libversion</span><span class="p">(),</span> <span class="n">sqlite3_sourceid</span><span class="p">());</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-interactive&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">stdin_is_interactive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-batch&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">stdin_is_interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-heap&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-vfs&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef SQLITE_ENABLE_VFSTRACE</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-vfstrace&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SQLITE_ENABLE_MULTIPLEX</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-multiplex&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-help&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="n">usage</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="s">&quot;-cmd&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">==</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;.&#39;</span> <span class="p">){</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">do_meta_command</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">bail_on_error</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">open_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">shell_exec</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">db</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">shell_callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">bail_on_error</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="o">!=</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: unable to process SQL </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">bail_on_error</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s: Error: unknown option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Argv0</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Use -help for a list of options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">zFirstCmd</span> <span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Run just the command that follows the database name</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span><span class="p">(</span> <span class="n">zFirstCmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;.&#39;</span> <span class="p">){</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">do_meta_command</span><span class="p">(</span><span class="n">zFirstCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">open_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">shell_exec</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">db</span><span class="p">,</span> <span class="n">zFirstCmd</span><span class="p">,</span> <span class="n">shell_callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zErrMsg</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zErrMsg</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="o">!=</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Error: unable to process SQL </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zFirstCmd</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Run commands received from standard input</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span><span class="p">(</span> <span class="n">stdin_is_interactive</span> <span class="p">){</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">zHome</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">zHistory</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">nHistory</span><span class="p">;</span>
      <span class="n">printf</span><span class="p">(</span>
        <span class="s">&quot;SQLite version %s %.19s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/*extra-version-info*/</span>
        <span class="s">&quot;Enter </span><span class="se">\&quot;</span><span class="s">.help</span><span class="se">\&quot;</span><span class="s"> for instructions</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;Enter SQL statements terminated with a </span><span class="se">\&quot;</span><span class="s">;</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">sqlite3_libversion</span><span class="p">(),</span> <span class="n">sqlite3_sourceid</span><span class="p">()</span>
      <span class="p">);</span>
      <span class="n">zHome</span> <span class="o">=</span> <span class="n">find_home_dir</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zHome</span> <span class="p">){</span>
        <span class="n">nHistory</span> <span class="o">=</span> <span class="n">strlen30</span><span class="p">(</span><span class="n">zHome</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">zHistory</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">nHistory</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
          <span class="n">sqlite3_snprintf</span><span class="p">(</span><span class="n">nHistory</span><span class="p">,</span> <span class="n">zHistory</span><span class="p">,</span><span class="s">&quot;%s/.sqlite_history&quot;</span><span class="p">,</span> <span class="n">zHome</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
<span class="cp">#if defined(HAVE_READLINE) &amp;&amp; HAVE_READLINE==1</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zHistory</span> <span class="p">)</span> <span class="n">read_history</span><span class="p">(</span><span class="n">zHistory</span><span class="p">);</span>
<span class="cp">#endif</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">zHistory</span> <span class="p">){</span>
        <span class="n">stifle_history</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
        <span class="n">write_history</span><span class="p">(</span><span class="n">zHistory</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">zHistory</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">set_table_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">.</span><span class="n">db</span> <span class="p">){</span>
    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">db</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
