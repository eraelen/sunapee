<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../", thisFile = "node_modules/socket.io/node_modules/redis/index.js", defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="cm">/*global Buffer require exports console setTimeout */</span>

<span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;net&quot;</span><span class="p">),</span>
    <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/util&quot;</span><span class="p">),</span>
    <span class="nx">Queue</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/queue&quot;</span><span class="p">),</span>
    <span class="nx">to_array</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/to_array&quot;</span><span class="p">),</span>
    <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">),</span>
    <span class="nx">parsers</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">commands</span><span class="p">,</span>
    <span class="nx">connection_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">default_port</span> <span class="o">=</span> <span class="mi">6379</span><span class="p">,</span>
    <span class="nx">default_host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>can set this to true to enable for all connections</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>hiredis might not be installed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">try</span> <span class="p">{</span>
    <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/parser/hiredis&quot;</span><span class="p">);</span>
    <span class="nx">parsers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/parser/hiredis&quot;</span><span class="p">));</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;hiredis parser not installed.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">parsers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/parser/javascript&quot;</span><span class="p">));</span>

<span class="kd">function</span> <span class="nx">RedisClient</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">connection_id</span> <span class="o">=</span> <span class="o">++</span><span class="nx">connection_id</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connections</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue_high_water</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">command_queue_high_water</span> <span class="o">||</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue_low_water</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">command_queue_low_water</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_attempts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">=</span> <span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_attempts</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span> <span class="c1">// holds sent commands to de-pipeline them</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span> <span class="c1">// holds commands issued but not able to be sent</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">commands_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connect_timeout</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">connect_timeout</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">connect_timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">connect_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">connect_timeout</span> <span class="o">=</span> <span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">connect_timeout</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize_retry_vars</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subscription_set</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">monitoring</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">closing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">server_info</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">auth_pass</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parser_module</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">selected_db</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>  <span class="c1">// save the selected db here, used when reconnecting</span>
  
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on_connect</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer_from_socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on_data</span><span class="p">(</span><span class="nx">buffer_from_socket</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on_error</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">connection_gone</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">connection_gone</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">RedisClient</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">RedisClient</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">;</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize_retry_vars</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retry_totaltime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retry_delay</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retry_backoff</span> <span class="o">=</span> <span class="mf">1.7</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>flush offline_queue and command_queue, erroring any items with a callback first</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flush_and_error</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">command_obj</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on_error</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;Redis connection to &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; failed - &quot;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">,</span>
        <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">command_obj</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">closing</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">flush_and_error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>"error" events get turned into exceptions if they aren't listened for.  If the user handled this error
then we should try to reconnect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">connection_gone</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">do_auth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Sending auth to &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; id &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">connection_id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">send_anyway</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">auth_pass</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="s2">&quot;LOADING&quot;</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>if redis is still loading the db, it will not authenticate and everything else will fail</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Redis still loading, trying to authenticate later&quot;</span><span class="p">);</span>
                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">do_auth</span><span class="p">();</span>
                <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span> <span class="c1">// TODO - magic number alert</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Auth error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">!==</span> <span class="s2">&quot;OK&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Auth failed: &quot;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">toString</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Auth succeeded &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; id &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">connection_id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">auth_callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">auth_callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">auth_callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>now we are really connected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_ready_check</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">on_ready</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">ready_check</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">send_anyway</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on_connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Stream connected &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; id &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">connection_id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connections</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emitted_end</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize_retry_vars</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">setNoDelay</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">init_parser</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">auth_pass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">do_auth</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_ready_check</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">on_ready</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ready_check</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init_parser</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">parsers</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">parser_module</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Using parser module: &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parser_module</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find named parser &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">parser</span> <span class="o">+</span> <span class="s2">&quot; on this system&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Using default parser module: &quot;</span> <span class="o">+</span> <span class="nx">parsers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parser_module</span> <span class="o">=</span> <span class="nx">parsers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">parser_module</span><span class="p">.</span><span class="nx">debug_mode</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>return_buffers sends back Buffers from parser to callback. detect_buffers sends back Buffers from parser, but
converts to Strings if the input arguments are not Buffers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply_parser</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">parser_module</span><span class="p">.</span><span class="nx">Parser</span><span class="p">({</span>
        <span class="nx">return_buffers</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">return_buffers</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">detect_buffers</span> <span class="o">||</span> <span class="kc">false</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>"reply error" is an error sent back by Redis</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply_parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reply error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">return_error</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">reply</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply_parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reply&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">return_reply</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>"error" is bad.  Somehow the parser got confused.  It'll try to reset and continue.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply_parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Redis reply parser error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on_ready</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>magically restore any modal commands from a previous connection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected_db</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">selected_db</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subscription_set</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;sending pub/sub on_ready &quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;monitor&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">send_offline_queue</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on_info_cmd</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">retry_time</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Ready check failed: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nx">lines</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\r\n&quot;</span><span class="p">);</span>

    <span class="nx">lines</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">versions</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">redis_version</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">versions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">+</span><span class="nx">num</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>expose info key/vals to users</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">server_info</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">loading</span> <span class="o">||</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">loading</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Redis server ready.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">on_ready</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">retry_time</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">loading_eta_seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">retry_time</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">retry_time</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Redis server still loading, trying again in &quot;</span> <span class="o">+</span> <span class="nx">retry_time</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">ready_check</span><span class="p">();</span>
        <span class="p">},</span> <span class="nx">retry_time</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ready_check</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;checking server ready state...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">send_anyway</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// secret flag to send_command to send something even if not &quot;ready&quot;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on_info_cmd</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">send_anyway</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_offline_queue</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">command_obj</span><span class="p">,</span> <span class="nx">buffered_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Sending offline command: &quot;</span> <span class="o">+</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">command</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">.</span><span class="nx">command</span><span class="p">,</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">args</span><span class="p">,</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Even though items were shifted off, Queue backing store still uses memory until next add, so just get a new Queue</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">buffered_writes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connection_gone</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">why</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">message</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>If a retry is already in progress, just let that happen</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">retry_timer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Redis connection is gone from &quot;</span> <span class="o">+</span> <span class="nx">why</span> <span class="o">+</span> <span class="s2">&quot; event.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>since we are collapsing end and close, users don't expect to be called twice</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">emitted_end</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emitted_end</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">flush_and_error</span><span class="p">(</span><span class="s2">&quot;Redis connection gone from &quot;</span> <span class="o">+</span> <span class="nx">why</span> <span class="o">+</span> <span class="s2">&quot; event.&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>If this is a requested shutdown, then don't retry</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">closing</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;connection ended from quit command, not retrying.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">retry_delay</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">retry_delay</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">retry_backoff</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retry connection in &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">current_retry_delay</span> <span class="o">+</span> <span class="s2">&quot; ms&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_attempts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>TODO - some people need a "Redis is Broken mode" for future commands that errors immediately, and others
want the program to exit.  Right now, we just log, which doesn't really help in either case.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;node_redis: Couldn&#39;t get Redis connection after &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_attempts</span> <span class="o">+</span> <span class="s2">&quot; attempts.&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;reconnecting&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">delay</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retry_delay</span><span class="p">,</span>
        <span class="nx">attempt</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">attempts</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retrying connection...&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">retry_totaltime</span> <span class="o">+=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current_retry_delay</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connect_timeout</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retry_totaltime</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">connect_timeout</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>TODO - engage Redis is Broken mode for future commands, or whatever</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;node_redis: Couldn&#39;t get Redis connection after &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retry_totaltime</span> <span class="o">+</span> <span class="s2">&quot;ms.&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">retry_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">retry_delay</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on_data</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;net read &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; id &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">connection_id</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reply_parser</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>This is an unexpected parser problem, an exception that came from the parser code itself.
Parser should emit "error" events if it notices things are out of whack.
Callbacks that throw exceptions will land in return_reply(), below.
TODO - it might be nice to have a different "error" event for different types of errors</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">return_error</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">queue_len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">getLength</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">queue_len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;idle&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">&amp;&amp;</span> <span class="nx">queue_len</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue_low_water</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">command_obj</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">callback_err</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>if a callback throws an exception, re-throw it on a new stack so the parser can keep going</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">callback_err</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;node_redis: no callback to send error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>this will probably not make it anywhere useful, but we might as well throw</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>if a callback throws an exception, re-throw it on a new stack so the parser can keep going.
put this try/catch in its own function because V8 doesn't optimize this well yet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">try_callback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reply</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>hgetall converts its replies to an Object.  If the reply is empty, null is returned.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">reply_to_object</span><span class="p">(</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">jl</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">jl</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">jl</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">key</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">toString</span><span class="p">();</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">reply_to_strings</span><span class="p">(</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">reply</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">reply</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">reply</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">reply</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">return_reply</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">command_obj</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">argindex</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">queue_len</span><span class="p">;</span>
    
    <span class="nx">queue_len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">getLength</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">queue_len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;idle&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">();</span>  <span class="c1">// explicitly reclaim storage from old Queue</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">&amp;&amp;</span> <span class="nx">queue_len</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue_low_water</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">command_obj</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">command_obj</span><span class="p">.</span><span class="nx">sub_command</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">detect_buffers</span> <span class="o">&amp;&amp;</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">buffer_args</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>If detect_buffers option was specified, then the reply from the parser will be Buffers.
If this command did not use Buffer arguments, then convert the reply to Strings here.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">reply</span> <span class="o">=</span> <span class="nx">reply_to_strings</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>TODO - confusing and error-prone that hgetall is special cased in two places</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;hgetall&#39;</span> <span class="o">===</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">reply</span> <span class="o">=</span> <span class="nx">reply_to_object</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">try_callback</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">reply</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;no callback for reply: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">&amp;&amp;</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">toString</span> <span class="o">&amp;&amp;</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">toString</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">||</span> <span class="p">(</span><span class="nx">command_obj</span> <span class="o">&amp;&amp;</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">sub_command</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">reply</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// channel, message</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;pmessage&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pmessage&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="c1">// pattern, channel, message</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;subscribe&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;unsubscribe&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;psubscribe&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;punsubscribe&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;All subscriptions removed, exiting pub/sub mode&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>subscribe commands take an optional callback and also emit an event, but only the first response is included in the callback
TODO - document this or fix it so it works in a more obvious way</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">command_obj</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">try_callback</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">.</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// channel, count</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;subscriptions are active but got unknown reply type &quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">closing</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;subscriptions are active but got an invalid reply: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>
        <span class="nx">argindex</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">argindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&quot; &quot;&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;monitor&quot;</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;node_redis command queue state error. If you can reproduce this, please report it.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>This Command constructor is ever so slightly faster than using an object literal, but more importantly, using
a named constructor helps it show up meaningfully in the V8 CPU profiler and in heap snapshots.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">Command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">sub_command</span><span class="p">,</span> <span class="nx">buffer_args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="nx">command</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sub_command</span> <span class="o">=</span> <span class="nx">sub_command</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffer_args</span> <span class="o">=</span> <span class="nx">buffer_args</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send_command</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">this_args</span><span class="p">,</span> <span class="nx">command_obj</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span> <span class="nx">elem_count</span><span class="p">,</span> <span class="nx">buffer_args</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">command_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">buffered_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">last_arg_type</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">command</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;First argument to send_command must be the command name string, not &quot;</span> <span class="o">+</span> <span class="k">typeof</span> <span class="nx">command</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>probably the fastest way:
    client.command([arg1, arg2], cb);  (straight passthrough)
        send_command(command, [arg1, arg2], cb);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>most people find this variable argument length form more convenient, but it uses arguments, which is slower
    client.command(arg1, arg2, cb);   (wraps up arguments into an array)
      send_command(command, [arg1, arg2, cb]);
    client.command(arg1, arg2);   (callback is optional)
      send_command(command, [arg1, arg2]);
    client.command(arg1, arg2, undefined);   (callback is undefined)
      send_command(command, [arg1, arg2, undefined]);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">last_arg_type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">last_arg_type</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">||</span> <span class="nx">last_arg_type</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;send_command: last argument must be a callback or undefined&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;send_command: second argument must be an array&quot;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>if the last argument is an array, expand it out.  This allows commands like this:
    client.command(arg1, [arg2, arg3, arg4], cb);
 and converts to:
    client.command(arg1, arg2, arg3, arg4, cb);
which is convenient for some things like sadd</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">buffer_args</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">arg</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">buffer_args</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">command_obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">buffer_args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">send_anyway</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">writable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">writable</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send command: stream is not writeable.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Queueing &quot;</span> <span class="o">+</span> <span class="nx">command</span> <span class="o">+</span> <span class="s2">&quot; for next server connection.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">offline_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;subscribe&quot;</span> <span class="o">||</span> <span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;psubscribe&quot;</span> <span class="o">||</span> <span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;unsubscribe&quot;</span> <span class="o">||</span> <span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;punsubscribe&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_command</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;monitor&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">monitoring</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;quit&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">closing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Connection in pub/sub mode, only pub/sub commands may be used&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">command_obj</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">commands_sent</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="nx">elem_count</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Always use "Multi bulk commands", but if passed any Buffer args, then do multiple writes, one for each arg.
This means that using Buffers in commands is going to be slower, so use Strings if you don't already have a Buffer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">command_str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="nx">elem_count</span> <span class="o">+</span> <span class="s2">&quot;\r\n$&quot;</span> <span class="o">+</span> <span class="nx">command</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span> <span class="o">+</span> <span class="nx">command</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">buffer_args</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Build up a string and send entire command in one write</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">arg</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">arg</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">arg</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">arg</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">command_str</span> <span class="o">+=</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span> <span class="o">+</span> <span class="nx">arg</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot; id &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">connection_id</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">command_str</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">command_str</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send command (&quot;</span> <span class="o">+</span> <span class="nx">command_str</span> <span class="o">+</span> <span class="s2">&quot;) has Buffer arguments&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">command_str</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">arg</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">arg</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">||</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">String</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">arg</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">arg</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send_command: using empty string for 0 length buffer&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;$0\r\n\r\n&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">);</span>
                    <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
                    <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;\r\n&quot;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send_command: buffer send &quot;</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; bytes&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send_command: string send &quot;</span> <span class="o">+</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; bytes: &quot;</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">buffered_writes</span> <span class="o">+=</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span> <span class="o">+</span> <span class="nx">arg</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;send_command buffered_writes: &quot;</span> <span class="o">+</span> <span class="nx">buffered_writes</span><span class="p">,</span> <span class="s2">&quot; should_buffer: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">buffered_writes</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue</span><span class="p">.</span><span class="nx">getLength</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">command_queue_high_water</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">should_buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pub_sub_command</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">command_obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Entering pub/sub mode from &quot;</span> <span class="o">+</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">command</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pub_sub_mode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">command_obj</span><span class="p">.</span><span class="nx">sub_command</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">command</span> <span class="o">=</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">command</span><span class="p">;</span>
    <span class="nx">args</span> <span class="o">=</span> <span class="nx">command_obj</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;subscribe&quot;</span> <span class="o">||</span> <span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;psubscribe&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;sub&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;psub&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">subscription_set</span><span class="p">[</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;sub&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;psub&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">subscription_set</span><span class="p">[</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">Multi</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">client</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">queue</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;MULTI&quot;</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">queue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Multi</span> <span class="o">=</span> <span class="nx">Multi</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>take 2 arrays and return the union of their elements</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">set_union</span><span class="p">(</span><span class="nx">seta</span><span class="p">,</span> <span class="nx">setb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="nx">seta</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">val</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">setb</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">val</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>This static list of commands is updated from time to time.  ./lib/commands.js can be updated with generate_commands.js</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">commands</span> <span class="o">=</span> <span class="nx">set_union</span><span class="p">([</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;setnx&quot;</span><span class="p">,</span> <span class="s2">&quot;setex&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="s2">&quot;strlen&quot;</span><span class="p">,</span> <span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="s2">&quot;exists&quot;</span><span class="p">,</span> <span class="s2">&quot;setbit&quot;</span><span class="p">,</span> <span class="s2">&quot;getbit&quot;</span><span class="p">,</span> <span class="s2">&quot;setrange&quot;</span><span class="p">,</span> <span class="s2">&quot;getrange&quot;</span><span class="p">,</span> <span class="s2">&quot;substr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;incr&quot;</span><span class="p">,</span> <span class="s2">&quot;decr&quot;</span><span class="p">,</span> <span class="s2">&quot;mget&quot;</span><span class="p">,</span> <span class="s2">&quot;rpush&quot;</span><span class="p">,</span> <span class="s2">&quot;lpush&quot;</span><span class="p">,</span> <span class="s2">&quot;rpushx&quot;</span><span class="p">,</span> <span class="s2">&quot;lpushx&quot;</span><span class="p">,</span> <span class="s2">&quot;linsert&quot;</span><span class="p">,</span> <span class="s2">&quot;rpop&quot;</span><span class="p">,</span> <span class="s2">&quot;lpop&quot;</span><span class="p">,</span> <span class="s2">&quot;brpop&quot;</span><span class="p">,</span> <span class="s2">&quot;brpoplpush&quot;</span><span class="p">,</span> <span class="s2">&quot;blpop&quot;</span><span class="p">,</span> <span class="s2">&quot;llen&quot;</span><span class="p">,</span> <span class="s2">&quot;lindex&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lset&quot;</span><span class="p">,</span> <span class="s2">&quot;lrange&quot;</span><span class="p">,</span> <span class="s2">&quot;ltrim&quot;</span><span class="p">,</span> <span class="s2">&quot;lrem&quot;</span><span class="p">,</span> <span class="s2">&quot;rpoplpush&quot;</span><span class="p">,</span> <span class="s2">&quot;sadd&quot;</span><span class="p">,</span> <span class="s2">&quot;srem&quot;</span><span class="p">,</span> <span class="s2">&quot;smove&quot;</span><span class="p">,</span> <span class="s2">&quot;sismember&quot;</span><span class="p">,</span> <span class="s2">&quot;scard&quot;</span><span class="p">,</span> <span class="s2">&quot;spop&quot;</span><span class="p">,</span> <span class="s2">&quot;srandmember&quot;</span><span class="p">,</span> <span class="s2">&quot;sinter&quot;</span><span class="p">,</span> <span class="s2">&quot;sinterstore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sunion&quot;</span><span class="p">,</span> <span class="s2">&quot;sunionstore&quot;</span><span class="p">,</span> <span class="s2">&quot;sdiff&quot;</span><span class="p">,</span> <span class="s2">&quot;sdiffstore&quot;</span><span class="p">,</span> <span class="s2">&quot;smembers&quot;</span><span class="p">,</span> <span class="s2">&quot;zadd&quot;</span><span class="p">,</span> <span class="s2">&quot;zincrby&quot;</span><span class="p">,</span> <span class="s2">&quot;zrem&quot;</span><span class="p">,</span> <span class="s2">&quot;zremrangebyscore&quot;</span><span class="p">,</span> <span class="s2">&quot;zremrangebyrank&quot;</span><span class="p">,</span> <span class="s2">&quot;zunionstore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zinterstore&quot;</span><span class="p">,</span> <span class="s2">&quot;zrange&quot;</span><span class="p">,</span> <span class="s2">&quot;zrangebyscore&quot;</span><span class="p">,</span> <span class="s2">&quot;zrevrangebyscore&quot;</span><span class="p">,</span> <span class="s2">&quot;zcount&quot;</span><span class="p">,</span> <span class="s2">&quot;zrevrange&quot;</span><span class="p">,</span> <span class="s2">&quot;zcard&quot;</span><span class="p">,</span> <span class="s2">&quot;zscore&quot;</span><span class="p">,</span> <span class="s2">&quot;zrank&quot;</span><span class="p">,</span> <span class="s2">&quot;zrevrank&quot;</span><span class="p">,</span> <span class="s2">&quot;hset&quot;</span><span class="p">,</span> <span class="s2">&quot;hsetnx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hget&quot;</span><span class="p">,</span> <span class="s2">&quot;hmset&quot;</span><span class="p">,</span> <span class="s2">&quot;hmget&quot;</span><span class="p">,</span> <span class="s2">&quot;hincrby&quot;</span><span class="p">,</span> <span class="s2">&quot;hdel&quot;</span><span class="p">,</span> <span class="s2">&quot;hlen&quot;</span><span class="p">,</span> <span class="s2">&quot;hkeys&quot;</span><span class="p">,</span> <span class="s2">&quot;hvals&quot;</span><span class="p">,</span> <span class="s2">&quot;hgetall&quot;</span><span class="p">,</span> <span class="s2">&quot;hexists&quot;</span><span class="p">,</span> <span class="s2">&quot;incrby&quot;</span><span class="p">,</span> <span class="s2">&quot;decrby&quot;</span><span class="p">,</span> <span class="s2">&quot;getset&quot;</span><span class="p">,</span> <span class="s2">&quot;mset&quot;</span><span class="p">,</span> <span class="s2">&quot;msetnx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;randomkey&quot;</span><span class="p">,</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;rename&quot;</span><span class="p">,</span> <span class="s2">&quot;renamenx&quot;</span><span class="p">,</span> <span class="s2">&quot;expire&quot;</span><span class="p">,</span> <span class="s2">&quot;expireat&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="s2">&quot;dbsize&quot;</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">,</span> <span class="s2">&quot;ping&quot;</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;bgsave&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bgrewriteaof&quot;</span><span class="p">,</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;lastsave&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;multi&quot;</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="s2">&quot;discard&quot;</span><span class="p">,</span> <span class="s2">&quot;sync&quot;</span><span class="p">,</span> <span class="s2">&quot;flushdb&quot;</span><span class="p">,</span> <span class="s2">&quot;flushall&quot;</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;monitor&quot;</span><span class="p">,</span> <span class="s2">&quot;ttl&quot;</span><span class="p">,</span>
    <span class="s2">&quot;persist&quot;</span><span class="p">,</span> <span class="s2">&quot;slaveof&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;psubscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;punsubscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;publish&quot;</span><span class="p">,</span> <span class="s2">&quot;watch&quot;</span><span class="p">,</span> <span class="s2">&quot;unwatch&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;restore&quot;</span><span class="p">,</span> <span class="s2">&quot;migrate&quot;</span><span class="p">,</span> <span class="s2">&quot;dump&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="s2">&quot;evalsha&quot;</span><span class="p">],</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/commands&quot;</span><span class="p">));</span>

<span class="nx">commands</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">];</span>

    <span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">command</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">command</span><span class="p">];</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>store db in this.select_db to restore it on reconnect</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">db</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">selected_db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">SELECT</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">select</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Stash auth for connect and reconnect.  Send immediately if already connected.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">auth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">auth_pass</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">auth_callback</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">debug_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Saving auth as &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">auth_pass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">AUTH</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmget</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="nx">arg3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">arg2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">arg3</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;hmget&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">arg1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">arg2</span><span class="p">),</span> <span class="nx">arg3</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">arg1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">arg2</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;hmget&quot;</span><span class="p">,</span> <span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;hmget&quot;</span><span class="p">,</span> <span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">HMGET</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmget</span><span class="p">;</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmset</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmp_args</span><span class="p">,</span> <span class="nx">tmp_keys</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span> <span class="nx">key</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;hmset&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">args</span> <span class="o">=</span> <span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>User does: client.hmset(key, {key1: val1, key2: val2})</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">tmp_args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
        <span class="nx">tmp_keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">tmp_keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="nx">tmp_keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">tmp_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="nx">tmp_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">key</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">tmp_args</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;hmset&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">HMSET</span> <span class="o">=</span> <span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmset</span><span class="p">;</span>

<span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmset</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">to_array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">tmp_args</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tmp_args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;hmset&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tmp_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="nx">tmp_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">key</span><span class="p">]);</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">tmp_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">tmp_args</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s2">&quot;hmset&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">HMSET</span> <span class="o">=</span> <span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hmset</span><span class="p">;</span>

<span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>drain queue, callback will catch "QUEUED" or error
TODO - get rid of all of these anonymous functions which are elegant but slow</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">obj</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s1">&#39;hmset&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cur</span><span class="p">[</span><span class="nx">cur</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cur</span><span class="p">[</span><span class="nx">cur</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">](</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>TODO - make this callback part of Multi.prototype instead of creating it each time</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">send_command</span><span class="p">(</span><span class="s2">&quot;EXEC&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">jl</span><span class="p">,</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">args</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">reply</span> <span class="o">=</span> <span class="nx">replies</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>TODO - confusing and error-prone that hgetall is special cased in two places</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s2">&quot;hgetall&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">replies</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">reply</span> <span class="o">=</span> <span class="nx">reply_to_object</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">](</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reply</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">replies</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">EXEC</span> <span class="o">=</span> <span class="nx">Multi</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span><span class="p">;</span>

<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multi</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Multi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">RedisClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">MULTI</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Multi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">createClient</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">port_arg</span><span class="p">,</span> <span class="nx">host_arg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">port_arg</span> <span class="o">||</span> <span class="nx">default_port</span><span class="p">,</span>
        <span class="nx">host</span> <span class="o">=</span> <span class="nx">host_arg</span> <span class="o">||</span> <span class="nx">default_host</span><span class="p">,</span>
        <span class="nx">redis_client</span><span class="p">,</span> <span class="nx">net_client</span><span class="p">;</span>

    <span class="nx">net_client</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span>

    <span class="nx">redis_client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisClient</span><span class="p">(</span><span class="nx">net_client</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="nx">redis_client</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">port</span><span class="p">;</span>
    <span class="nx">redis_client</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">host</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">redis_client</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">print</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Reply: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
