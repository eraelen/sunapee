<!DOCTYPE html>
<html>
<head>
  <title>test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../", thisFile = "node_modules/socket.io/node_modules/redis/test.js", defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="cm">/*global require console setTimeout process Buffer */</span>
<span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./index&quot;</span><span class="p">),</span>
    <span class="nx">client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
    <span class="nx">client2</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
    <span class="nx">client3</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
    <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">),</span>
    <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./lib/util&quot;</span><span class="p">),</span>
    <span class="nx">test_db_num</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="c1">// this DB will be flushed and used for testing</span>
    <span class="nx">tests</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">,</span> <span class="nx">cur_start</span><span class="p">,</span> <span class="nx">run_next_test</span><span class="p">,</span> <span class="nx">all_tests</span><span class="p">,</span> <span class="nx">all_start</span><span class="p">,</span> <span class="nx">test_count</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Set this to truthy to see the wire protocol and other debugging info</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">redis</span><span class="p">.</span><span class="nx">debug_mode</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_number</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">expected</span> <span class="o">+</span> <span class="s2">&quot; !== &quot;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">results</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nx">label</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">results</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">results</span> <span class="o">+</span> <span class="s2">&quot; is not a number&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">(</span><span class="nx">results</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">results</span> <span class="o">+</span> <span class="s2">&quot; is not a positive number&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_string</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">str</span> <span class="o">+</span> <span class="s2">&quot; does not match &quot;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_null</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">results</span> <span class="o">+</span> <span class="s2">&quot; is not null&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">notEqual</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">label</span> <span class="o">+</span> <span class="s2">&quot; err is null, but an error is expected here.&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">is_empty_array</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot; \x1b[33m&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">cur_start</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\x1b[0m ms&quot;</span><span class="p">);</span>
    <span class="nx">run_next_test</span><span class="p">();</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Tests are run in the order they are defined.  So FLUSHDB should be stay first.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">tests</span><span class="p">.</span><span class="nx">FLUSHDB</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;FLUSHDB&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">test_db_num</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client2</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">test_db_num</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">test_db_num</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">(</span><span class="s2">&quot;flush keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;flush val 1&quot;</span><span class="p">,</span> <span class="s2">&quot;flush keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;flush val 2&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">FLUSHDB</span><span class="p">(</span><span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">dbsize</span><span class="p">(</span><span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_1&quot;</span><span class="p">,</span> <span class="nx">multi1</span><span class="p">,</span> <span class="nx">multi2</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Provoke an error at queue time</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">multi1</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="nx">multi1</span><span class="p">.</span><span class="nx">mset</span><span class="p">(</span><span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;multibar&quot;</span><span class="p">,</span> <span class="s2">&quot;20&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;foo2&quot;</span><span class="p">,</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi1</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi1</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s2">&quot;multibar&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi1</span><span class="p">.</span><span class="nx">exec</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Confirm that the previous command, while containing an error, still worked.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">multi2</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
    <span class="nx">multi2</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s2">&quot;multibar&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi2</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">multi2</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_2</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_2&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>test nested multi-bulk replies</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">([</span>
        <span class="p">[</span><span class="s2">&quot;mget&quot;</span><span class="p">,</span> <span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="s2">&quot;multibar&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}],</span>
        <span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;foo2&quot;</span><span class="p">,</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">name</span><span class="p">)],</span>
        <span class="p">[</span><span class="s2">&quot;incr&quot;</span><span class="p">,</span> <span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">name</span><span class="p">)],</span>
        <span class="p">[</span><span class="s2">&quot;incr&quot;</span><span class="p">,</span> <span class="s2">&quot;multibar&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="nx">name</span><span class="p">)]</span>
    <span class="p">]).</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>

        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;13&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;23&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_3</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_3&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s2">&quot;some set&quot;</span><span class="p">,</span> <span class="s2">&quot;mem 1&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s2">&quot;some set&quot;</span><span class="p">,</span> <span class="s2">&quot;mem 2&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s2">&quot;some set&quot;</span><span class="p">,</span> <span class="s2">&quot;mem 3&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s2">&quot;some set&quot;</span><span class="p">,</span> <span class="s2">&quot;mem 4&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>make sure empty mb reply works</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;some missing set&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s2">&quot;some missing set&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>make sure empty mb reply works</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">is_empty_array</span><span class="p">(</span><span class="nx">reply</span><span class="p">),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>test nested multi-bulk replies with empty mb elements.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">([</span>
        <span class="p">[</span><span class="s2">&quot;smembers&quot;</span><span class="p">,</span> <span class="s2">&quot;some set&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="s2">&quot;some set&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;smembers&quot;</span><span class="p">,</span> <span class="s2">&quot;some set&quot;</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s2">&quot;some set&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">is_empty_array</span><span class="p">(</span><span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_4</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_4&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">mset</span><span class="p">(</span><span class="s1">&#39;some&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s1">&#39;some&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">mget</span><span class="p">(</span><span class="s1">&#39;some&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_5</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_5&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>test nested multi-bulk replies with nulls.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">([</span>
        <span class="p">[</span><span class="s2">&quot;mget&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;multifoo&quot;</span><span class="p">,</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;random value&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">]],</span>
        <span class="p">[</span><span class="s2">&quot;incr&quot;</span><span class="p">,</span> <span class="s2">&quot;multifoo&quot;</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">replies</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTI_6</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTI_6&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">hmset</span><span class="p">(</span><span class="s2">&quot;multihash&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">hmset</span><span class="p">(</span><span class="s2">&quot;multihash&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">extra</span><span class="o">:</span> <span class="s2">&quot;fancy&quot;</span><span class="p">,</span>
            <span class="nx">things</span><span class="o">:</span> <span class="s2">&quot;here&quot;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="s2">&quot;multihash&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">a</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">b</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;fancy&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">extra</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;here&quot;</span><span class="p">,</span> <span class="nx">replies</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">things</span><span class="p">);</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">EVAL_1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;EVAL_1&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">server_info</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">client</span><span class="p">.</span><span class="nx">server_info</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>test {EVAL - Lua integer -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return 100.5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>test {EVAL - Lua string -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>test {EVAL - Lua true boolean -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return true&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>test {EVAL - Lua false boolean -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return false&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_null</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>test {EVAL - Lua status code reply -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return {ok=&#39;fine&#39;}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;fine&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>test {EVAL - Lua error reply -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return {err=&#39;this is an error&#39;}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>test {EVAL - Lua table -> Redis protocol type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return {1,2,3,&#39;ciao&#39;,{1,2}}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;ciao&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>test {EVAL - Are the KEYS and ARGS arrays populated correctly?}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>test {EVAL - is Lua able to call Redis API?}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="s2">&quot;myval&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;return redis.call(&#39;get&#39;,&#39;mykey&#39;)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;myval&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>test {EVALSHA - Can we call a SHA1 if already defined?}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">evalsha</span><span class="p">(</span><span class="s2">&quot;9bd632c7d33e571e9f24556ebed26c3479a87129&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;myval&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>test {EVALSHA - Do we get an error on non defined SHA1?}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">evalsha</span><span class="p">(</span><span class="s2">&quot;ffffffffffffffffffffffffffffffffffffffff&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>test {EVAL - Redis integer -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;incr&#39;,&#39;x&#39;)\n&quot;</span> <span class="o">+</span> <span class="s2">&quot;return {type(foo),foo}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>test {EVAL - Redis bulk -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;get&#39;,&#39;mykey&#39;); return {type(foo),foo}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;myval&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>test {EVAL - Redis multi bulk -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;mylist&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s2">&quot;mylist&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s2">&quot;mylist&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s2">&quot;mylist&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;lrange&#39;,&#39;mylist&#39;,0,-1)\n&quot;</span> <span class="o">+</span> <span class="s2">&quot;return {type(foo),foo[1],foo[2],foo[3],# foo}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>test {EVAL - Redis status reply -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;set&#39;,&#39;mykey&#39;,&#39;myval&#39;); return {type(foo),foo[&#39;ok&#39;]}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>test {EVAL - Redis error reply -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="s2">&quot;myval&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;incr&#39;,&#39;mykey&#39;); return {type(foo),foo[&#39;err&#39;]}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;ERR value is not an integer or out of range&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>test {EVAL - Redis nil bulk reply -> Lua type conversion}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local foo = redis.call(&#39;get&#39;,&#39;mykey&#39;); return {type(foo),foo == false}&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>test {EVAL - Script can't run more than configured time limit} {</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;lua-time-limit&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;local i = 0; while true do i=i+1 end&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nx">require_error</span><span class="p">(</span><span class="nx">name</span><span class="p">)));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Skipping &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; because server version isn&#39;t new enough.&quot;</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">WATCH_MULTI</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;WATCH_MULTI&#39;</span><span class="p">,</span> <span class="nx">multi</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">server_info</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">client</span><span class="p">.</span><span class="nx">server_info</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">multi</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_null</span><span class="p">(</span><span class="nx">name</span><span class="p">)));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Skipping &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; because server version isn&#39;t new enough.&quot;</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">detect_buffers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;detect_buffers&quot;</span><span class="p">,</span> <span class="nx">detect_client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">detect_buffers</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>

    <span class="nx">detect_client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>single Buffer or String</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;string key 1&quot;</span><span class="p">,</span> <span class="s2">&quot;string value&quot;</span><span class="p">);</span>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;string key 1&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;string value&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;string key 1&quot;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">),</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;&lt;Buffer 73 74 72 69 6e 67 20 76 61 6c 75 65&gt;&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">hmset</span><span class="p">(</span><span class="s2">&quot;hash key 2&quot;</span><span class="p">,</span> <span class="s2">&quot;key 1&quot;</span><span class="p">,</span> <span class="s2">&quot;val 1&quot;</span><span class="p">,</span> <span class="s2">&quot;key 2&quot;</span><span class="p">,</span> <span class="s2">&quot;val 2&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>array of Buffers or Strings</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">hmget</span><span class="p">(</span><span class="s2">&quot;hash key 2&quot;</span><span class="p">,</span> <span class="s2">&quot;key 1&quot;</span><span class="p">,</span> <span class="s2">&quot;key 2&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">reply</span><span class="p">),</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;val 1&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;val 2&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">hmget</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;hash key 2&quot;</span><span class="p">),</span> <span class="s2">&quot;key 1&quot;</span><span class="p">,</span> <span class="s2">&quot;key 2&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">reply</span><span class="p">));</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;&lt;Buffer 76 61 6c 20 31&gt;&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">inspect</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;&lt;Buffer 76 61 6c 20 32&gt;&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">inspect</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Object of Buffers or Strings</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="s2">&quot;hash key 2&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">reply</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;val 1&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 1&quot;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;val 2&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 2&quot;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;hash key 2&quot;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">reply</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 1&quot;</span><span class="p">]));</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 2&quot;</span><span class="p">]));</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;&lt;Buffer 76 61 6c 20 31&gt;&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 1&quot;</span><span class="p">].</span><span class="nx">inspect</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;&lt;Buffer 76 61 6c 20 32&gt;&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="s2">&quot;key 2&quot;</span><span class="p">].</span><span class="nx">inspect</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">detect_client</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">socket_nodelay</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;socket_nodelay&quot;</span><span class="p">,</span> <span class="nx">c1</span><span class="p">,</span> <span class="nx">c2</span><span class="p">,</span> <span class="nx">c3</span><span class="p">,</span> <span class="nx">ready_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">quit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">c1</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">socket_nodelay</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">c2</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">socket_nodelay</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
    <span class="nx">c3</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">quit_check</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">quit_count</span><span class="o">++</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">quit_count</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">socket_nodelay</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>

        <span class="nx">c1</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 1&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c1</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 2&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c1</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 1&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c1</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 2&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

        <span class="nx">c2</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 3&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c2</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 4&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c2</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 3&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c2</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 4&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

        <span class="nx">c3</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 5&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c3</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;set key 6&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c3</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 5&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="nx">c3</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key 6&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

        <span class="nx">c1</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="nx">quit_check</span><span class="p">);</span>
        <span class="nx">c2</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="nx">quit_check</span><span class="p">);</span>
        <span class="nx">c3</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="nx">quit_check</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">ready_check</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ready_count</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ready_count</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">c1</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="nx">ready_check</span><span class="p">);</span>
    <span class="nx">c2</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="nx">ready_check</span><span class="p">);</span>
    <span class="nx">c3</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="nx">ready_check</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">reconnect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;reconnect&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;recon 1&quot;</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;recon 2&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Do not do this in normal programs. This is to simulate the server closing on us.
For orderly shutdown in normal programs, do client.quit()</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">client</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reconnecting&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">on_recon</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">on_connect</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">test_db_num</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;recon 1&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;recon 1&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;recon 2&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;recon 2&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="nx">on_connect</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;reconnecting&quot;</span><span class="p">,</span> <span class="nx">on_recon</span><span class="p">);</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HSET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;test hash&quot;</span><span class="p">,</span>
        <span class="nx">field1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;0123456789&quot;</span><span class="p">),</span>
        <span class="nx">value1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">),</span>
        <span class="nx">field2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="nx">value2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HSET&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HSET</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field1</span><span class="p">,</span> <span class="nx">value1</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HGET</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field1</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="nx">value1</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Empty value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HSET</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HGET</span><span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field1</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Empty key, empty value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HSET</span><span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field2</span><span class="p">,</span> <span class="nx">value1</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HSET</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field2</span><span class="p">,</span> <span class="nx">value2</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HMSET_BUFFER_AND_ARRAY</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Saving a buffer and an array to the same key should not error</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;test hash&quot;</span><span class="p">,</span>
        <span class="nx">field1</span> <span class="o">=</span> <span class="s2">&quot;buffer&quot;</span><span class="p">,</span>
        <span class="nx">value1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">),</span>
        <span class="nx">field2</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="nx">value2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;array contents&quot;</span><span class="p">],</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HSET&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMSET</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">field1</span><span class="p">,</span> <span class="nx">value1</span><span class="p">,</span> <span class="nx">field2</span><span class="p">,</span> <span class="nx">value2</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>TODO - add test for HMSET with optional callbacks</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HMGET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key1</span> <span class="o">=</span> <span class="s2">&quot;test hash 1&quot;</span><span class="p">,</span> <span class="nx">key2</span> <span class="o">=</span> <span class="s2">&quot;test hash 2&quot;</span><span class="p">,</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HMGET&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>redis-like hmset syntax</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HMSET</span><span class="p">(</span><span class="nx">key1</span><span class="p">,</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span> <span class="s2">&quot;some manner of key&quot;</span><span class="p">,</span> <span class="s2">&quot;a type of value&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>fancy hmset syntax</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HMSET</span><span class="p">(</span><span class="nx">key2</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">&quot;0123456789&quot;</span><span class="o">:</span> <span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span>
        <span class="s2">&quot;some manner of key&quot;</span><span class="o">:</span> <span class="s2">&quot;a type of value&quot;</span>
    <span class="p">},</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMGET</span><span class="p">(</span><span class="nx">key1</span><span class="p">,</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;some manner of key&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;a type of value&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMGET</span><span class="p">(</span><span class="nx">key2</span><span class="p">,</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;some manner of key&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;a type of value&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMGET</span><span class="p">(</span><span class="nx">key1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;0123456789&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMGET</span><span class="p">(</span><span class="nx">key1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;0123456789&quot;</span><span class="p">,</span> <span class="s2">&quot;some manner of key&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;abcdefghij&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;a type of value&quot;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">HMGET</span><span class="p">(</span><span class="nx">key1</span><span class="p">,</span> <span class="s2">&quot;missing thing&quot;</span><span class="p">,</span> <span class="s2">&quot;another missing thing&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HINCRBY</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HINCRBY&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">hset</span><span class="p">(</span><span class="s2">&quot;hash incr&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HINCRBY</span><span class="p">(</span><span class="s2">&quot;hash incr&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HINCRBY</span><span class="p">(</span><span class="s2">&quot;hash incr&quot;</span><span class="p">,</span> <span class="s2">&quot;value 2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SUBSCRIBE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">client1</span> <span class="o">=</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SUBSCRIBE&quot;</span><span class="p">;</span>

    <span class="nx">client1</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">===</span> <span class="s2">&quot;chan1&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client2</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;chan1&quot;</span><span class="p">,</span> <span class="s2">&quot;message 1&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client2</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;chan2&quot;</span><span class="p">,</span> <span class="s2">&quot;message 2&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
            <span class="nx">client2</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;chan1&quot;</span><span class="p">,</span> <span class="s2">&quot;message 3&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">client1</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>make sure this connection can go into and out of pub/sub mode</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">client1</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="s2">&quot;did a thing&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">client1</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">msg_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;message &quot;</span> <span class="o">+</span> <span class="nx">msg_count</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">msg_count</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client1</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">(</span><span class="s2">&quot;chan1&quot;</span><span class="p">,</span> <span class="s2">&quot;chan2&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">client1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;did a thing&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client1</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;chan1&quot;</span><span class="p">,</span> <span class="s2">&quot;chan2&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;chan1&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SUBSCRIBE_QUIT</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SUBSCRIBE_QUIT&quot;</span><span class="p">;</span>
    <span class="nx">client3</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">client3</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client3</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="nx">client3</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;chan3&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">EXISTS</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;EXISTS&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;foo2&quot;</span><span class="p">,</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">EXISTS</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">EXISTS</span><span class="p">(</span><span class="s2">&quot;foo2&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">DEL</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;DEL&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">DEL</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="s2">&quot;delvalue&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">DEL</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">DEL</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="s2">&quot;delvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;delkey2&quot;</span><span class="p">,</span> <span class="s2">&quot;delvalue2&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">DEL</span><span class="p">(</span><span class="s2">&quot;delkey&quot;</span><span class="p">,</span> <span class="s2">&quot;delkey2&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">TYPE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;TYPE&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;string key&quot;</span><span class="p">,</span> <span class="s2">&quot;should be a string&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">([</span><span class="s2">&quot;list key&quot;</span><span class="p">,</span> <span class="s2">&quot;should be a list&quot;</span><span class="p">],</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">([</span><span class="s2">&quot;set key&quot;</span><span class="p">,</span> <span class="s2">&quot;should be a set&quot;</span><span class="p">],</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">zadd</span><span class="p">([</span><span class="s2">&quot;zset key&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0&quot;</span><span class="p">,</span> <span class="s2">&quot;should be a zset&quot;</span><span class="p">],</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">hset</span><span class="p">([</span><span class="s2">&quot;hash key&quot;</span><span class="p">,</span> <span class="s2">&quot;hashtest&quot;</span><span class="p">,</span> <span class="s2">&quot;should be a hash&quot;</span><span class="p">],</span> <span class="nx">require_number_any</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">([</span><span class="s2">&quot;string key&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">([</span><span class="s2">&quot;list key&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">([</span><span class="s2">&quot;set key&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">([</span><span class="s2">&quot;zset key&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;zset&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">(</span><span class="s2">&quot;not here yet&quot;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">([</span><span class="s2">&quot;hash key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;hash&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">KEYS</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;KEYS&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">([</span><span class="s2">&quot;test keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;test val 1&quot;</span><span class="p">,</span> <span class="s2">&quot;test keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;test val 2&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">KEYS</span><span class="p">([</span><span class="s2">&quot;test keys*&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;test keys 1&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;test keys 2&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MULTIBULK_ZERO_LENGTH</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MULTIBULK_ZERO_LENGTH&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">KEYS</span><span class="p">([</span><span class="s1">&#39;users:*&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s1">&#39;error on empty multibulk reply&#39;</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">is_empty_array</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span> <span class="s2">&quot;not an empty array&quot;</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">RANDOMKEY</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;RANDOMKEY&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">([</span><span class="s2">&quot;test keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;test val 1&quot;</span><span class="p">,</span> <span class="s2">&quot;test keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;test val 2&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">RANDOMKEY</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="sr">/\w+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">RENAME</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;RENAME&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">RENAME</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;new foo&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;new foo&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">RENAMENX</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;RENAMENX&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s1">&#39;foo2&#39;</span><span class="p">,</span> <span class="s1">&#39;bar2&#39;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">RENAMENX</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;foo2&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;foo2&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">([</span><span class="s2">&quot;foo2&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">RENAMENX</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;foo2&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;foo2&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">DBSIZE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;DBSIZE&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">DBSIZE</span><span class="p">([],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="s2">&quot;DBSIZE&quot;</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">GET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;get key&quot;</span><span class="p">,</span> <span class="s2">&quot;get val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">GET</span><span class="p">([</span><span class="s2">&quot;get key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;get val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SET&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">SET</span><span class="p">([</span><span class="s2">&quot;set key&quot;</span><span class="p">,</span> <span class="s2">&quot;set val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;set key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;set val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">GETSET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;GETSET&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;getset key&quot;</span><span class="p">,</span> <span class="s2">&quot;getset val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">GETSET</span><span class="p">([</span><span class="s2">&quot;getset key&quot;</span><span class="p">,</span> <span class="s2">&quot;new getset val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;getset val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;getset key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;new getset val&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MGET</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MGET&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">([</span><span class="s2">&quot;mget keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;mget val 1&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;mget val 2&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 3&quot;</span><span class="p">,</span> <span class="s2">&quot;mget val 3&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">MGET</span><span class="p">(</span><span class="s2">&quot;mget keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 3&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 1&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 2&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 3&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">MGET</span><span class="p">([</span><span class="s2">&quot;mget keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 3&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 1&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 2&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 3&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">MGET</span><span class="p">([</span><span class="s2">&quot;mget keys 1&quot;</span><span class="p">,</span> <span class="s2">&quot;some random shit&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 2&quot;</span><span class="p">,</span> <span class="s2">&quot;mget keys 3&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s2">&quot;result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 1&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 2&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget val 3&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SETNX</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SETNX&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">,</span> <span class="s2">&quot;setnx value&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">SETNX</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">,</span> <span class="s2">&quot;new setnx value&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">SETNX</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">,</span> <span class="s2">&quot;new setnx value&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;setnx key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SETEX</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SETEX&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">SETEX</span><span class="p">([</span><span class="s2">&quot;setex key&quot;</span><span class="p">,</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span> <span class="s2">&quot;setex val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;setex key&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">ttl</span><span class="p">([</span><span class="s2">&quot;setex key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MSETNX</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MSETNX&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">mset</span><span class="p">([</span><span class="s2">&quot;mset1&quot;</span><span class="p">,</span> <span class="s2">&quot;val1&quot;</span><span class="p">,</span> <span class="s2">&quot;mset2&quot;</span><span class="p">,</span> <span class="s2">&quot;val2&quot;</span><span class="p">,</span> <span class="s2">&quot;mset3&quot;</span><span class="p">,</span> <span class="s2">&quot;val3&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">MSETNX</span><span class="p">([</span><span class="s2">&quot;mset3&quot;</span><span class="p">,</span> <span class="s2">&quot;val3&quot;</span><span class="p">,</span> <span class="s2">&quot;mset4&quot;</span><span class="p">,</span> <span class="s2">&quot;val4&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">([</span><span class="s2">&quot;mset3&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">MSETNX</span><span class="p">([</span><span class="s2">&quot;mset3&quot;</span><span class="p">,</span> <span class="s2">&quot;val3&quot;</span><span class="p">,</span> <span class="s2">&quot;mset4&quot;</span><span class="p">,</span> <span class="s2">&quot;val4&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;mset3&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;mset4&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HGETALL</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HGETALL&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">hmset</span><span class="p">([</span><span class="s2">&quot;hosts&quot;</span><span class="p">,</span> <span class="s2">&quot;mjr&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;another&quot;</span><span class="p">,</span> <span class="s2">&quot;23&quot;</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;1234&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">HGETALL</span><span class="p">([</span><span class="s2">&quot;hosts&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; result sent back unexpected error: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">mjr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;23&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">another</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;1234&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">home</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">HGETALL_NULL</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;HGETALL_NULL&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">UTF8</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;UTF8&quot;</span><span class="p">,</span>
        <span class="nx">utf8_sample</span> <span class="o">=</span> <span class="s2">&quot;ಠ_ಠ&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;utf8test&quot;</span><span class="p">,</span> <span class="nx">utf8_sample</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="s2">&quot;utf8test&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">utf8_sample</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Set tests were adapted from Brian Hammond's redis-node-client.js, which has a comprehensive test suite</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SADD</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SADD&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SADD2</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SADD2&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;set0&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s2">&quot;set0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;member0&quot;</span><span class="p">,</span> <span class="s2">&quot;member1&quot;</span><span class="p">,</span> <span class="s2">&quot;member2&quot;</span><span class="p">],</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s2">&quot;set0&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;member0&quot;</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;member1&quot;</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;member2&quot;</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SISMEMBER</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SISMEMBER&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member1&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SCARD</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SCARD&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member1&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SREM</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SREM&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">srem</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">srem</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s1">&#39;set0&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SPOP</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SPOP&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;zzz&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">spop</span><span class="p">(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s1">&#39;member0&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">scard</span><span class="p">(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SDIFF</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SDIFF&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sdiff</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">values</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SDIFFSTORE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SDIFFSTORE&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;quux&#39;</span><span class="p">);</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>NB: SDIFFSTORE returns the number of elements in the dstkey</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sdiffstore</span><span class="p">(</span><span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">values</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>

        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SMEMBERS</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SMEMBERS&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">members</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">members</span><span class="p">),</span> <span class="p">[</span> <span class="s1">&#39;x&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">values</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>

        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SMOVE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SMOVE&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">);</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">smove</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">smove</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SINTER</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SINTER&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">);</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sinter</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">intersection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">intersection</span><span class="p">).</span><span class="nx">sort</span><span class="p">(),</span> <span class="p">[</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sinter</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">intersection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">intersection</span><span class="p">).</span><span class="nx">sort</span><span class="p">(),</span> <span class="p">[</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sinter</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">intersection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>3-way</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sinter</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">intersection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SINTERSTORE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SINTERSTORE&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sinterstore</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">members</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">members</span><span class="p">),</span> <span class="p">[</span> <span class="s1">&#39;c&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SUNION</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SUNION&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">);</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sunion</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">union</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">union</span><span class="p">).</span><span class="nx">sort</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SUNIONSTORE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SUNIONSTORE&quot;</span><span class="p">;</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sunionstore</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cardinality</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">cardinality</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">members</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">members</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">members</span><span class="p">).</span><span class="nx">sort</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>SORT test adapted from Brian Hammond's redis-node-client.js, which has a comprehensive test suite</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">tests</span><span class="p">.</span><span class="nx">SORT</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;SORT&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
    
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;w3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;w9&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;w2&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;w4&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;o2&#39;</span><span class="p">,</span> <span class="s1">&#39;buz&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;o4&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;o9&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="s1">&#39;qux&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span> <span class="s1">&#39;bux&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;p4&#39;</span><span class="p">,</span> <span class="s1">&#39;lux&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;p9&#39;</span><span class="p">,</span> <span class="s1">&#39;tux&#39;</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Now the data has been setup, we can test.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>But first, test basic sorting.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>y = [ d b a c ]
sort y ascending = [ a b c d ]
sort y descending = [ d c b a ]</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Now try sorting numbers in a list.
x = [ 3, 9, 2, 4 ]</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Try sorting with a 'by' pattern.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;w*&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Try sorting with a 'by' pattern and 1 'get' pattern.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;w*&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;o*&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;buz&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Try sorting with a 'by' pattern and 2 'get' patterns.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;w*&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;o*&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;p*&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">sorted</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bux&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;tux&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;lux&#39;</span><span class="p">,</span> <span class="s1">&#39;buz&#39;</span><span class="p">,</span> <span class="s1">&#39;qux&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Try sorting with a 'by' pattern and 2 'get' patterns.
Instead of getting back the sorted set/list, store the values to a list.
Then check that the values are there in the expected order.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">client</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;w*&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;o*&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;p*&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;bacon&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">lrange</span><span class="p">(</span><span class="s1">&#39;bacon&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">buffers_to_strings</span><span class="p">(</span><span class="nx">values</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bux&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;tux&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;lux&#39;</span><span class="p">,</span> <span class="s1">&#39;buz&#39;</span><span class="p">,</span> <span class="s1">&#39;qux&#39;</span><span class="p">],</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>TODO - sort by hash value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">MONITOR</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MONITOR&quot;</span><span class="p">,</span> <span class="nx">responses</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">monitor_client</span><span class="p">;</span>

    <span class="nx">monitor_client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>
    <span class="nx">monitor_client</span><span class="p">.</span><span class="nx">monitor</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">mget</span><span class="p">(</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span>
            <span class="nx">bar</span><span class="o">:</span> <span class="s2">&quot;sdflkdfsjk&quot;</span><span class="p">,</span>
            <span class="nx">another</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}));</span>
    <span class="p">});</span>
    <span class="nx">monitor_client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;monitor&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">responses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">responses</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;monitor&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;mget&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s1">&#39;{&quot;foo&quot;:&quot;123&quot;,&quot;bar&quot;:&quot;sdflkdfsjk&quot;,&quot;another&quot;:false}&#39;</span><span class="p">,</span> <span class="nx">responses</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
            <span class="nx">monitor_client</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">BLPOP</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;BLPOP&quot;</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="s2">&quot;initial value&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client2</span><span class="p">.</span><span class="nx">BLPOP</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;initial value&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            
            <span class="nx">client</span><span class="p">.</span><span class="nx">rpush</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="s2">&quot;wait for this value&quot;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">client2</span><span class="p">.</span><span class="nx">BLPOP</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;wait for this value&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">());</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">BLPOP_TIMEOUT</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;BLPOP_TIMEOUT&quot;</span><span class="p">;</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>try to BLPOP the list again, which should be empty.  This should timeout and return null.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client2</span><span class="p">.</span><span class="nx">BLPOP</span><span class="p">(</span><span class="s2">&quot;blocking list&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">EXPIRE</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;EXPIRE&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s1">&#39;expiry key&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">EXPIRE</span><span class="p">([</span><span class="s2">&quot;expiry key&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">([</span><span class="s2">&quot;expiry key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">TTL</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;TTL&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">([</span><span class="s2">&quot;ttl key&quot;</span><span class="p">,</span> <span class="s2">&quot;ttl val&quot;</span><span class="p">],</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">expire</span><span class="p">([</span><span class="s2">&quot;ttl key&quot;</span><span class="p">,</span> <span class="s2">&quot;100&quot;</span><span class="p">],</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">TTL</span><span class="p">([</span><span class="s2">&quot;ttl key&quot;</span><span class="p">],</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_number_pos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
    <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">OPTIONAL_CALLBACK</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;OPTIONAL_CALLBACK&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;op_cb1&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;op_cb1&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;op_cb1&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">tests</span><span class="p">.</span><span class="nx">OPTIONAL_CALLBACK_UNDEFINED</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;OPTIONAL_CALLBACK_UNDEFINED&quot;</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">&quot;op_cb2&quot;</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;op_cb2&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;op_cb2&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">require_string</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>TODO - need a better way to test auth, maybe auto-config a local Redis server or something.
Yes, this is the real password.  Please be nice, thanks.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">tests</span><span class="p">.</span><span class="nx">auth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;AUTH&quot;</span><span class="p">,</span> <span class="nx">client4</span><span class="p">,</span> <span class="nx">ready_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">client4</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">9006</span><span class="p">,</span> <span class="s2">&quot;filefish.redistogo.com&quot;</span><span class="p">);</span>
    <span class="nx">client4</span><span class="p">.</span><span class="nx">auth</span><span class="p">(</span><span class="s2">&quot;664b1b6aaf134e1ec281945a8de702a9&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>test auth, then kill the connection so it'll auto-reconnect and auto-re-auth</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">client4</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">ready_count</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ready_count</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client4</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">client4</span><span class="p">.</span><span class="nx">quit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">all_tests</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">tests</span><span class="p">);</span>
<span class="nx">all_start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="nx">test_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nx">run_next_test</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">run_next_test</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">test_name</span> <span class="o">=</span> <span class="nx">all_tests</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">tests</span><span class="p">[</span><span class="nx">test_name</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">print</span><span class="p">(</span><span class="s1">&#39;- \x1b[1m&#39;</span> <span class="o">+</span> <span class="nx">test_name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;\x1b[0m:&#39;</span><span class="p">);</span>
        <span class="nx">cur_start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="nx">test_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">tests</span><span class="p">[</span><span class="nx">test_name</span><span class="p">]();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n  completed \x1b[32m%d\x1b[0m tests in \x1b[33m%d\x1b[0m ms\n&#39;</span><span class="p">,</span> <span class="nx">test_count</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">all_start</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
        <span class="nx">client2</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">start_tests</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Connected to &quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">&quot;, Redis server version &quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">server_info</span><span class="p">.</span><span class="nx">redis_version</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Using reply parser &quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">reply_parser</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

    <span class="nx">run_next_test</span><span class="p">();</span>

    <span class="nx">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Exit immediately on connection failure, which triggers "exit", below, which fails the test</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;client: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">client2</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;client2: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">client3</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;client3: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reconnecting&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;reconnecting: &quot;</span> <span class="o">+</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">params</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;uncaughtException&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Uncaught exception: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">connected</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">ended</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
