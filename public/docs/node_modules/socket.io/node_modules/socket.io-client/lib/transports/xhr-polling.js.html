<!DOCTYPE html>
<html>
<head>
  <title>xhr-polling.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/lib/transports/xhr-polling.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>xhr-polling.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>socket.io
Copyright(c) 2011 LearnBoost <a href="&#109;&#x61;&#105;&#108;&#x74;&#111;:&#x64;e&#118;&#x40;&#x6C;&#x65;&#97;&#x72;&#x6E;&#98;o&#x6F;&#x73;&#116;.&#99;&#111;&#109;">&#x64;e&#118;&#x40;&#x6C;&#x65;&#97;&#x72;&#x6E;&#98;o&#x6F;&#x73;&#116;.&#99;&#111;&#109;</a>
MIT Licensed</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">global</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Expose constructor.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">exports</span><span class="p">[</span><span class="s1">&#39;xhr-polling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">XHRPolling</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>The XHR-polling transport uses long polling XHR requests to create a
"persistent" connection with the server.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">XHRPolling</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Inherits from XHR transport.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">io</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span><span class="nx">XHRPolling</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">XHR</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Merge the properties from XHR transport</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">io</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">XHRPolling</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">XHR</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Transport name</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;xhr-polling&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Indicates whether heartbeats is enabled for this transport</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">heartbeats</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Establish a connection, for iPhone and Android this will be done once the page
is loaded.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Starts a XHR request to wait for incoming messages.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">empty</span> <span class="p">()</span> <span class="p">{};</span>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">stateChange</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">onload</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">onerror</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">XDomainRequest</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="k">instanceof</span> <span class="nx">XDomainRequest</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">onload</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">stateChange</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Handle the unclean close behavior.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Webkit based browsers show a infinit spinner when you start a XHR request
before the browsers onload event is called so we need to defer opening of
the transport until the onload event is called. Wrapping the cb in our
defer method solve this.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">socket</span>
      <span class="dox_type">Socket</span>
      <span>The socket instance that needs a transport</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fn</span>
      <span class="dox_type">Function</span>
      <span>The callback</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">XHRPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">io</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Add the transport to your public io.transports array.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">io</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;xhr-polling&#39;</span><span class="p">);</span>

<span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">io</span> <span class="o">?</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Transport</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span>
  <span class="p">,</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">io</span> <span class="o">?</span> <span class="nx">io</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
  <span class="p">,</span> <span class="k">this</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
