<!DOCTYPE html>
<html>
<head>
  <title>TLSEngine.as</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../../../../../../doc-style.css" />
  <script src="../../../../../../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/lib/vendor/web-socket-js/flash-src/com/hurlant/crypto/tls/TLSEngine.as", defaultSidebar = true;
  </script>
  <script src="../../../../../../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>TLSEngine.as</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>*
* TLSEngine
* 
* A TLS protocol implementation.
* See comment below for some details.
* Copyright (c) 2007 Henri Torgemane
* 
* Patched(heavily) by Bobby Parker (<a href='mailto:shortwave@gmail.com'>shortwave@gmail.com</a>)
* 
* See LICENSE.txt for full license information.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">tls</span> <span class="p">{</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">X509Certificate</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">X509CertificateCollection</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">prng</span><span class="p">.</span><span class="nx">Random</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">ArrayUtil</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Hex</span><span class="o">;</span>
  
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nb">Event</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nb">EventDispatcher</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nb">ProgressEvent</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nb">ByteArray</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nb">IDataInput</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nb">IDataOutput</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">setTimeout</span><span class="o">;</span>
  <span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">prng</span><span class="p">.</span><span class="nx">ARC4</span><span class="o">;</span>


  <span class="p">[</span><span class="nb">Event</span><span class="p">(</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;close&quot;</span><span class="o">,</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;flash.events.Event&quot;</span><span class="p">)]</span>
  <span class="p">[</span><span class="nb">Event</span><span class="p">(</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;socketData&quot;</span><span class="o">,</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;flash.events.ProgressEvent&quot;</span><span class="p">)]</span>
  <span class="p">[</span><span class="nb">Event</span><span class="p">(</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;ready&quot;</span><span class="o">,</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;com.hurlant.crypto.tls.TLSEvent&quot;</span><span class="p">)]</span>
  <span class="p">[</span><span class="nb">Event</span><span class="p">(</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="o">,</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;com.hurlant.crypto.tls.TLSEvent&quot;</span><span class="p">)]</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>*
* The heart of the TLS protocol.
* This class can work in server or client mode.
* 
* This doesn't fully implement the TLS protocol.
* 
* Things missing that I'd like to add:
* - support for client-side certificates
* - general code clean-up to make sure we don't have gaping securite holes
* 
* Things that aren't there that I won't add:
* - support for "export" cypher suites (deprecated in later TLS versions)
* - support for "anon" cypher suites (deprecated in later TLS versions)
* 
* Things that I'm unsure about adding later:
* - compression. Compressing encrypted streams is barely worth the CPU cycles.
* - diffie-hellman based key exchange mechanisms. Nifty, but would we miss it?
* 
* @author henri
* </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nx">TLSEngine</span> <span class="kd">extends</span> <span class="nb">EventDispatcher</span> <span class="p">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">SERVER</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">CLIENT</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nx">protocol_version</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>


  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">PROTOCOL_HANDSHAKE</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">22</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">PROTOCOL_ALERT</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">21</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">PROTOCOL_CHANGE_CIPHER_SPEC</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">PROTOCOL_APPLICATION_DATA</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">23</span><span class="o">;</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">STATE_NEW</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// brand new. nothing happened yet</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">STATE_NEGOTIATING</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// we&#39;re figuring out what to use</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">STATE_READY</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// we&#39;re ready for AppData stuff to go over us.</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">STATE_CLOSED</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">// we&#39;re done done.</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_entity</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span> <span class="c1">// SERVER | CLIENT</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_config</span><span class="o">:</span><span class="nx">TLSConfig</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_state</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_securityParameters</span><span class="o">:</span><span class="nx">ISecurityParameters</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_currentReadState</span><span class="o">:</span><span class="nx">IConnectionState</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_currentWriteState</span><span class="o">:</span><span class="nx">IConnectionState</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_pendingReadState</span><span class="o">:</span><span class="nx">IConnectionState</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_pendingWriteState</span><span class="o">:</span><span class="nx">IConnectionState</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_handshakePayloads</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_handshakeRecords</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">;</span> <span class="c1">// For client-side certificate verify </span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_iStream</span><span class="o">:</span><span class="nb">IDataInput</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_oStream</span><span class="o">:</span><span class="nb">IDataOutput</span><span class="o">;</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>temporary store for X509 certs received by this engine.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_store</span><span class="o">:</span><span class="nx">X509CertificateCollection</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>the main certificate received from the other side.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_otherCertificate</span><span class="o">:</span><span class="nx">X509Certificate</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">function</span> <span class="kd">get</span> <span class="nx">peerCertificate</span><span class="p">()</span> <span class="o">:</span> <span class="nx">X509Certificate</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_otherCertificate</span><span class="o">;</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>If this isn't null, we expect this identity to be found in the Cert's Subject CN.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_otherIdentity</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>The client-side cert</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_myCertficate</span><span class="o">:</span><span class="nx">X509Certificate</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>My Identity</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_myIdentity</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>*
* 
* @param config    A TLSConfig instance describing how we're supposed to work
* @param iStream    An input stream to read TLS data from
* @param oStream    An output stream to write TLS data to
* @param otherIdentity  An optional identifier. If set, this will be checked against the Subject CN of the other side's certificate.
* </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">TLSEngine</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="nx">TLSConfig</span><span class="o">,</span> <span class="nx">iStream</span><span class="o">:</span><span class="nb">IDataInput</span><span class="o">,</span> <span class="nx">oStream</span><span class="o">:</span><span class="nb">IDataOutput</span><span class="o">,</span> <span class="nx">otherIdentity</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_entity</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">entity</span><span class="o">;</span>
      <span class="nx">_config</span> <span class="o">=</span> <span class="nx">config</span><span class="o">;</span>
      <span class="nx">_iStream</span> <span class="o">=</span> <span class="nx">iStream</span><span class="o">;</span>
      <span class="nx">_oStream</span> <span class="o">=</span> <span class="nx">oStream</span><span class="o">;</span>
      <span class="nx">_otherIdentity</span> <span class="o">=</span> <span class="nx">otherIdentity</span><span class="o">;</span>
      
      <span class="nx">_state</span> <span class="o">=</span> <span class="nx">STATE_NEW</span><span class="o">;</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Pick the right set of callbacks</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">_entityHandshakeHandlers</span> <span class="o">=</span> <span class="nx">_entity</span> <span class="o">==</span> <span class="nx">CLIENT</span> <span class="o">?</span> <span class="nx">handshakeHandlersClient</span> <span class="o">:</span> <span class="nx">handshakeHandlersServer</span><span class="o">;</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>setting up new security parameters needs to be controlled by...something.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">SSLSecurityParameters</span><span class="p">.</span><span class="nx">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_securityParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SSLSecurityParameters</span><span class="p">(</span><span class="nx">_entity</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">_securityParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TLSSecurityParameters</span><span class="p">(</span><span class="nx">_entity</span><span class="o">,</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">certificate</span><span class="o">,</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">privateKey</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">protocol_version</span> <span class="o">=</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">version</span><span class="o">;</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>So this...why is it here, other than to preclude a possible null pointer situation?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">states</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">getConnectionStates</span><span class="p">();</span>
      
      <span class="nx">_currentReadState</span> <span class="o">=</span> <span class="nx">states</span><span class="p">.</span><span class="nx">read</span><span class="o">;</span>
      <span class="nx">_currentWriteState</span> <span class="o">=</span> <span class="nx">states</span><span class="p">.</span><span class="nx">write</span><span class="o">;</span>
      
      <span class="nx">_handshakePayloads</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      
      <span class="nx">_store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X509CertificateCollection</span><span class="o">;</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>*
* This starts the TLS negotiation for a TLS Client.
* 
* This is a no-op for a TLS Server.
* </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_entity</span> <span class="o">==</span> <span class="nx">CLIENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">startHandshake</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="nx">TLSError</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">handleTLSError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">dataAvailable</span><span class="p">(</span><span class="nx">e</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span> <span class="o">==</span> <span class="nx">STATE_CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// ignore</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">parseRecord</span><span class="p">(</span><span class="nx">_iStream</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="nx">TLSError</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handleTLSError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">close</span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="nx">TLSError</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span> <span class="o">==</span> <span class="nx">STATE_CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// ignore</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>ok. send an Alert to let the peer know</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="o">==</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">_state</span> <span class="o">!=</span> <span class="nx">STATE_READY</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>use canceled while handshaking. be nice about it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nx">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">user_canceled</span><span class="o">;</span>
        <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_ALERT</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">close_notify</span><span class="o">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">errorID</span><span class="o">;</span>
        <span class="nf">trace</span><span class="p">(</span><span class="s2">&quot;TLSEngine shutdown triggered by &quot;</span><span class="o">+</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_ALERT</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
      
      <span class="nx">_state</span> <span class="o">=</span> <span class="nx">STATE_CLOSED</span><span class="o">;</span>
      <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nb">Event</span><span class="p">(</span><span class="nb">Event</span><span class="p">.</span><span class="nx">CLOSE</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_packetQueue</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseRecord</span><span class="p">(</span><span class="nx">stream</span><span class="o">:</span><span class="nb">IDataInput</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">;</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">_state</span><span class="o">!=</span><span class="nx">STATE_CLOSED</span> <span class="o">&amp;&amp;</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">bytesAvailable</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">_packetQueue</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">var</span> <span class="nx">packet</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">_packetQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
          <span class="nx">p</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="o">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">bytesAvailable</span><span class="o">+</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>we have a whole packet. put together.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">stream</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">parseOneRecord</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="o">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">p</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>do another loop to parse any leftover record</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">continue</span><span class="o">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>not enough. grab the data and park it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">stream</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">bytesAvailable</span><span class="p">);</span>
            <span class="nx">_packetQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
            <span class="k">continue</span><span class="o">;</span>
          <span class="p">}</span>
        <span class="p">}</span>


        <span class="k">var</span> <span class="nx">type</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
        <span class="k">var</span> <span class="nx">ver</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
        <span class="k">var</span> <span class="nx">length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">16384</span><span class="o">+</span><span class="mi">2048</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// support compression and encryption overhead.</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Excessive TLS Record length: &quot;</span><span class="o">+</span><span class="nx">length</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">record_overflow</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Can pretty much assume that if I'm here, I've got a default config, so let's use it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ver</span> <span class="o">!=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Unsupported TLS version: &quot;</span><span class="o">+</span><span class="nx">ver</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">protocol_version</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="k">var</span> <span class="nx">actualLength</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">bytesAvailable</span><span class="o">,</span> <span class="nx">length</span><span class="p">);</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">actualLength</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">actualLength</span> <span class="o">==</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">parseOneRecord</span><span class="p">(</span><span class="nx">type</span><span class="o">,</span> <span class="nx">length</span><span class="o">,</span> <span class="nx">p</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_packetQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="nx">type</span><span class="o">,</span> <span class="nx">length</span><span class="o">:</span><span class="nx">length</span><span class="o">,</span> <span class="nx">data</span><span class="o">:</span><span class="nx">p</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Protocol handler map, provides a mapping of protocol types to individual packet handlers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">protocolHandlers</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">23</span> <span class="o">:</span> <span class="nx">parseApplicationData</span><span class="o">,</span> <span class="c1">// PROTOCOL_APPLICATION_DATA</span>
                        <span class="mi">22</span> <span class="o">:</span> <span class="nx">parseHandshake</span><span class="o">,</span> <span class="c1">// PROTOCOL_HANDSHAKE</span>
                        <span class="mi">21</span> <span class="o">:</span> <span class="nx">parseAlert</span><span class="o">,</span> <span class="c1">// PROTOCOL_ALERT</span>
                        <span class="mi">20</span> <span class="o">:</span> <span class="nx">parseChangeCipherSpec</span> <span class="p">};</span> <span class="c1">// PROTOCOL_CHANGE_CIPHER_SPEC</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>*
* Modified to support the notion of a handler map(see above ), since it makes for better clarity (IMHO of course).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseOneRecord</span><span class="p">(</span><span class="nx">type</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">length</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">_currentReadState</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">type</span><span class="o">,</span> <span class="nx">length</span><span class="o">,</span> <span class="nx">p</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">16384</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Excessive Decrypted TLS Record length: &quot;</span><span class="o">+</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">record_overflow</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">protocolHandlers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="nx">type</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nx">p</span> <span class="o">=</span> <span class="nx">protocolHandlers</span><span class="p">[</span> <span class="nx">type</span> <span class="p">](</span> <span class="nx">p</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Unsupported TLS Record Content Type: &quot;</span><span class="o">+</span><span class="nx">type</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span> <span class="mi">16</span> <span class="p">)</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">unexpected_message</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>/////// handshake handling
session identifier
peer certificate
compression method
cipher spec
master secret
is resumable</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_HELLO_REQUEST</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_CLIENT_HELLO</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_SERVER_HELLO</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_CERTIFICATE</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">11</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_SERVER_KEY_EXCHANGE</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_CERTIFICATE_REQUEST</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">13</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_HELLO_DONE</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">14</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_CERTIFICATE_VERIFY</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_CLIENT_KEY_EXCHANGE</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">const</span> <span class="nx">HANDSHAKE_FINISHED</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Server handshake handler map</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">handshakeHandlersServer</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_HELLO_REQUEST</span>
                             <span class="mi">1</span> <span class="o">:</span> <span class="nx">parseHandshakeClientHello</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CLIENT_HELLO</span>
                             <span class="mi">2</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_SERVER_HELLO </span>
                             <span class="mi">11</span> <span class="o">:</span> <span class="nx">loadCertificates</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE</span>
                             <span class="mi">12</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_SERVER_KEY_EXCHANGE</span>
                             <span class="mi">13</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE_REQUEST</span>
                             <span class="mi">14</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_HELLO_DONE</span>
                             <span class="mi">15</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE_VERIFY</span>
                             <span class="mi">16</span> <span class="o">:</span> <span class="nx">parseHandshakeClientKeyExchange</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CLIENT_KEY_EXCHANGE</span>
                             <span class="mi">20</span> <span class="o">:</span> <span class="nx">verifyHandshake</span> <span class="c1">// HANDSHAKE_FINISHED                            </span>
                            <span class="p">};</span>
                            

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Client handshake handler map                                        </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">handshakeHandlersClient</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">parseHandshakeHello</span><span class="o">,</span> <span class="c1">// HANDSHAKE_HELLO_REQUEST</span>
                             <span class="mi">1</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CLIENT_HELLO</span>
                             <span class="mi">2</span> <span class="o">:</span> <span class="nx">parseHandshakeServerHello</span><span class="o">,</span> <span class="c1">// HANDSHAKE_SERVER_HELLO</span>
                             <span class="mi">11</span> <span class="o">:</span> <span class="nx">loadCertificates</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE</span>
                             <span class="mi">12</span> <span class="o">:</span> <span class="nx">parseServerKeyExchange</span><span class="o">,</span> <span class="c1">// HANDSHAKE_SERVER_KEY_EXCHANGE</span>
                             <span class="mi">13</span> <span class="o">:</span> <span class="nx">setStateRespondWithCertificate</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE</span>
                             <span class="mi">14</span> <span class="o">:</span> <span class="nx">sendClientAck</span><span class="o">,</span> <span class="c1">// HANDSHAKE_HELLO_DONE  </span>
                             <span class="mi">15</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CERTIFICATE_VERIFY</span>
                             <span class="mi">16</span> <span class="o">:</span> <span class="nx">notifyStateError</span><span class="o">,</span> <span class="c1">// HANDSHAKE_CLIENT_KEY_EXCHANGE</span>
                             <span class="mi">20</span> <span class="o">:</span> <span class="nx">verifyHandshake</span> <span class="c1">// HANDSHAKE_FINISHED</span>
                            <span class="p">};</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_entityHandshakeHandlers</span><span class="o">:</span><span class="nb">Object</span><span class="o">;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_handshakeCanContinue</span><span class="o">:</span><span class="nb">Boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// For handling cases where I might need to pause processing during a handshake (cert issues, etc.).</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_handshakeQueue</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>*
* The handshake is always started by the client.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">startHandshake</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="nx">_state</span> <span class="o">=</span> <span class="nx">STATE_NEGOTIATING</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>reset some other handshake state. XXX</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">sendClientHello</span><span class="p">();</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>*
* Handle the incoming handshake packet.
* </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseHandshake</span><span class="p">(</span><span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">{</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">trace</span><span class="p">(</span><span class="s2">&quot;Handshake packet is way too short. bailing.&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="p">}</span>

      <span class="nx">p</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="nx">p</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">type</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readUnsignedByte</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">tmp</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readUnsignedByte</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tmp</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readUnsignedShort</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>partial read.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nf">trace</span><span class="p">(</span><span class="s2">&quot;Handshake packet is incomplete. bailing.&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>we need to copy the record, to have a valid FINISHED exchange.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span><span class="o">!=</span><span class="nx">HANDSHAKE_FINISHED</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">_handshakePayloads</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
      <span class="p">}</span> 
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Surf the handler map and find the right handler for this handshake packet type. 
I modified the individual handlers so they encapsulate all possible knowledge 
about the incoming packet type, so no previous handling or massaging of the data 
is required, as was the case using the switch statement. BP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_entityHandshakeHandlers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="nx">type</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_entityHandshakeHandlers</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="nx">is</span> <span class="nb">Function</span><span class="p">)</span> 
          <span class="nx">_entityHandshakeHandlers</span><span class="p">[</span> <span class="nx">type</span> <span class="p">](</span> <span class="nx">rec</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span> <span class="s2">&quot;Unimplemented or unknown handshake type!&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span> <span class="p">);</span>
      <span class="p">}</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Get set up for the next packet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="o">&lt;</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nx">n</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span><span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="o">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="p">(</span><span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">n</span><span class="o">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>*
* Throw an error when the detected handshake state isn't a valid state for the given entity type (client vs. server, etc. ).
* This really should abort the handshake, since there's no case in which a server should EVER be confused about the type of entity it is. BP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">notifyStateError</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span> <span class="s2">&quot;Invalid handshake state for a TLS Entity type of &quot;</span> <span class="o">+</span> <span class="nx">_entity</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span> <span class="p">);</span> 
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>*
* two unimplemented functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseClientKeyExchange</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span> <span class="s2">&quot;ClientKeyExchange is currently unimplemented!&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span> <span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseServerKeyExchange</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span> <span class="s2">&quot;ServerKeyExchange is currently unimplemented!&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span> <span class="p">);</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>*
* Test the server's Finished message for validity against the data we know about. Only slightly rewritten. BP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">verifyHandshake</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Get the Finished message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">verifyData</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>This, in the vain hope that noboby is using SSL 2 anymore</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">SSLSecurityParameters</span><span class="p">.</span><span class="nx">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">verifyData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">36</span><span class="p">);</span> <span class="c1">// length should be (in fact, better be) 16 + 20 (md5-size + sha1-size)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// presuming TLS</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">verifyData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">12</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">computeVerifyData</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nx">_entity</span><span class="o">,</span> <span class="nx">_handshakePayloads</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">ArrayUtil</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">verifyData</span><span class="o">,</span> <span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">_state</span> <span class="o">=</span> <span class="nx">STATE_READY</span><span class="o">;</span>
        <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">TLSEvent</span><span class="p">(</span><span class="nx">TLSEvent</span><span class="p">.</span><span class="nx">READY</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Invalid Finished mac.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">bad_record_mac</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>enforceClient/enforceServer removed in favor of state-driven function maps</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>*
* Handle a HANDSHAKE_HELLO</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseHandshakeHello</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span> <span class="o">!=</span> <span class="nx">STATE_READY</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">trace</span><span class="p">(</span><span class="s2">&quot;Received an HELLO_REQUEST before being in state READY. ignoring.&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="p">}</span>
      <span class="nx">_handshakePayloads</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">startHandshake</span><span class="p">();</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>*
* Handle a HANDSHAKE_CLIENT_KEY_EXCHANGE</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseHandshakeClientKeyExchange</span><span class="p">(</span><span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">useRSA</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>skip 2 bytes for length.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">var</span> <span class="nx">len</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
        <span class="k">var</span> <span class="nx">cipher</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">cipher</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">len</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">preMasterSecret</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">_config</span><span class="p">.</span><span class="nx">privateKey</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">cipher</span><span class="o">,</span> <span class="nx">preMasterSecret</span><span class="o">,</span> <span class="nx">len</span><span class="p">);</span>
        <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setPreMasterSecret</span><span class="p">(</span><span class="nx">preMasterSecret</span><span class="p">);</span>
        

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>now is a good time to get our pending states</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">var</span> <span class="nx">o</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">getConnectionStates</span><span class="p">();</span>
        <span class="nx">_pendingReadState</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">read</span><span class="o">;</span>
        <span class="nx">_pendingWriteState</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">write</span><span class="o">;</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;parseHandshakeClientKeyExchange not implemented for DH modes.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span><span class="p">);</span>
      <span class="p">}</span>
      
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<ul>
<li>
<ul><li>Handle HANDSHAKE_SERVER_HELLO - client-side</li></ul></li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseHandshakeServerHello</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">IDataInput</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      
      <span class="k">var</span> <span class="nx">ver</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nx">ver</span> <span class="o">!=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Unsupported TLS version: &quot;</span><span class="o">+</span><span class="nx">ver</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">protocol_version</span><span class="p">);</span>
      <span class="p">}</span>     
      <span class="k">var</span> <span class="nx">random</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">random</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>
      <span class="k">var</span> <span class="nx">session_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">session</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">session_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>some implementations don't assign a session ID</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">session</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">session_length</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setCipher</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">());</span> 
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setCompression</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">());</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setServerRandom</span><span class="p">(</span><span class="nx">random</span><span class="p">);</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>*
*  Handle HANDSHAKE_CLIENT_HELLO - server side</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseHandshakeClientHello</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">IDataInput</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">ret</span><span class="o">:</span><span class="nb">Object</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">ver</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nx">ver</span> <span class="o">!=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Unsupported TLS version: &quot;</span><span class="o">+</span><span class="nx">ver</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">protocol_version</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">var</span> <span class="nx">random</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">random</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>
      <span class="k">var</span> <span class="nx">session_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">session</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">session_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>some implementations don't assign a session ID</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">session</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">session_length</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">var</span> <span class="nx">suites</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="k">var</span> <span class="nx">suites_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">uint</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">suites_length</span><span class="o">/</span><span class="mi">2</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">suites</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">());</span>
      <span class="p">}</span>
    
      <span class="k">var</span> <span class="nx">compressions</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="k">var</span> <span class="nx">comp_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">comp_length</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compressions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">random</span><span class="o">:</span><span class="nx">random</span><span class="o">,</span> <span class="nx">session</span><span class="o">:</span><span class="nx">session</span><span class="o">,</span> <span class="nx">suites</span><span class="o">:</span><span class="nx">suites</span><span class="o">,</span> <span class="nx">compressions</span><span class="o">:</span><span class="nx">compressions</span><span class="p">};</span>
      
      <span class="k">var</span> <span class="nx">sofar</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">32</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">session_length</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="nx">suites_length</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">comp_length</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">extensions</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sofar</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>we have extensions. great.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">var</span> <span class="nx">ext_total_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">ext_total_length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">var</span> <span class="nx">ext_type</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
          <span class="k">var</span> <span class="nx">ext_length</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
          <span class="k">var</span> <span class="nx">ext_data</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
          <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">ext_data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">ext_length</span><span class="p">);</span>
          <span class="nx">ext_total_length</span> <span class="o">-=</span> <span class="mi">4</span><span class="o">+</span><span class="nx">ext_length</span><span class="o">;</span>
          <span class="nx">extensions</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="nx">ext_type</span><span class="o">,</span> <span class="nx">length</span><span class="o">:</span><span class="nx">ext_length</span><span class="o">,</span> <span class="nx">data</span><span class="o">:</span><span class="nx">ext_data</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">ret</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="nx">extensions</span><span class="o">;</span>
      
      <span class="nx">sendServerHello</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
      <span class="nx">sendCertificate</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>TODO: Modify to handle case of requesting a certificate from the client, for "client authentication", 
and testing purposes, will probably never actually need it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">sendServerHelloDone</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendClientHello</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>version - modified to support version attribute from ISecurityParameters</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>random</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">prng</span><span class="o">:</span><span class="nx">Random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">clientRandom</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">prng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">clientRandom</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setClientRandom</span><span class="p">(</span><span class="nx">clientRandom</span><span class="p">);</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">clientRandom</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">32</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
      <span class="nx">prng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">rec</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Cipher suites</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">cs</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">cipherSuites</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">cs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Compression</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">cs</span> <span class="o">=</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">compressions</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">cs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>no extensions, yet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_CLIENT_HELLO</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">findMatch</span><span class="p">(</span><span class="nx">a1</span><span class="o">:</span><span class="nb">Array</span><span class="o">,</span> <span class="nx">a2</span><span class="o">:</span><span class="nb">Array</span><span class="p">)</span><span class="o">:</span><span class="nb">int</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">a1</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nx">e</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">a1</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">a2</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">e</span><span class="o">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendServerHello</span><span class="p">(</span><span class="nx">v</span><span class="o">:</span><span class="nb">Object</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">cipher</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">findMatch</span><span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">cipherSuites</span><span class="o">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">suites</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cipher</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;No compatible cipher found.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">handshake_failure</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setCipher</span><span class="p">(</span><span class="nx">cipher</span><span class="p">);</span>
      
      <span class="k">var</span> <span class="nx">comp</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">findMatch</span><span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">compressions</span><span class="o">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">compressions</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span> <span class="o">==</span> <span class="mi">01</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;No compatible compression method found.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">handshake_failure</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setCompression</span><span class="p">(</span><span class="nx">comp</span><span class="p">);</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setClientRandom</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">random</span><span class="p">);</span>


      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
      <span class="k">var</span> <span class="nx">prng</span><span class="o">:</span><span class="nx">Random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">serverRandom</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">prng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">serverRandom</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>
      <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setServerRandom</span><span class="p">(</span><span class="nx">serverRandom</span><span class="p">);</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">serverRandom</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">32</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
      <span class="nx">prng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">rec</span><span class="o">,</span> <span class="mi">32</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Cipher suite</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">suites</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Compression</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">compressions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_SERVER_HELLO</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">sendClientCert</span><span class="o">:</span><span class="nb">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">setStateRespondWithCertificate</span><span class="p">(</span> <span class="nx">r</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="nx">sendClientCert</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendCertificate</span><span class="p">(</span> <span class="nx">r</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">cert</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">certificate</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">len</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">len2</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Look for a certficate chain, if we have one, send it, if we don't, send an empty record.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cert</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">cert</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span>
        <span class="nx">len2</span> <span class="o">=</span> <span class="nx">cert</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">len2</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">len2</span><span class="o">&amp;</span><span class="mi">65535</span><span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">len</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">len</span><span class="o">&amp;</span><span class="mi">65535</span><span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">cert</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_CERTIFICATE</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendCertificateVerify</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Encrypt the handshake payloads here</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">computeCertificateVerify</span><span class="p">(</span><span class="nx">_entity</span><span class="o">,</span> <span class="nx">_handshakePayloads</span><span class="p">);</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">position</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_CERTIFICATE_VERIFY</span><span class="o">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendServerHelloDone</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_HELLO_DONE</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendClientKeyExchange</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">useRSA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">prng</span><span class="o">:</span><span class="nx">Random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span><span class="o">;</span>
        <span class="nx">prng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="mi">46</span><span class="p">);</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">var</span> <span class="nx">preMasterSecret</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">preMasterSecret</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">p</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">preMasterSecret</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">setPreMasterSecret</span><span class="p">(</span><span class="nx">preMasterSecret</span><span class="p">);</span>
              
        <span class="k">var</span> <span class="nx">enc_key</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">_otherCertificate</span><span class="p">.</span><span class="nx">getPublicKey</span><span class="p">().</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">preMasterSecret</span><span class="o">,</span> <span class="nx">enc_key</span><span class="o">,</span> <span class="nx">preMasterSecret</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> 
        
        <span class="nx">enc_key</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>TLS requires the size of the premaster key be sent BUT
SSL 3.0 does not</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="p">{</span> 
          <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">enc_key</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">enc_key</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">enc_key</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        
        <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        
        <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_CLIENT_KEY_EXCHANGE</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
        

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>now is a good time to get our pending states</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">var</span> <span class="nx">o</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">getConnectionStates</span><span class="p">();</span>
        <span class="nx">_pendingReadState</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">read</span><span class="o">;</span>
        <span class="nx">_pendingWriteState</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">write</span><span class="o">;</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Non-RSA Client Key Exchange not implemented.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">internal_error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendFinished</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">computeVerifyData</span><span class="p">(</span><span class="nx">_entity</span><span class="o">,</span> <span class="nx">_handshakePayloads</span><span class="p">);</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">position</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">HANDSHAKE_FINISHED</span><span class="o">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendHandshake</span><span class="p">(</span><span class="nx">type</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">len</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">payload</span><span class="o">:</span><span class="nb">IDataInput</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
      <span class="nx">payload</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">rec</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span><span class="o">,</span> <span class="nx">len</span><span class="p">);</span>
      <span class="nx">_handshakePayloads</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">rec</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_HANDSHAKE</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendChangeCipherSpec</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_CHANGE_CIPHER_SPEC</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>right after, switch the cipher for writing.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">_currentWriteState</span> <span class="o">=</span> <span class="nx">_pendingWriteState</span><span class="o">;</span>
      <span class="nx">_pendingWriteState</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">sendApplicationData</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">,</span> <span class="nx">offset</span><span class="o">:</span><span class="nb">uint</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="nx">length</span><span class="o">:</span><span class="nb">uint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">len</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">length</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>BIG FAT WARNING: Patch from Arlen Cuss ALA As3crypto group on Google code. 
This addresses data overflow issues when the packet size hits the max length boundary.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span>  
      <span class="k">while</span> <span class="p">(</span><span class="nx">len</span><span class="o">&gt;</span><span class="mi">16384</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">data</span><span class="o">,</span> <span class="nx">offset</span><span class="o">,</span> <span class="mi">16384</span><span class="p">);</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_APPLICATION_DATA</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
        <span class="nx">offset</span> <span class="o">+=</span> <span class="mi">16384</span><span class="o">;</span>
        <span class="nx">len</span> <span class="o">-=</span> <span class="mi">16384</span><span class="o">;</span>
      <span class="p">}</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">data</span><span class="o">,</span> <span class="nx">offset</span><span class="o">,</span> <span class="nx">len</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>trace("Data I'm sending..." + Hex.fromArray( data ));</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">rec</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">PROTOCOL_APPLICATION_DATA</span><span class="o">,</span> <span class="nx">rec</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendRecord</span><span class="p">(</span><span class="nx">type</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">payload</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>encrypt</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">payload</span> <span class="o">=</span> <span class="nx">_currentWriteState</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">type</span><span class="o">,</span> <span class="nx">payload</span><span class="p">);</span>
      
      <span class="nx">_oStream</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
      <span class="nx">_oStream</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">_securityParameters</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
      <span class="nx">_oStream</span><span class="p">.</span><span class="nx">writeShort</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="nx">_oStream</span><span class="p">.</span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">payload</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      
      <span class="nx">scheduleWrite</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nx">_writeScheduler</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">scheduleWrite</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_writeScheduler</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="o">;</span>
      <span class="nx">_writeScheduler</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">commitWrite</span><span class="o">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">commitWrite</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">_writeScheduler</span><span class="p">);</span>
      <span class="nx">_writeScheduler</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span> <span class="o">!=</span> <span class="nx">STATE_CLOSED</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nb">ProgressEvent</span><span class="p">(</span><span class="nb">ProgressEvent</span><span class="p">.</span><span class="nx">SOCKET_DATA</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">sendClientAck</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">_handshakeCanContinue</span> <span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>If I have a pending cert request, send it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sendClientCert</span><span class="p">)</span>
          <span class="nx">sendCertificate</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>send a client key exchange</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">sendClientKeyExchange</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Send the certificate verify, if we have one</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">certificate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nx">sendCertificateVerify</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>send a change cipher spec</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">sendChangeCipherSpec</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>send a finished</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">sendFinished</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>*
* Vaguely gross function that parses a RSA key out of a certificate.
* 
* As long as that certificate looks just the way we expect it to.
* </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">loadCertificates</span><span class="p">(</span> <span class="nx">rec</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">tmp</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">certs_len</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tmp</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
      <span class="k">var</span> <span class="nx">certs</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="k">while</span> <span class="p">(</span><span class="nx">certs_len</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readByte</span><span class="p">();</span>
        <span class="k">var</span> <span class="nx">cert_len</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tmp</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">readShort</span><span class="p">();</span>
        <span class="k">var</span> <span class="nx">cert</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="o">;</span>
        <span class="nx">rec</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">cert</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">cert_len</span><span class="p">);</span>
        <span class="nx">certs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cert</span><span class="p">);</span>
        <span class="nx">certs_len</span> <span class="o">-=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nx">cert_len</span><span class="o">;</span>
      <span class="p">}</span>
      
      <span class="k">var</span> <span class="nx">firstCert</span><span class="o">:</span><span class="nx">X509Certificate</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">certs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nx">x509</span><span class="o">:</span><span class="nx">X509Certificate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X509Certificate</span><span class="p">(</span><span class="nx">certs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">_store</span><span class="p">.</span><span class="nx">addCertificate</span><span class="p">(</span><span class="nx">x509</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">firstCert</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">firstCert</span> <span class="o">=</span> <span class="nx">x509</span><span class="o">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Test first for trust override parameters
This nice trust override stuff comes from Joey Parrish via As3crypto forums</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">var</span> <span class="nx">certTrusted</span><span class="o">:</span><span class="nb">Boolean</span><span class="o">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">trustAllCertificates</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">certTrusted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Blatantly trust everything</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">trustSelfSignedCertificates</span> <span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Self-signed certs</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">certTrusted</span> <span class="o">=</span> <span class="nx">firstCert</span><span class="p">.</span><span class="nx">isSelfSigned</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">);</span> 
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>Certs with a signer in the CA store - realistically, I should setup an event chain to handle this</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">certTrusted</span> <span class="o">=</span> <span class="nx">firstCert</span><span class="p">.</span><span class="nx">isSigned</span><span class="p">(</span><span class="nx">_store</span><span class="o">,</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">CAStore</span> <span class="p">);</span>
      <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>Good so far</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">certTrusted</span><span class="p">)</span> <span class="p">{</span>              

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>ok, that's encouraging. now for the hostname match.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_otherIdentity</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="nx">_config</span><span class="p">.</span><span class="nx">ignoreCommonNameMismatch</span> <span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>we don't care who we're talking with. groovy.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">_otherCertificate</span> <span class="o">=</span> <span class="nx">firstCert</span><span class="o">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>use regex to handle wildcard certs</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">var</span> <span class="nx">commonName</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">firstCert</span><span class="p">.</span><span class="nx">getCommonName</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>replace all regex special characters with escaped version, except for asterisk
replace the asterisk with a regex sequence to match one or more non-dot characters</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">var</span> <span class="nx">commonNameRegex</span><span class="o">:</span><span class="nb">RegExp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span> <span class="nx">commonName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\^\\\-$.[\]|()?+{}]/g</span><span class="o">,</span> <span class="s2">&quot;\\$&amp;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="o">,</span> <span class="s2">&quot;[^.]+&quot;</span><span class="p">)</span><span class="o">,</span> <span class="s2">&quot;gi&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">commonNameRegex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">_otherIdentity</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_otherCertificate</span> <span class="o">=</span> <span class="nx">firstCert</span><span class="o">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">promptUserForAcceptCert</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">_handshakeCanContinue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
              <span class="nx">dispatchEvent</span><span class="p">(</span> <span class="k">new</span> <span class="nx">TLSEvent</span><span class="p">(</span> <span class="nx">TLSEvent</span><span class="p">.</span><span class="nx">PROMPT_ACCEPT_CERT</span> <span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Invalid common name: &quot;</span><span class="o">+</span><span class="nx">firstCert</span><span class="p">.</span><span class="nx">getCommonName</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;, expected &quot;</span><span class="o">+</span><span class="nx">_otherIdentity</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">bad_certificate</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Let's ask the user if we can accept this cert. I'm not certain of the behaviour in case of timeouts, 
so I probably need to handle the case by killing and restarting the connection rather than continuing if it becomes 
an issue. We shall see. BP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_config</span><span class="p">.</span><span class="nx">promptUserForAcceptCert</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_handshakeCanContinue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="nx">dispatchEvent</span><span class="p">(</span> <span class="k">new</span> <span class="nx">TLSEvent</span><span class="p">(</span> <span class="nx">TLSEvent</span><span class="p">.</span><span class="nx">PROMPT_ACCEPT_CERT</span> <span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Cannot continue, die.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Cannot verify certificate&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">bad_certificate</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>Accept the peer cert, and keep going</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">acceptPeerCertificate</span><span class="p">()</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="nx">_handshakeCanContinue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="nx">sendClientAck</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
    <span class="p">}</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Step off biotch! No trust for you!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">public</span> <span class="kd">function</span> <span class="nx">rejectPeerCertificate</span><span class="p">()</span> <span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Peer certificate not accepted!&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">bad_certificate</span><span class="p">);</span>
    <span class="p">}</span>
    
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseAlert</span><span class="p">(</span><span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>throw new Error("Alert not implemented.");
7.2</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nf">trace</span><span class="p">(</span><span class="s2">&quot;GOT ALERT! type=&quot;</span><span class="o">+</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseChangeCipherSpec</span><span class="p">(</span><span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">readUnsignedByte</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_pendingReadState</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Not ready to Change Cipher Spec, damnit.&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">unexpected_message</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">_currentReadState</span> <span class="o">=</span> <span class="nx">_pendingReadState</span><span class="o">;</span>
      <span class="nx">_pendingReadState</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>7.1</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">parseApplicationData</span><span class="p">(</span><span class="nx">p</span><span class="o">:</span><span class="nb">ByteArray</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span> <span class="o">!=</span> <span class="nx">STATE_READY</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TLSError</span><span class="p">(</span><span class="s2">&quot;Too soon for data!&quot;</span><span class="o">,</span> <span class="nx">TLSError</span><span class="p">.</span><span class="nx">unexpected_message</span><span class="p">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="p">}</span>
      <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">TLSEvent</span><span class="p">(</span><span class="nx">TLSEvent</span><span class="p">.</span><span class="nx">DATA</span><span class="o">,</span> <span class="nx">p</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">function</span> <span class="nx">handleTLSError</span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="nx">TLSError</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>basic rules to keep things simple:
- Make a good faith attempt at notifying peers
- TLSErrors are always fatal.
BP: Meh...not always. Common Name mismatches appear to be common on servers. Instead of closing, let's pause, and ask for confirmation 
before we tear the connection down.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      
      <span class="nx">close</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
