<!DOCTYPE html>
<html>
<head>
  <title>WebSocket.as</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../../doc-style.css" />
  <script src="../../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/lib/vendor/web-socket-js/flash-src/WebSocket.as", defaultSidebar = true;
  </script>
  <script src="../../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>WebSocket.as</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>Copyright: Hiroshi Ichikawa <a href="http://gimite.net/en/">http://gimite.net/en/</a>
License: New BSD License
Reference: <a href='http://dev.w3.org/html5/websockets/'>http://dev.w3.org/html5/websockets/</a>
Reference: <a href='http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76'>http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">package</span> <span class="p">{</span>

<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">adobe</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">proxies</span><span class="p">.</span><span class="nx">RFC2817Socket</span><span class="o">;</span>
<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">gsolo</span><span class="p">.</span><span class="nx">encryption</span><span class="p">.</span><span class="nx">MD5</span><span class="o">;</span>
<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">TLSConfig</span><span class="o">;</span>
<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">TLSEngine</span><span class="o">;</span>
<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">TLSSecurityParameters</span><span class="o">;</span>
<span class="kd">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">hurlant</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">TLSSocket</span><span class="o">;</span>

<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">external</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="o">*;</span>

<span class="kd">import</span> <span class="nx">mx</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">mx</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">mx</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="o">*;</span>
<span class="kd">import</span> <span class="nx">mx</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="o">*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nx">WebSocket</span> <span class="kd">extends</span> <span class="nb">EventDispatcher</span> <span class="p">{</span>
  
  <span class="kd">private</span> <span class="kd">static</span> <span class="k">var</span> <span class="nx">CONNECTING</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="k">var</span> <span class="nx">OPEN</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="k">var</span> <span class="nx">CLOSING</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="k">var</span> <span class="nx">CLOSED</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
  
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">id</span><span class="o">:</span><span class="nb">int</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">rawSocket</span><span class="o">:</span><span class="nb">Socket</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">tlsSocket</span><span class="o">:</span><span class="nx">TLSSocket</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">tlsConfig</span><span class="o">:</span><span class="nx">TLSConfig</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">socket</span><span class="o">:</span><span class="nb">Socket</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">url</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">scheme</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">host</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">port</span><span class="o">:</span><span class="nb">uint</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">path</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">origin</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">requestedProtocols</span><span class="o">:</span><span class="nb">Array</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">acceptedProtocol</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">buffer</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="p">();</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">headerState</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">readyState</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">CONNECTING</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">cookie</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">headers</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">noiseChars</span><span class="o">:</span><span class="nb">Array</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">expectedDigest</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nx">logger</span><span class="o">:</span><span class="nx">IWebSocketLogger</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">WebSocket</span><span class="p">(</span>
      <span class="nx">id</span><span class="o">:</span><span class="nb">int</span><span class="o">,</span> <span class="nx">url</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span> <span class="nx">protocols</span><span class="o">:</span><span class="nb">Array</span><span class="o">,</span> <span class="nx">origin</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span>
      <span class="nx">proxyHost</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span> <span class="nx">proxyPort</span><span class="o">:</span><span class="nb">int</span><span class="o">,</span>
      <span class="nx">cookie</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span> <span class="nx">headers</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span>
      <span class="nx">logger</span><span class="o">:</span><span class="nx">IWebSocketLogger</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="nx">logger</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="o">;</span>
    <span class="nx">initNoiseChars</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">m</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(\w+):\/\/([^\/:]+)(:(\d+))?(\/.*)?(\?.*)?$/</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span> <span class="nx">fatal</span><span class="p">(</span><span class="s2">&quot;SYNTAX_ERR: invalid url: &quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">var</span> <span class="nx">defaultPort</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">||</span> <span class="nx">defaultPort</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requestedProtocols</span> <span class="o">=</span> <span class="nx">protocols</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookie</span><span class="o">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>if present and not the empty string, headers MUST end with \r\n
headers should be zero or more complete lines, for example
"Header1: xxx\r\nHeader2: yyyy\r\n"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">headers</span><span class="o">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">proxyHost</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">proxyPort</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fatal</span><span class="p">(</span><span class="s2">&quot;wss with proxy is not supported&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">var</span> <span class="nx">proxySocket</span><span class="o">:</span><span class="nx">RFC2817Socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RFC2817Socket</span><span class="p">();</span>
      <span class="nx">proxySocket</span><span class="p">.</span><span class="nx">setProxyInfo</span><span class="p">(</span><span class="nx">proxyHost</span><span class="o">,</span> <span class="nx">proxyPort</span><span class="p">);</span>
      <span class="nx">proxySocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">ProgressEvent</span><span class="p">.</span><span class="nx">SOCKET_DATA</span><span class="o">,</span> <span class="nx">onSocketData</span><span class="p">);</span>
      <span class="nx">rawSocket</span> <span class="o">=</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">proxySocket</span><span class="o">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">rawSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Socket</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tlsConfig</span><span class="o">=</span> <span class="k">new</span> <span class="nx">TLSConfig</span><span class="p">(</span><span class="nx">TLSEngine</span><span class="p">.</span><span class="nx">CLIENT</span><span class="o">,</span>
            <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
            <span class="nx">TLSSecurityParameters</span><span class="p">.</span><span class="nx">PROTOCOL_VERSION</span><span class="p">);</span>
        <span class="nx">tlsConfig</span><span class="p">.</span><span class="nx">trustAllCertificates</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="nx">tlsConfig</span><span class="p">.</span><span class="nx">ignoreCommonNameMismatch</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="nx">tlsSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TLSSocket</span><span class="p">();</span>
        <span class="nx">tlsSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">ProgressEvent</span><span class="p">.</span><span class="nx">SOCKET_DATA</span><span class="o">,</span> <span class="nx">onSocketData</span><span class="p">);</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="nx">tlsSocket</span><span class="o">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">ProgressEvent</span><span class="p">.</span><span class="nx">SOCKET_DATA</span><span class="o">,</span> <span class="nx">onSocketData</span><span class="p">);</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="nx">rawSocket</span><span class="o">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">Event</span><span class="p">.</span><span class="nx">CLOSE</span><span class="o">,</span> <span class="nx">onSocketClose</span><span class="p">);</span>
    <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">Event</span><span class="p">.</span><span class="nx">CONNECT</span><span class="o">,</span> <span class="nx">onSocketConnect</span><span class="p">);</span>
    <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">IOErrorEvent</span><span class="p">.</span><span class="nx">IO_ERROR</span><span class="o">,</span> <span class="nx">onSocketIoError</span><span class="p">);</span>
    <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">SecurityErrorEvent</span><span class="p">.</span><span class="nx">SECURITY_ERROR</span><span class="o">,</span> <span class="nx">onSocketSecurityError</span><span class="p">);</span>
    <span class="nx">rawSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">host</span><span class="o">,</span> <span class="nx">port</span><span class="p">);</span>
  <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>*
* @return  This WebSocket's ID.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">getId</span><span class="p">()</span><span class="o">:</span><span class="nb">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">;</span>
  <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>*
* @return this WebSocket's readyState.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">getReadyState</span><span class="p">()</span><span class="o">:</span><span class="nb">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">;</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">getAcceptedProtocol</span><span class="p">()</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">acceptedProtocol</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">send</span><span class="p">(</span><span class="nx">encData</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nb">int</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nf">decodeURIComponent</span><span class="p">(</span><span class="nx">encData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">writeUTFBytes</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;sent: &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">CLOSING</span> <span class="o">||</span> <span class="nx">readyState</span> <span class="o">==</span> <span class="nx">CLOSED</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">bytes</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="p">();</span>
      <span class="nx">bytes</span><span class="p">.</span><span class="nx">writeUTFBytes</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="c1">// not sure whether it should include \x00 and \xff</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fatal</span><span class="p">(</span><span class="s2">&quot;invalid state&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="kd">public</span> <span class="kd">function</span> <span class="nx">close</span><span class="p">(</span><span class="nx">isError</span><span class="o">:</span><span class="nb">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">OPEN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isError</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="o">:</span><span class="nb">Error</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="nx">readyState</span> <span class="o">=</span> <span class="nx">CLOSED</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebSocketEvent</span><span class="p">(</span><span class="nx">isError</span> <span class="o">?</span> <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="s2">&quot;close&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onSocketConnect</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="nb">Event</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;starting SSL/TLS&quot;</span><span class="p">);</span>
      <span class="nx">tlsSocket</span><span class="p">.</span><span class="nx">startTLS</span><span class="p">(</span><span class="nx">rawSocket</span><span class="o">,</span> <span class="nx">host</span><span class="o">,</span> <span class="nx">tlsConfig</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nx">defaultPort</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">hostValue</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">host</span> <span class="o">+</span> <span class="p">(</span><span class="nx">port</span> <span class="o">==</span> <span class="nx">defaultPort</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">key1</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">generateKey</span><span class="p">();</span>
    <span class="k">var</span> <span class="nx">key2</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">generateKey</span><span class="p">();</span>
    <span class="k">var</span> <span class="nx">key3</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">generateKey3</span><span class="p">();</span>
    <span class="nx">expectedDigest</span> <span class="o">=</span> <span class="nx">getSecurityDigest</span><span class="p">(</span><span class="nx">key1</span><span class="o">,</span> <span class="nx">key2</span><span class="o">,</span> <span class="nx">key3</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">opt</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">requestedProtocols</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">opt</span> <span class="o">+=</span> <span class="s2">&quot;Sec-WebSocket-Protocol: &quot;</span> <span class="o">+</span> <span class="nx">requestedProtocols</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="o">;</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>if caller passes additional headers they must end with "\r\n"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="nx">opt</span> <span class="o">+=</span> <span class="nx">headers</span><span class="o">;</span>
    
    <span class="k">var</span> <span class="nx">req</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">StringUtil</span><span class="p">.</span><span class="nx">substitute</span><span class="p">(</span>
      <span class="s2">&quot;GET {0} HTTP/1.1\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Upgrade: WebSocket\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Connection: Upgrade\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Host: {1}\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Origin: {2}\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Cookie: {3}\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Sec-WebSocket-Key1: {4}\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Sec-WebSocket-Key2: {5}\r\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;{6}&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;\r\n&quot;</span><span class="o">,</span>
      <span class="nx">path</span><span class="o">,</span> <span class="nx">hostValue</span><span class="o">,</span> <span class="nx">origin</span><span class="o">,</span> <span class="nx">cookie</span><span class="o">,</span> <span class="nx">key1</span><span class="o">,</span> <span class="nx">key2</span><span class="o">,</span> <span class="nx">opt</span><span class="p">);</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;request header:\n&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">writeUTFBytes</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;sent key3: &quot;</span> <span class="o">+</span> <span class="nx">key3</span><span class="p">);</span>
    <span class="nx">writeBytes</span><span class="p">(</span><span class="nx">key3</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onSocketClose</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="nb">Event</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="p">);</span>
    <span class="nx">readyState</span> <span class="o">=</span> <span class="nx">CLOSED</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebSocketEvent</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onSocketIoError</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="nb">IOErrorEvent</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">message</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">CONNECTING</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;cannot connect to Web Socket server at &quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot; (IoError)&quot;</span><span class="o">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;error communicating with Web Socket server at &quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot; (IoError)&quot;</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="nx">onError</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onSocketSecurityError</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="nb">SecurityErrorEvent</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">message</span><span class="o">:</span><span class="nb">String</span><span class="o">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">CONNECTING</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span>
          <span class="s2">&quot;cannot connect to Web Socket server at &quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot; (SecurityError)\n&quot;</span> <span class="o">+</span>
          <span class="s2">&quot;make sure the server is running and Flash socket policy file is correctly placed&quot;</span><span class="o">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;error communicating with Web Socket server at &quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot; (SecurityError)&quot;</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="nx">onError</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="nx">close</span><span class="p">(</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">CONNECTING</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">onSocketData</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="nb">ProgressEvent</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">pos</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">,</span> <span class="nx">pos</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="o">++</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">headerState</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>try to find "\r\n\r\n"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">((</span><span class="nx">headerState</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">headerState</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0d</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">headerState</span><span class="o">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">headerState</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">headerState</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">headerState</span><span class="o">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">headerState</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">headerState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">var</span> <span class="nx">headerStr</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">readUTFBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response header:\n&quot;</span> <span class="o">+</span> <span class="nx">headerStr</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validateHeader</span><span class="p">(</span><span class="nx">headerStr</span><span class="p">))</span> <span class="k">return</span><span class="o">;</span>
          <span class="nx">removeBufferBefore</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">headerState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">var</span> <span class="nx">replyDigest</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">readBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">16</span><span class="p">);</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;reply digest: &quot;</span> <span class="o">+</span> <span class="nx">replyDigest</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">replyDigest</span> <span class="o">!=</span> <span class="nx">expectedDigest</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;digest doesn&#39;t match: &quot;</span> <span class="o">+</span> <span class="nx">replyDigest</span> <span class="o">+</span> <span class="s2">&quot; != &quot;</span> <span class="o">+</span> <span class="nx">expectedDigest</span><span class="p">);</span>
            <span class="k">return</span><span class="o">;</span>
          <span class="p">}</span>
          <span class="nx">headerState</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
          <span class="nx">removeBufferBefore</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
          <span class="nx">readyState</span> <span class="o">=</span> <span class="nx">OPEN</span><span class="o">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebSocketEvent</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;data must start with \\x00&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="o">;</span>
          <span class="p">}</span>
          <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">readUTFBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nx">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;received: &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebSocketEvent</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="o">,</span> <span class="nx">encodeURIComponent</span><span class="p">(</span><span class="nx">data</span><span class="p">)));</span>
          <span class="nx">removeBufferBefore</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// closing</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;received closing packet&quot;</span><span class="p">);</span>
          <span class="nx">removeBufferBefore</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
          <span class="nx">close</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">validateHeader</span><span class="p">(</span><span class="nx">headerStr</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nb">Boolean</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">lines</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="nx">headerStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\r\n/</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^HTTP\/1.1 101 /</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;bad response: &quot;</span> <span class="o">+</span> <span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nx">header</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">var</span> <span class="nx">lowerHeader</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="o">;</span>
      <span class="k">var</span> <span class="nx">m</span><span class="o">:</span><span class="nb">Array</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(\S+): (.*)$/</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;failed to parse response header line: &quot;</span> <span class="o">+</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="p">}</span>
      <span class="nx">header</span><span class="p">[</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="nx">lowerHeader</span><span class="p">[</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lowerHeader</span><span class="p">[</span><span class="s2">&quot;upgrade&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;websocket&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;invalid Upgrade: &quot;</span> <span class="o">+</span> <span class="nx">header</span><span class="p">[</span><span class="s2">&quot;Upgrade&quot;</span><span class="p">]);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lowerHeader</span><span class="p">[</span><span class="s2">&quot;connection&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;invalid Connection: &quot;</span> <span class="o">+</span> <span class="nx">header</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lowerHeader</span><span class="p">[</span><span class="s2">&quot;sec-websocket-origin&quot;</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lowerHeader</span><span class="p">[</span><span class="s2">&quot;websocket-origin&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">onError</span><span class="p">(</span>
          <span class="s2">&quot;The WebSocket server speaks old WebSocket protocol, &quot;</span> <span class="o">+</span>
          <span class="s2">&quot;which is not supported by web-socket-js. &quot;</span> <span class="o">+</span>
          <span class="s2">&quot;It requires WebSocket protocol 76 or later. &quot;</span> <span class="o">+</span>
          <span class="s2">&quot;Try newer version of the server if available.&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;header Sec-WebSocket-Origin is missing&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nx">resOrigin</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">lowerHeader</span><span class="p">[</span><span class="s2">&quot;sec-websocket-origin&quot;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">resOrigin</span> <span class="o">!=</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;origin doesn&#39;t match: &#39;&quot;</span> <span class="o">+</span> <span class="nx">resOrigin</span> <span class="o">+</span> <span class="s2">&quot;&#39; != &#39;&quot;</span> <span class="o">+</span> <span class="nx">origin</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">requestedProtocols</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">acceptedProtocol</span> <span class="o">=</span> <span class="nx">header</span><span class="p">[</span><span class="s2">&quot;sec-websocket-protocol&quot;</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">requestedProtocols</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">acceptedProtocol</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;protocol doesn&#39;t match: &#39;&quot;</span> <span class="o">+</span>
          <span class="nx">acceptedProtocol</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in &#39;&quot;</span> <span class="o">+</span> <span class="nx">requestedProtocols</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">removeBufferBefore</span><span class="p">(</span><span class="nx">pos</span><span class="o">:</span><span class="nb">int</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">nextBuffer</span><span class="o">:</span><span class="nb">ByteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ByteArray</span><span class="p">();</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">pos</span><span class="o">;</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">nextBuffer</span><span class="p">);</span>
    <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">nextBuffer</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">initNoiseChars</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="nx">noiseChars</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mh">0x21</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mh">0x2f</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">noiseChars</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">j</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mh">0x3a</span><span class="o">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="mh">0x7a</span><span class="o">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">noiseChars</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">j</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">generateKey</span><span class="p">()</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">spaces</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">max</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nb">uint</span><span class="p">.</span><span class="nx">MAX_VALUE</span> <span class="o">/</span> <span class="nx">spaces</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">number</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="nx">max</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">key</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="p">(</span><span class="nx">number</span> <span class="o">*</span> <span class="nx">spaces</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">var</span> <span class="nx">noises</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">pos</span><span class="o">:</span><span class="nb">int</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">noises</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">char</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">noiseChars</span><span class="p">[</span><span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="nx">noiseChars</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">+</span> <span class="nx">char</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">j</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">spaces</span><span class="o">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">1</span><span class="o">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">key</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">generateKey3</span><span class="p">()</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">key3</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">key3</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">255</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">key3</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">getSecurityDigest</span><span class="p">(</span><span class="nx">key1</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span> <span class="nx">key2</span><span class="o">:</span><span class="nb">String</span><span class="o">,</span> <span class="nx">key3</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">bytes1</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">keyToBytes</span><span class="p">(</span><span class="nx">key1</span><span class="p">);</span>
    <span class="k">var</span> <span class="nx">bytes2</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">keyToBytes</span><span class="p">(</span><span class="nx">key2</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">MD5</span><span class="p">.</span><span class="nx">rstr_md5</span><span class="p">(</span><span class="nx">bytes1</span> <span class="o">+</span> <span class="nx">bytes2</span> <span class="o">+</span> <span class="nx">key3</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">keyToBytes</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">keyNum</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^\d]/g</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
    <span class="k">var</span> <span class="nx">spaces</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">++</span><span class="nx">spaces</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nx">resultNum</span><span class="o">:</span><span class="nb">uint</span> <span class="o">=</span> <span class="nx">keyNum</span> <span class="o">/</span> <span class="nx">spaces</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">bytes</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">j</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bytes</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">((</span><span class="nx">resultNum</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">bytes</span><span class="o">;</span>
  <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Writes byte sequence to socket.
bytes is String in special format where bytes[i] is i-th byte, not i-th character.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">writeBytes</span><span class="p">(</span><span class="nx">bytes</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">writeByte</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Reads specified number of bytes from buffer, and returns it as special format String
where bytes[i] is i-th byte (not i-th character).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">readBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">,</span> <span class="nx">start</span><span class="o">:</span><span class="nb">int</span><span class="o">,</span> <span class="nx">numBytes</span><span class="o">:</span><span class="nb">int</span><span class="p">)</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">start</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">bytes</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numBytes</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>&amp; 0xff is to make \x80-\xff positive number.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">bytes</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">readByte</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">bytes</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">readUTFBytes</span><span class="p">(</span><span class="nx">buffer</span><span class="o">:</span><span class="nb">ByteArray</span><span class="o">,</span> <span class="nx">start</span><span class="o">:</span><span class="nb">int</span><span class="o">,</span> <span class="nx">numBytes</span><span class="o">:</span><span class="nb">int</span><span class="p">)</span><span class="o">:</span><span class="nb">String</span> <span class="p">{</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">start</span><span class="o">;</span>
    <span class="k">var</span> <span class="nx">data</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">for</span><span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">start</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">numBytes</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Workaround of a bug of ByteArray#readUTFBytes() that bytes after "\x00" is discarded.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">readUTFBytes</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\x00&quot;</span><span class="o">;</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">data</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">readUTFBytes</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">numBytes</span> <span class="o">-</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">data</span><span class="o">;</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">randomInt</span><span class="p">(</span><span class="nx">min</span><span class="o">:</span><span class="nb">uint</span><span class="o">,</span> <span class="nx">max</span><span class="o">:</span><span class="nb">uint</span><span class="p">)</span><span class="o">:</span><span class="nb">uint</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">min</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="o">-</span> <span class="nx">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="p">}</span>
  
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">fatal</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">message</span><span class="o">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>for debug</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">private</span> <span class="kd">function</span> <span class="nx">dumpBytes</span><span class="p">(</span><span class="nx">bytes</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">output</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">var</span> <span class="nx">i</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
  <span class="p">}</span>
  
<span class="p">}</span>

<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
