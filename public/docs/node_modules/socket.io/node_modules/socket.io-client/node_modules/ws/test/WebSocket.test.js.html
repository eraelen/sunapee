<!DOCTYPE html>
<html>
<head>
  <title>WebSocket.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/node_modules/ws/test/WebSocket.test.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>WebSocket.test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">should</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;should&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">WebSocketServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">).</span><span class="nx">Server</span>
  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./testserver&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getArrayBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">arrayBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">arrayBuf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">arrayBuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">y</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;WebSocket&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#ctor&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;throws exception for invalid url&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;echo.websocket.org&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;#bytesReceived exposes number of bytes received&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">bytesReceived</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;#url exposes the server url&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;#protocolVersion exposes the protocol version&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">protocolVersion</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#readyState&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;defaults to connecting&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;set to open once connection is established&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;set to closed once connection is closed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1001</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;set to closed once connection is terminated&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Ready state constants</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">var</span> <span class="nx">readyStates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">CONNECTING</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">OPEN</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">CLOSING</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">CLOSED</span><span class="o">:</span> <span class="mi">3</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Ready state constant tests</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">readyStates</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;is enumerable property&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">propertyDescripter</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">readyStates</span><span class="p">[</span><span class="nx">state</span><span class="p">],</span> <span class="nx">propertyDescripter</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">propertyDescripter</span><span class="p">.</span><span class="nx">enumerable</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;emits a ping event&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
      <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;emits a pong event&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">pong</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
      <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;connection establishing&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can disconnect before connection is established&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;connect shouldnt be raised here&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can close before connection is established&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1001</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;connect shouldnt be raised here&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;invalid server key is denied&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">invalidKey</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;close event is raised when server closes connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">closeAfterConnect</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;error is emitted if server aborts connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">return401</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;connect shouldnt be raised here&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#pause and #resume&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;pauses the underlying stream&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>this test is sort-of racecondition'y, since an unlikely slow connection
to localhost can cause the test to succeed even when the stream pausing
isn't working as intended. that is an extremely unlikely scenario, though
and an acceptable risk for the test.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">client</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">serverClient</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">openCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">openCount</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">paused</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">serverClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">paused</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">ok</span><span class="p">;</span>
            <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
          <span class="nx">serverClient</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">paused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">serverClient</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">200</span><span class="p">);</span>
          <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">serverClient</span> <span class="o">=</span> <span class="nx">ws</span><span class="p">;</span>
        <span class="nx">serverClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nx">onOpen</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span> <span class="o">=</span> <span class="nx">ws</span><span class="p">;</span>
        <span class="nx">onOpen</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect should fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect can silently fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with encoded message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect should fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect can silently fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with encoded message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#send&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;very long binary data can be sent and received (with echoing server)&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">getArrayBuffer</span><span class="p">(</span><span class="nx">message</span><span class="p">))));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can send and receive text data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;send and receive binary data as an array&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">getArrayBuffer</span><span class="p">(</span><span class="nx">message</span><span class="p">))));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;binary data can be sent and received as buffer&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">message</span><span class="p">));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect should fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect should pass error through callback, if present&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without data should be successful&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;calls optional callback when flushed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with unencoded message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with encoded message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with unencoded binary message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">getArrayBuffer</span><span class="p">(</span><span class="nx">message</span><span class="p">))));</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with encoded binary message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">getArrayBuffer</span><span class="p">(</span><span class="nx">message</span><span class="p">))));</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with binary stream will send fragmented data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">callbackFired</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="nx">callbackFired</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">callbackFired</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with text stream will send fragmented data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">callbackFired</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="nx">callbackFired</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">callbackFired</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent send to be delayed in order&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">receivedIndex</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent stream to be delayed in order&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
            <span class="k">else</span> <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">receivedIndex</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent ping to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent pong to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent close to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* That&#39;s quite alright -- a send was attempted after close */</span> <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">));</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#stream&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;very long binary data can be streamed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">%</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">blockSize</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">bufLen</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">({</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">*</span> <span class="nx">blockSize</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">toSend</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">blockSize</span><span class="p">,</span> <span class="nx">bufLen</span> <span class="o">-</span> <span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">blockSize</span><span class="p">));</span>
            <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">toSend</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">isFinal</span> <span class="o">=</span> <span class="nx">toSend</span> <span class="o">&lt;</span> <span class="nx">blockSize</span><span class="p">;</span>
            <span class="nx">send</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">),</span> <span class="nx">isFinal</span><span class="p">);</span>
            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">data</span><span class="p">));</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;before connect should pass error through callback&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without callback should fail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent send to be delayed in order&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">receivedIndex</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent stream to be delayed in order&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
              <span class="kd">var</span> <span class="nx">i2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
                <span class="k">else</span> <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
              <span class="p">});</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">receivedIndex</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
              <span class="nx">done</span><span class="p">();</span>
            <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;more messages than we actually sent just arrived&#39;</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent ping to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent pong to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">receivedIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">receivedIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will cause intermittent close to be delivered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">errorGiven</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
              <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
              <span class="nx">errorGiven</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">errorGiven</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will raise error callback, if any, if called during send stream&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">errorGiven</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">&#39;test/fixtures/textfile&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">fileStream</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">fileStream</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">errorGiven</span> <span class="o">=</span> <span class="nx">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">errorGiven</span><span class="p">);</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without invalid first argument throws exception&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without reserved error code 1004 throws exception&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1004</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;without message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;some reason&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;some reason&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;with encoded message is successfully transmitted to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;some reason&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">flags</span><span class="p">.</span><span class="nx">masked</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;some reason&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ends connection to the server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">connectedOnce</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">connectedOnce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;some reason&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">connectedOnce</span><span class="p">);</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;W3C API emulation&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should not throw errors when getting and setting&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>

        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">);</span>

        <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should work the same as the EventEmitter api&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">messageEvent</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!!</span><span class="nx">messageEvent</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
          <span class="o">++</span><span class="nx">message</span><span class="p">;</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">open</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="o">++</span><span class="nx">close</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">message</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">open</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">close</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>

            <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should receive text data wrapped in a MessageEvent when using addEventListener&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">messageEvent</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="nx">messageEvent</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">srv</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should receive valid CloseEvent when server closes with code 1000&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">closeEvent</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">closeEvent</span><span class="p">.</span><span class="nx">wasClean</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nx">closeEvent</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should receive vaild CloseEvent when server closes with code 1001&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">closeEvent</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">closeEvent</span><span class="p">.</span><span class="nx">wasClean</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1001</span><span class="p">,</span> <span class="nx">closeEvent</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;some daft reason&#39;</span><span class="p">,</span> <span class="nx">closeEvent</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1001</span><span class="p">,</span> <span class="s1">&#39;some daft reason&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ssl&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can connect to secure websocket server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/key.pem&#39;</span><span class="p">),</span>
        <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/certificate.pem&#39;</span><span class="p">)</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">server</span><span class="o">:</span> <span class="nx">app</span><span class="p">});</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;wss://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
        <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;cannot connect to secure websocket server via ws://&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/key.pem&#39;</span><span class="p">),</span>
        <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/certificate.pem&#39;</span><span class="p">)</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">server</span><span class="o">:</span> <span class="nx">app</span><span class="p">});</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can send and receive text data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/key.pem&#39;</span><span class="p">),</span>
        <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/certificate.pem&#39;</span><span class="p">)</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">server</span><span class="o">:</span> <span class="nx">app</span><span class="p">});</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;wss://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">message</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">);</span>
          <span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can send and receive very long binary data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/key.pem&#39;</span><span class="p">),</span>
        <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;test/fixtures/certificate.pem&#39;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ex</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">server</span><span class="o">:</span> <span class="nx">app</span><span class="p">});</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="o">++</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;wss://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">});</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">ok</span><span class="p">;</span>
            <span class="nx">areArraysEqual</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">message</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">ok</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
            <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">binary</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;protocol support discovery&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#supports&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;#binary&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns true for hybi transport&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
          <span class="p">});</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">supports</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns false for hixie transport&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="o">++</span><span class="nx">port</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
              <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
              <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;Connection&#39;</span><span class="o">:</span> <span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Upgrade&#39;</span><span class="o">:</span> <span class="s1">&#39;WebSocket&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Sec-WebSocket-Key1&#39;</span><span class="o">:</span> <span class="s1">&#39;3e6b263  4 17 80&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Sec-WebSocket-Key2&#39;</span><span class="o">:</span> <span class="s1">&#39;17  9 G`ZD9   2 2b 7X 3 /r90&#39;</span>
              <span class="p">}</span>
            <span class="p">};</span>
            <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;WjN}|M(6&#39;</span><span class="p">);</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
          <span class="p">});</span>
          <span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">supports</span><span class="p">.</span><span class="nx">binary</span><span class="p">);</span>
            <span class="nx">wss</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="nx">done</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
