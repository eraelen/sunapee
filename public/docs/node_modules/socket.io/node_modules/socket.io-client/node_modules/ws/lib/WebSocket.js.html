<!DOCTYPE html>
<html>
<head>
  <title>WebSocket.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/node_modules/ws/lib/WebSocket.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>WebSocket.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>!
ws: a node.js websocket client
Copyright(c) 2011 Einar Otto Stangvik <a href="&#109;&#97;&#105;&#x6C;t&#111;:ei&#x6E;&#x61;&#x72;o&#115;&#x40;&#103;&#x6D;a&#105;&#108;&#x2E;&#99;&#x6F;&#x6D;">ei&#x6E;&#x61;&#x72;o&#115;&#x40;&#103;&#x6D;a&#105;&#108;&#x2E;&#99;&#x6F;&#x6D;</a>
MIT Licensed</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Options</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Sender</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Sender&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Receiver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Receiver&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">SenderHixie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Sender.hixie&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">ReceiverHixie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Receiver.hixie&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Constants</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Default protocol version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">protocolVersion</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Close timeout</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">closeTimeout</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span> <span class="c1">// Allow 5 seconds to terminate the connection cleanly</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Node version 0.4 and 0.6 compatibility</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">isNodeV4</span> <span class="o">=</span> <span class="sr">/^v0\.4/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>WebSocket implementation</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bytesReceived</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">supports</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">initAsServerClient</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">address</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nx">initAsClient</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Inherits from EventEmitter.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Ready States</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Gracefully closes the connection, after sending a description message to the server</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">Object</span>
      <span>to be sent to the server</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSING</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSING</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_closeCode</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_closeMessage</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">mask</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mask</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">finally</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Pause the client stream</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Sends a ping</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">Object</span>
      <span>to be sent to the server</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Members</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>mask: boolean, binary: boolean</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">dontFailWhenClosed</span>
      <span class="dox_type">boolean</span>
      <span>indicates whether or not to throw if the connection isnt open</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ping</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">dontFailWhenClosed</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dontFailWhenClosed</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Sends a pong</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">Object</span>
      <span>to be sent to the server</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Members</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>mask: boolean, binary: boolean</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">dontFailWhenClosed</span>
      <span class="dox_type">boolean</span>
      <span>indicates whether or not to throw if the connection isnt open</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pong</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">dontFailWhenClosed</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dontFailWhenClosed</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Resume the client stream</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Sends a piece of data</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">Object</span>
      <span>to be sent to the server</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Members</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>mask: boolean, binary: boolean</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Optional</span>
      <span class="dox_type">function</span>
      <span>callback which is executed after the send completes</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="nx">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">fin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">ReadStream</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">startQueue</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">sendStream</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">executeQueueSends</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span> <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Streams data through calls to a user supplied function</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Members</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>mask: boolean, binary: boolean</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">'function</span>
      <span class="dox_type">function</span>
      <span>(error, send)' which is executed on successive ticks of which send is 'function (data, final)'.</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;callback must be provided&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mask</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">;</span>
  <span class="nx">startQueue</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kr">final</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">);</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">fin</span> <span class="o">=</span> <span class="kr">final</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="kr">final</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">send</span><span class="p">));</span>
      <span class="k">else</span> <span class="nx">executeQueueSends</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">send</span><span class="p">));</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Immediately shuts down the connection</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">terminate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>End the connection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Socket error during end() call, so just destroy it right now</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Add a timeout to ensure that the connection is completely
cleaned up within 30 seconds, even if the clean close procedure
fails for whatever reason</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">_closeTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">closeTimeout</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Emulates the W3C Browser based WebSocket interface using function members.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="http://dev.w3.org/html5/websockets/#the-websocket-interface">http://dev.w3.org/html5/websockets/#the-websocket-interface</a>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">method</span><span class="p">,</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Returns the current listener</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">method</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">listener</span> <span class="o">?</span> <span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">_listener</span> <span class="o">?</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">_listener</span> <span class="o">:</span> <span class="nx">listener</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Start listening for events</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">listener</span>
      <span class="dox_type">Function</span>
      <span>the listener</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">set</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">method</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Emulates the W3C Browser based WebSocket interface using addEventListener.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="https://developer.mozilla.org/en/DOM/element.addEventListener">https://developer.mozilla.org/en/DOM/element.addEventListener</a>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="http://dev.w3.org/html5/websockets/#the-websocket-interface">http://dev.w3.org/html5/websockets/#the-websocket-interface</a>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">listener</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">onMessage</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">listener</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MessageEvent</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>store a reference so we can return the original function from the addEventListener hook</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">onMessage</span><span class="p">.</span><span class="nx">_listener</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">onMessage</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">onClose</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">listener</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nx">CloseEvent</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">message</span><span class="p">));</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>store a reference so we can return the original function from the addEventListener hook</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">onClose</span><span class="p">.</span><span class="nx">_listener</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">onClose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>W3C MessageEvent</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="http://www.w3.org/TR/html5/comms.html">http://www.w3.org/TR/html5/comms.html</a>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">MessageEvent</span><span class="p">(</span><span class="nx">dataArg</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Currently only the data attribute is implemented. More can be added later if needed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">dataArg</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>W3C CloseEvent</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="http://www.w3.org/TR/html5/comms.html">http://www.w3.org/TR/html5/comms.html</a>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">CloseEvent</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">wasClean</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Entirely private apis,
which may or may not be bound to a sepcific WebSocket instance.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

 <span class="kd">function</span> <span class="nx">initAsServerClient</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Options</span><span class="p">({</span>
    <span class="nx">protocolVersion</span><span class="o">:</span> <span class="nx">protocolVersion</span><span class="p">,</span>
    <span class="nx">protocol</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">}).</span><span class="nx">merge</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>expose state properties</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">supports</span><span class="p">.</span><span class="nx">binary</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">!=</span> <span class="s1">&#39;hixie-76&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">upgradeReq</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>establish connection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">==</span> <span class="s1">&#39;hixie-76&#39;</span><span class="p">)</span> <span class="nx">establishConnection</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">ReceiverHixie</span><span class="p">,</span> <span class="nx">SenderHixie</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">);</span>
  <span class="k">else</span> <span class="nx">establishConnection</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Receiver</span><span class="p">,</span> <span class="nx">Sender</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initAsClient</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Options</span><span class="p">({</span>
    <span class="nx">origin</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">protocolVersion</span><span class="o">:</span> <span class="nx">protocolVersion</span><span class="p">,</span>
    <span class="nx">protocol</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">}).</span><span class="nx">merge</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;unsupported protocol version&#39;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>verify url and establish http class</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">serverUrl</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">address</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">isUnixSocket</span> <span class="o">=</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;ws+unix:&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">serverUrl</span><span class="p">.</span><span class="nx">host</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isUnixSocket</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invalid url&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">isSecure</span> <span class="o">=</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;wss:&#39;</span> <span class="o">||</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https:&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">httpObj</span> <span class="o">=</span> <span class="nx">isSecure</span> <span class="o">?</span> <span class="nx">https</span> <span class="o">:</span> <span class="nx">http</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>expose state properties</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">_isServer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">address</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">supports</span><span class="p">.</span><span class="nx">binary</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">!=</span> <span class="s1">&#39;hixie-76&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>begin handshake</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">shasum</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
  <span class="nx">shasum</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">expectedServerKey</span> <span class="o">=</span> <span class="nx">shasum</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>node&lt;=v0.4.x compatibility</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">agent</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isNodeV4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isNodeV4</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">agent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">httpObj</span><span class="p">.</span><span class="nx">Agent</span><span class="p">({</span>
      <span class="nx">host</span><span class="o">:</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="p">(</span><span class="nx">isSecure</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">)</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">requestOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="p">(</span><span class="nx">isSecure</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">),</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Connection&#39;</span><span class="o">:</span> <span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Upgrade&#39;</span><span class="o">:</span> <span class="s1">&#39;websocket&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Sec-WebSocket-Version&#39;</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span><span class="p">,</span>
      <span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="o">:</span> <span class="nx">key</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocol</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Protocol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isNodeV4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">serverUrl</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">serverUrl</span><span class="p">.</span><span class="nx">search</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isUnixSocket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">socketPath</span> <span class="o">=</span> <span class="nx">serverUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">httpObj</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">);</span>
  <span class="p">(</span><span class="nx">isNodeV4</span> <span class="o">?</span> <span class="nx">agent</span> <span class="o">:</span> <span class="nx">req</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="p">(</span><span class="nx">isNodeV4</span> <span class="o">?</span> <span class="nx">agent</span> <span class="o">:</span> <span class="nx">req</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;unexpected server response (&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="p">(</span><span class="nx">isNodeV4</span> <span class="o">?</span> <span class="nx">agent</span> <span class="o">:</span> <span class="nx">req</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>client closed before server accepted connection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
      <span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">serverKey</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;sec-websocket-accept&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">serverKey</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">serverKey</span> <span class="o">!==</span> <span class="nx">expectedServerKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid server key&#39;</span><span class="p">);</span>
      <span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">establishConnection</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">Receiver</span><span class="p">,</span> <span class="nx">Sender</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>perform cleanup on http resources</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">isNodeV4</span> <span class="o">?</span> <span class="nx">agent</span> <span class="o">:</span> <span class="nx">req</span><span class="p">);</span>
    <span class="nx">req</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">agent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">establishConnection</span><span class="p">(</span><span class="nx">ReceiverClass</span><span class="p">,</span> <span class="nx">SenderClass</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">upgradeHead</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">setNoDelay</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReceiverClass</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>socket cleanup handlers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">cleanupWebsocketResources</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>ensure that the upgradeHead is added to the receiver</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">firstHandler</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">upgradeHead</span> <span class="o">&amp;&amp;</span> <span class="nx">upgradeHead</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">bytesReceived</span> <span class="o">+=</span> <span class="nx">upgradeHead</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">head</span> <span class="o">=</span> <span class="nx">upgradeHead</span><span class="p">;</span>
      <span class="nx">upgradeHead</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">head</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">dataHandler</span> <span class="o">=</span> <span class="nx">realHandler</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">bytesReceived</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>subsequent packets are pushed straight to the receiver</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">realHandler</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bytesReceived</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">dataHandler</span> <span class="o">=</span> <span class="nx">firstHandler</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">dataHandler</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>if data was passed along with the http upgrade,
this will schedule a push of that on to the receiver.
this has to be done on next tick, since the caller
hasn't had a chance to set event handlers on this client
object yet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">firstHandler</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>receiver event handlers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">ontext</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flags</span> <span class="o">=</span> <span class="nx">flags</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">onbinary</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flags</span> <span class="o">=</span> <span class="nx">flags</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">onping</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flags</span> <span class="o">=</span> <span class="nx">flags</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="nx">mask</span><span class="o">:</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">_isServer</span><span class="p">,</span> <span class="nx">binary</span><span class="o">:</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">binary</span> <span class="o">===</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">onpong</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flags</span> <span class="o">=</span> <span class="nx">flags</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">errorCode</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>close the connection when the receiver reports a HyBi error code</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">self</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">errorCode</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">errorCode</span> <span class="o">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">errorCode</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>finalize the client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SenderClass</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">startQueue</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">||</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">executeQueueSends</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">queue</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">delete</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">]();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sendStream</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">fin</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;not opened&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">fin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">_sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">cleanupWebsocketResources</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">emitClose</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CONNECTING</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">;</span>

  <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_closeTimer</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">removeAllListeners</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>catch all socket error after removing all standard handlers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">});</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Ignore termination errors */</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">removeAllListeners</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sender</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sender</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_receiver</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_receiver</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">emitClose</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_closeCode</span> <span class="o">||</span> <span class="mi">1000</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_closeMessage</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="nx">removeAllListeners</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span> <span class="c1">// catch all errors after this</span>
  <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isNodeV4</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>node v4 doesn't <em>actually</em> remove all listeners globally,
so we do that instead</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
