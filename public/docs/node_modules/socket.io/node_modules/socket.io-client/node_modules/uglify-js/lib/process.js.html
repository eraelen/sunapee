<!DOCTYPE html>
<html>
<head>
  <title>process.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/node_modules/uglify-js/lib/process.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>process.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><hr />
  </div>
  <div class="body"><p>A JavaScript tokenizer / parser / beautifier / compressor.</p>

<p>This version is suitable for Node.js.  With minimal changes (the
exports stuff) it should work on any JS platform.</p>

<p>This file implements some AST processors.  They work on data built
by parse-js.</p>

<p>Exported functions:</p>

<ul>
<li><p>ast_mangle(ast, options) -- mangles the variable/function names
in the AST.  Returns an AST.</p></li>
<li><p>ast_squeeze(ast) -- employs various optimizations to make the
final generated code even smaller.  Returns an AST.</p></li>
<li><p>gen_code(ast, options) -- generates JS code from the AST.  Pass
true (or an object, see the code for some options) as second
argument to get "pretty" (indented) code.</p></li>
</ul>

<p>-------------------------------- (C) ---------------------------------</p>

<p>Author: Mihai Bazon
<a href="&#x6D;a&#105;&#x6C;&#x74;&#111;:&#x6D;&#105;&#104;&#x61;&#105;&#46;&#x62;&#97;&#122;&#111;&#x6E;&#64;&#x67;&#109;&#97;&#x69;&#x6C;&#46;&#99;&#111;&#x6D;">&#x6D;&#105;&#104;&#x61;&#105;&#46;&#x62;&#97;&#122;&#111;&#x6E;&#64;&#x67;&#109;&#97;&#x69;&#x6C;&#46;&#99;&#111;&#x6D;</a>
<a href='http://mihai.bazon.net/blog'>http://mihai.bazon.net/blog</a></p>

<p>Distributed under the BSD license:</p>

<p>Copyright 2010 (c) Mihai Bazon <a href="&#x6D;&#97;&#x69;&#x6C;&#x74;&#111;:&#109;&#105;&#x68;&#97;&#105;&#46;&#98;&#x61;&#x7A;&#111;&#110;&#x40;&#x67;&#x6D;&#97;&#x69;l&#x2E;&#99;&#x6F;&#109;">&#109;&#105;&#x68;&#97;&#105;&#46;&#98;&#x61;&#x7A;&#111;&#110;&#x40;&#x67;&#x6D;&#97;&#x69;l&#x2E;&#99;&#x6F;&#109;</a></p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:</p>

<p>Redistributions of source code must retain the above
copyright notice, this list of conditions and the following
disclaimer.</p>

<p>Redistributions in binary form must reproduce the above
copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials
provided with the distribution.</p>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER “AS IS” AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
SUCH DAMAGE.</p>

<hr />
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">jsp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./parse-js&quot;</span><span class="p">),</span>
    <span class="nx">slice</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
    <span class="nx">member</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">member</span><span class="p">,</span>
    <span class="nx">PRECEDENCE</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">PRECEDENCE</span><span class="p">,</span>
    <span class="nx">OPERATORS</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">OPERATORS</span><span class="p">;</span>

<span class="cm">/* -----[ helper for AST traversal ]----- */</span>

<span class="kd">function</span> <span class="nx">ast_walker</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">def</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">def</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">def</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">def</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
                <span class="p">})</span> <span class="p">];</span>
        <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">_block</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">statements</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">walk</span><span class="p">));</span>
                <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">walkers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;string&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">str</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;num&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">num</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;block&quot;</span><span class="o">:</span> <span class="nx">_block</span><span class="p">,</span>
                <span class="s2">&quot;splice&quot;</span><span class="o">:</span> <span class="nx">_block</span><span class="p">,</span>
                <span class="s2">&quot;var&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">,</span>
                <span class="s2">&quot;const&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">,</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span>
                                <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="nx">MAP</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">walk</span><span class="p">),</span>
                                <span class="nx">c</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                <span class="nx">f</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
                        <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;throw&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;new&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctor</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ctor</span><span class="p">),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;switch&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">branch</span><span class="p">){</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                         <span class="nx">MAP</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                        <span class="p">})</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;break&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">label</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;continue&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">label</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;conditional&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">cond</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;assign&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">lvalue</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;dot&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
                <span class="p">},</span>
                <span class="s2">&quot;call&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;debugger&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;if&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conditional</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">conditional</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;for&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">init</span><span class="p">,</span> <span class="nx">cond</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">init</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">cond</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">step</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;for-in&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vvar</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">vvar</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">hash</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;while&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">cond</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;do&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">cond</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;return&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;binary&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;unary-postfix&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;sub&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">subscript</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">subscript</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;object&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span>
                                <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
                                        <span class="o">?</span> <span class="p">[</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span>
                                        <span class="o">:</span> <span class="p">[</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">];</span> <span class="c1">// get/set-ter</span>
                        <span class="p">})</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;regexp&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rx</span><span class="p">,</span> <span class="nx">mods</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">rx</span><span class="p">,</span> <span class="nx">mods</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;array&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;stat&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;seq&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">slice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">walk</span><span class="p">));</span>
                <span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;with&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;atom&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">function</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">user</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gen</span><span class="p">)</span> <span class="p">{</span>
                                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                                        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">gen</span> <span class="o">=</span> <span class="nx">walkers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
                        <span class="k">return</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                        <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">dive</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">walkers</span><span class="p">[</span><span class="nx">ast</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                        <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">with_walkers</span><span class="p">(</span><span class="nx">walkers</span><span class="p">,</span> <span class="nx">cont</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">save</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">i</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">walkers</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">walkers</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">save</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="nx">user</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">walkers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">cont</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">save</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">save</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">save</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">delete</span> <span class="nx">user</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">else</span> <span class="nx">user</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">save</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="p">{</span>
                <span class="nx">walk</span><span class="o">:</span> <span class="nx">walk</span><span class="p">,</span>
                <span class="nx">dive</span><span class="o">:</span> <span class="nx">dive</span><span class="p">,</span>
                <span class="nx">with_walkers</span><span class="o">:</span> <span class="nx">with_walkers</span><span class="p">,</span>
                <span class="nx">parent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span> <span class="c1">// last one is current node</span>
                <span class="p">},</span>
                <span class="nx">stack</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">};</span>
<span class="p">};</span>

<span class="cm">/* -----[ Scope and mangling ]----- */</span>

<span class="kd">function</span> <span class="nx">Scope</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">names</span> <span class="o">=</span> <span class="p">{};</span>        <span class="c1">// names defined in this scope</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mangled</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c1">// mangled names (orig.name =&gt; mangled)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">rev_mangled</span> <span class="o">=</span> <span class="p">{};</span>  <span class="c1">// reverse lookup (mangled =&gt; orig.name)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">cname</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// current mangled name</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">refs</span> <span class="o">=</span> <span class="p">{};</span>         <span class="c1">// names referenced from this scope</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">uses_with</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// will become TRUE if with() is detected in this or any subscopes</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">uses_eval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// will become TRUE if eval() is detected in this or any subscopes</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>   <span class="c1">// parent scope</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>     <span class="c1">// sub-scopes</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">base54</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">DIGITS</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="k">do</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">DIGITS</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">num</span> <span class="o">%</span> <span class="mi">54</span><span class="p">)</span> <span class="o">+</span> <span class="nx">ret</span><span class="p">;</span>
                        <span class="nx">num</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="mi">54</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">})();</span>

<span class="nx">Scope</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">has</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span>
                                <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">has_mangled</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mname</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">rev_mangled</span><span class="p">,</span> <span class="nx">mname</span><span class="p">))</span>
                                <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">{</span>
                        <span class="nx">names</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span>
                        <span class="nx">uses_eval</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uses_eval</span><span class="p">,</span>
                        <span class="nx">uses_with</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uses_with</span>
                <span class="p">};</span>
        <span class="p">},</span>

        <span class="nx">next_mangled</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>we must be careful that the new mangled name:</p>

<ol>
<li><p>doesn't shadow a mangled name from a parent
scope, unless we don't reference the original
name from this scope OR from any sub-scopes!
This will get slow.</p></li>
<li><p>doesn't shadow an original name from a parent
scope, in the event that the name is not mangled
in the parent scope and we reference that name
here OR IN ANY SUBSCOPES!</p></li>
<li><p>doesn't shadow a name that is referenced but not
defined (possibly global defined elsewhere).</p></li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">base54</span><span class="p">(</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">cname</span><span class="p">),</span> <span class="nx">prior</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>case 1.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="nx">prior</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">has_mangled</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">prior</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">prior</span><span class="p">.</span><span class="nx">rev_mangled</span><span class="p">[</span><span class="nx">m</span><span class="p">]]</span> <span class="o">===</span> <span class="nx">prior</span><span class="p">)</span>
                                <span class="k">continue</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>case 2.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="nx">prior</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">prior</span> <span class="o">&amp;&amp;</span> <span class="nx">prior</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">m</span><span class="p">]</span> <span class="o">===</span> <span class="nx">prior</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">prior</span><span class="p">.</span><span class="nx">has_mangled</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
                                <span class="k">continue</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>case 3.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">m</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                                <span class="k">continue</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>I got "do" once. :-/</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_identifier</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
                                <span class="k">continue</span><span class="p">;</span>

                        <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">set_mangle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">rev_mangled</span><span class="p">[</span><span class="nx">m</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mangled</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">get_mangled</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">newMangle</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uses_eval</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">uses_with</span><span class="p">)</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="c1">// no mangle if eval or with is in use</span>
                <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">s</span><span class="p">)</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="c1">// not in visible scope, no mangle</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">mangled</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span> <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mangled</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="c1">// already mangled in this scope</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newMangle</span><span class="p">)</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>                      <span class="c1">// not found and no mangling requested</span>
                <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">set_mangle</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">next_mangled</span><span class="p">());</span>
        <span class="p">},</span>
        <span class="nx">references</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">uses_with</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">uses_eval</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="p">},</span>
        <span class="nx">define</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="s2">&quot;var&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">ast_add_scope</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">current_scope</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">having_eval</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">function</span> <span class="nx">with_new_scope</span><span class="p">(</span><span class="nx">cont</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">current_scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scope</span><span class="p">(</span><span class="nx">current_scope</span><span class="p">);</span>
                <span class="nx">current_scope</span><span class="p">.</span><span class="nx">labels</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scope</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">current_scope</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">cont</span><span class="p">();</span>
                <span class="nx">ret</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="nx">current_scope</span><span class="p">;</span>
                <span class="nx">current_scope</span> <span class="o">=</span> <span class="nx">current_scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">current_scope</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">reference</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">current_scope</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_lambda</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">is_defun</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;defun&quot;</span><span class="p">;</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">is_defun</span> <span class="o">?</span> <span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;defun&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">with_new_scope</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_defun</span><span class="p">)</span> <span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">);</span>
                        <span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span> <span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;arg&quot;</span><span class="p">)</span> <span class="p">});</span>
                        <span class="k">return</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">);</span>
                <span class="p">})];</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">MAP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
                                <span class="nx">define</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">type</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="nx">reference</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                        <span class="p">});</span>
                <span class="p">};</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_breacont</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">label</span><span class="p">)</span>
                        <span class="nx">current_scope</span><span class="p">.</span><span class="nx">labels</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">with_new_scope</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>process AST</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                        <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">_lambda</span><span class="p">,</span>
                        <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="nx">_lambda</span><span class="p">,</span>
                        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span> <span class="nx">current_scope</span><span class="p">.</span><span class="nx">labels</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">},</span>
                        <span class="s2">&quot;break&quot;</span><span class="o">:</span> <span class="nx">_breacont</span><span class="p">,</span>
                        <span class="s2">&quot;continue&quot;</span><span class="o">:</span> <span class="nx">_breacont</span><span class="p">,</span>
                        <span class="s2">&quot;with&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">current_scope</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span>
                                        <span class="nx">s</span><span class="p">.</span><span class="nx">uses_with</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;var&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="s2">&quot;var&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;const&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span>
                                        <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="nx">MAP</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">walk</span><span class="p">),</span>
                                        <span class="p">[</span> <span class="nx">define</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;catch&quot;</span><span class="p">),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">],</span>
                                        <span class="nx">f</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
                                <span class="p">];</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span><span class="p">)</span>
                                        <span class="nx">having_eval</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">current_scope</span><span class="p">);</span>
                                <span class="nx">reference</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
                        <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>the reason why we need an additional pass here is
that names can be used prior to their definition.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>scopes where eval was detected and their parents
are marked with uses_eval, unless they define the
"eval" name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">MAP</span><span class="p">(</span><span class="nx">having_eval</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">))</span> <span class="k">while</span> <span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">scope</span><span class="p">.</span><span class="nx">uses_eval</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="nx">scope</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>for referenced names it might be useful to know
their origin scope.  current_scope here is the
toplevel one.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="kd">function</span> <span class="nx">fixrefs</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>do children first; order shouldn't matter</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span>
                                <span class="nx">fixrefs</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">refs</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">refs</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>find origin scope and propagate the reference to origin</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">s</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">===</span> <span class="nx">origin</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">};</span>
                <span class="nx">fixrefs</span><span class="p">(</span><span class="nx">current_scope</span><span class="p">);</span>

                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">});</span>

<span class="p">};</span>

<span class="cm">/* -----[ mangle names ]----- */</span>

<span class="kd">function</span> <span class="nx">ast_mangle</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">,</span> <span class="nx">scope</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="kd">function</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">newMangle</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">toplevel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="c1">// don&#39;t mangle toplevel</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">except</span> <span class="o">&amp;&amp;</span> <span class="nx">member</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">except</span><span class="p">))</span>
                        <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">get_mangled</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">newMangle</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">get_define</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">defines</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>we always lookup a defined symbol for the current scope FIRST, so declared
vars trump a DEFINE symbol, but if no such var is found, then match a DEFINE value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">defines</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">defines</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_lambda</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_functions</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">is_defun</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;defun&quot;</span><span class="p">,</span> <span class="nx">extra</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">is_defun</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="nx">extra</span> <span class="o">=</span> <span class="p">{};</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">uses_eval</span> <span class="o">||</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">uses_with</span><span class="p">))</span>
                                                <span class="nx">name</span> <span class="o">=</span> <span class="nx">extra</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">next_mangled</span><span class="p">();</span>
                                        <span class="k">else</span>
                                                <span class="nx">extra</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">body</span> <span class="o">=</span> <span class="nx">with_scope</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
                        <span class="nx">args</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span> <span class="k">return</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">});</span>
                        <span class="k">return</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">extra</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span> <span class="p">];</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">with_scope</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">cont</span><span class="p">,</span> <span class="nx">extra</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_scope</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">;</span>
                <span class="nx">scope</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">extra</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">extra</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">extra</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">s</span><span class="p">.</span><span class="nx">set_mangle</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">extra</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">names</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">cont</span><span class="p">();</span>
                <span class="nx">ret</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
                <span class="nx">scope</span> <span class="o">=</span> <span class="nx">_scope</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">];</span>
                <span class="p">})</span> <span class="p">];</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_breacont</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">labels</span><span class="p">.</span><span class="nx">get_mangled</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">];</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">_lambda</span><span class="p">,</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>move function declarations to the top when
they are not in some block.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="kd">var</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">_lambda</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">parent</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span>
                            <span class="k">case</span> <span class="s2">&quot;function&quot;</span><span class="o">:</span>
                            <span class="k">case</span> <span class="s2">&quot;defun&quot;</span><span class="o">:</span>
                                <span class="k">return</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">at_top</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">ast</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">labels</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">label</span><span class="p">])</span> <span class="k">return</span> <span class="p">[</span>
                                <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="nx">scope</span><span class="p">.</span><span class="nx">labels</span><span class="p">.</span><span class="nx">get_mangled</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                                <span class="nx">walk</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span>
                        <span class="p">];</span>
                        <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">stat</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;break&quot;</span><span class="o">:</span> <span class="nx">_breacont</span><span class="p">,</span>
                <span class="s2">&quot;continue&quot;</span><span class="o">:</span> <span class="nx">_breacont</span><span class="p">,</span>
                <span class="s2">&quot;var&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">,</span>
                <span class="s2">&quot;const&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">get_define</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="nx">MAP</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">walk</span><span class="p">),</span>
                                 <span class="nx">c</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">get_mangled</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                 <span class="nx">f</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">with_scope</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="nx">self</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">)</span> <span class="p">];</span>
                        <span class="p">});</span>
                <span class="p">}</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast_add_scope</span><span class="p">(</span><span class="nx">ast</span><span class="p">));</span>
        <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>-----[
- compress foo["bar"] into foo.bar,
- remove block brackets {} where possible
- join consecutive var declarations
- various optimizations for IFs:
- if (cond) foo(); else bar();  ==>  cond?foo():bar();
- if (cond) foo();  ==>  cond&amp;&amp;foo();
- if (foo) return bar(); else return baz();  ==> return foo?bar():baz(); // also for throw
- if (foo) return bar(); else something();  ==> {if(foo)return bar();something()}
]-----   </p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">warn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>

<span class="kd">function</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ast1</span><span class="p">,</span> <span class="nx">ast2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast1</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span> <span class="o">?</span> <span class="nx">ast2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">ast2</span><span class="p">).</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">ast2</span> <span class="o">:</span> <span class="nx">ast1</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">last_stat</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="k">return</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">aborts</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="k">switch</span> <span class="p">(</span><span class="nx">last_stat</span><span class="p">(</span><span class="nx">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;return&quot;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s2">&quot;break&quot;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s2">&quot;continue&quot;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s2">&quot;throw&quot;</span><span class="o">:</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">member</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span> <span class="p">]))</span> <span class="o">||</span>

                 <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">member</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;instanceof&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="s2">&quot;===&quot;</span><span class="p">,</span> <span class="s2">&quot;!==&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="p">]))</span> <span class="o">||</span>

                 <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">member</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span> <span class="p">])</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">||</span>

                 <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;conditional&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">||</span>

                 <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="kc">true</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">||</span>

                 <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;seq&quot;</span>
                  <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="nx">expr</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
               <span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">b</span> <span class="o">||</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">is_string</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">||</span>
                <span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;typeof&quot;</span> <span class="o">||</span>
                <span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">||</span> <span class="nx">is_string</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])));</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">when_constant</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

        <span class="kd">var</span> <span class="nx">$NOT_CONSTANT</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>this can only evaluate constant expressions.  If it finds anything
not constant, it throws $NOT_CONSTANT.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">function</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s2">&quot;string&quot;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s2">&quot;num&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                    <span class="k">case</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s2">&quot;atom&quot;</span><span class="o">:</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;true&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s2">&quot;false&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s2">&quot;null&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;!&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="o">!</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                            <span class="k">case</span> <span class="s2">&quot;typeof&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="k">typeof</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                            <span class="k">case</span> <span class="s2">&quot;~&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="o">~</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                            <span class="k">case</span> <span class="s2">&quot;-&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="o">-</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                            <span class="k">case</span> <span class="s2">&quot;+&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="o">+</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;binary&quot;</span><span class="o">:</span>
                        <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;&amp;&amp;&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&amp;&amp;</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;||&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">||</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;|&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">|</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&amp;&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&amp;</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;^&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">^</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;+&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">+</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;*&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">*</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;/&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">/</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;%&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">%</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;-&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">-</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&lt;&lt;&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&lt;&lt;</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;&gt;&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&gt;&gt;</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;&gt;&gt;&quot;</span>        <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>        <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;==&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">==</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;===&quot;</span>        <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">===</span>        <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;!=&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">!=</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;!==&quot;</span>        <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">!==</span>        <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&lt;&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&lt;</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&lt;=&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&lt;=</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;&quot;</span>          <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&gt;</span>          <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;=&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="o">&gt;=</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;in&quot;</span>         <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="k">in</span>         <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                            <span class="k">case</span> <span class="s2">&quot;instanceof&quot;</span> <span class="o">:</span> <span class="k">return</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="nx">$NOT_CONSTANT</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">yes</span><span class="p">,</span> <span class="nx">no</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">ast</span><span class="p">;</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;string&quot;</span><span class="o">:</span> <span class="nx">ast</span> <span class="o">=</span>  <span class="p">[</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nx">val</span> <span class="p">];</span> <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s2">&quot;number&quot;</span><span class="o">:</span> <span class="nx">ast</span> <span class="o">=</span>  <span class="p">[</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="nx">val</span> <span class="p">];</span> <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s2">&quot;boolean&quot;</span><span class="o">:</span> <span class="nx">ast</span> <span class="o">=</span>  <span class="p">[</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">];</span> <span class="k">break</span><span class="p">;</span>
                            <span class="k">default</span><span class="o">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="nx">ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span> <span class="p">];</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
                                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t handle constant of type: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">yes</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">===</span> <span class="nx">$NOT_CONSTANT</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
                                    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;===&quot;</span> <span class="o">||</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!==&quot;</span><span class="p">)</span>
                                    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">is_string</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">is_string</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                                        <span class="o">||</span> <span class="p">(</span><span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))))</span> <span class="p">{</span>
                                        <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">no</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
                                         <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;||&quot;</span> <span class="o">||</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>the whole expression is not constant but the lval may be...</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                    <span class="k">try</span> <span class="p">{</span>
                                        <span class="kd">var</span> <span class="nx">lval</span> <span class="o">=</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                                        <span class="nx">expr</span> <span class="o">=</span> <span class="p">((</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&amp;&amp;&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">lval</span> <span class="o">?</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="nx">lval</span><span class="p">))</span>    <span class="o">||</span>
                                                <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;||&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">lval</span> <span class="o">?</span> <span class="nx">lval</span>    <span class="o">:</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">||</span>
                                                <span class="nx">expr</span><span class="p">);</span>
                                    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">ex2</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>IGNORE... lval is not constant</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="k">return</span> <span class="nx">no</span> <span class="o">?</span> <span class="nx">no</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">};</span>

<span class="p">})();</span>

<span class="kd">function</span> <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">empty</span><span class="p">(</span><span class="nx">ast</span><span class="p">))</span>
                <span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Dropping unreachable code: &quot;</span> <span class="o">+</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">prepare_ifs</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>In this first pass, we rewrite ifs which abort with no else with an
if-else.  For example:</p>

<p>if (x) {
    blah();
    return y;
}
foobar();</p>

<p>is rewritten into:</p>

<p>if (x) {
    blah();
    return y;
} else {
    foobar();
}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">function</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">statements</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">walk</span><span class="p">);</span>

                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">statements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">fi</span> <span class="o">=</span> <span class="nx">statements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;if&quot;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">fi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">fi</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="k">continue</span><span class="p">;</span>

                        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">fi</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aborts</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

                        <span class="kd">var</span> <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">fi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

                        <span class="kd">var</span> <span class="nx">e_body</span> <span class="o">=</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">statements</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
                        <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">e_body</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">e_body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="nx">e_body</span> <span class="p">];</span>

                        <span class="k">return</span> <span class="nx">statements</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">concat</span><span class="p">([</span> <span class="p">[</span>
                                <span class="nx">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>          <span class="c1">// &quot;if&quot;</span>
                                <span class="nx">conditional</span><span class="p">,</span>    <span class="c1">// conditional</span>
                                <span class="nx">t</span><span class="p">,</span>              <span class="c1">// then</span>
                                <span class="nx">e</span>               <span class="c1">// else</span>
                        <span class="p">]</span> <span class="p">]);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">statements</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">redo_if_lambda</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">body</span> <span class="o">=</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span> <span class="p">];</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">redo_if_block</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">statements</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span> <span class="p">];</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="nx">redo_if_lambda</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">redo_if_lambda</span><span class="p">,</span>
                <span class="s2">&quot;block&quot;</span><span class="o">:</span> <span class="nx">redo_if_block</span><span class="p">,</span>
                <span class="s2">&quot;splice&quot;</span><span class="o">:</span> <span class="nx">redo_if_block</span><span class="p">,</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span>
                                <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="nx">redo_if</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span>
                                <span class="nx">c</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                <span class="nx">f</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">redo_if</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
                        <span class="p">];</span>
                <span class="p">}</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">for_side_effects</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">$stop</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">$restart</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="kd">function</span> <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">$stop</span> <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">restart</span><span class="p">()</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">$restart</span> <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">found</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">restart</span><span class="p">)</span> <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">unary</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">op</span> <span class="o">==</span> <span class="s2">&quot;++&quot;</span> <span class="o">||</span> <span class="nx">op</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nx">found</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;throw&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;return&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;new&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;switch&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;break&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;continue&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;assign&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;call&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;if&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;for&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;for-in&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;while&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;do&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;return&quot;</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span>
                <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span> <span class="nx">unary</span><span class="p">,</span>
                <span class="s2">&quot;unary-postfix&quot;</span><span class="o">:</span> <span class="nx">unary</span><span class="p">,</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="nx">found</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="k">try</span> <span class="p">{</span>
                        <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">===</span> <span class="nx">$stop</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">===</span> <span class="nx">$restart</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                        <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">ast_lift_variables</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">,</span> <span class="nx">scope</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">do_body</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_scope</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">;</span>
                <span class="nx">scope</span> <span class="o">=</span> <span class="nx">env</span><span class="p">;</span>
                <span class="nx">body</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">walk</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">name</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!=</span> <span class="s2">&quot;var&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">skip</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">env</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="k">return</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">skip</span><span class="p">;</span>
                        <span class="nx">hash</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>looking for assignments to any of these variables.
we can save considerable space by moving the definitions
in the var declaration.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="nx">for_side_effects</span><span class="p">([</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="nx">body</span> <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">walker</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">restart</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span>
                                    <span class="o">&amp;&amp;</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="kc">true</span>
                                    <span class="o">&amp;&amp;</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span>
                                    <span class="o">&amp;&amp;</span> <span class="nx">HOP</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>insert the definition into the var declaration</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
                                                <span class="k">if</span> <span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                                                        <span class="k">if</span> <span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="c1">// this name already defined, we must stop</span>
                                                                <span class="nx">stop</span><span class="p">();</span>
                                                        <span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// definition</span>
                                                        <span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
                                                        <span class="k">break</span><span class="p">;</span>
                                                <span class="p">}</span>
                                        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>remove this assignment from the AST.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">walker</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;seq&quot;</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                                                <span class="nx">a</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                                                <span class="nx">p</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
                                        <span class="p">}</span>
                                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="nx">p</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;block&quot;</span><span class="p">);</span> <span class="c1">// empty statement</span>
                                        <span class="p">}</span>
                                        <span class="k">else</span> <span class="p">{</span>
                                                <span class="nx">stop</span><span class="p">();</span>
                                        <span class="p">}</span>
                                        <span class="nx">restart</span><span class="p">();</span>
                                <span class="p">}</span>
                                <span class="nx">stop</span><span class="p">();</span>
                        <span class="p">});</span>
                        <span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span><span class="p">([</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="nx">names</span> <span class="p">]);</span>
                <span class="p">}</span>
                <span class="nx">scope</span> <span class="o">=</span> <span class="nx">_scope</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">body</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">_vardefs</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">defs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">defs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
                        <span class="nx">d</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
                        <span class="k">else</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">ret</span> <span class="p">];</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">parent</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;for-in&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nx">defs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
                        <span class="k">return</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">skip</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="nx">ret</span> <span class="p">];</span>
        <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">_toplevel</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">do_body</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="p">];</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">){</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);)</span>
                                <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">do_body</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="k">return</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">skip</span><span class="p">;</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);)</span>
                                <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">do_body</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;var&quot;</span><span class="o">:</span> <span class="nx">_vardefs</span><span class="p">,</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="nx">_toplevel</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast_add_scope</span><span class="p">(</span><span class="nx">ast</span><span class="p">));</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">ast_squeeze</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">make_seqs</span>   <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">dead_code</span>   <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">no_warnings</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">keep_comps</span>  <span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">walk</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">not_c</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="nx">c</span> <span class="p">];</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">boolean_expr</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">?</span> <span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="nx">not_c</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;seq&quot;</span><span class="o">:</span>
                        <span class="nx">c</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                        <span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
                        <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;conditional&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">not_c</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">]);</span>
                    <span class="k">case</span> <span class="s2">&quot;binary&quot;</span><span class="o">:</span>
                        <span class="kd">var</span> <span class="nx">op</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">keep_comps</span><span class="p">)</span> <span class="k">switch</span> <span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;&lt;=&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;&lt;&quot;</span>   <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;=&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;&gt;&quot;</span>   <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                        <span class="p">}</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;==&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;!=&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;===&quot;</span> <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;!==&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;!==&quot;</span> <span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;===&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">];</span>
                            <span class="k">case</span> <span class="s2">&quot;&amp;&amp;&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">not_c</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span><span class="p">,</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="p">]);</span>
                            <span class="k">case</span> <span class="s2">&quot;||&quot;</span>  <span class="o">:</span> <span class="k">return</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">not_c</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="p">]);</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">not_c</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_conditional</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">make_real_conditional</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">e</span> <span class="o">?</span> <span class="p">[</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">t</span> <span class="p">]</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">t</span> <span class="p">];</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">e</span> <span class="o">?</span> <span class="nx">best_of</span><span class="p">(</span>
                                        <span class="p">[</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span> <span class="p">],</span>
                                        <span class="p">[</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">t</span> <span class="p">]</span>
                                <span class="p">)</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">t</span> <span class="p">];</span>
                        <span class="p">}</span>
                <span class="p">};</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>shortcut the conditional if the expression has a constant value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">return</span> <span class="nx">when_constant</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">val</span><span class="p">){</span>
                        <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">val</span> <span class="o">?</span> <span class="nx">e</span> <span class="o">:</span> <span class="nx">t</span><span class="p">);</span>
                        <span class="k">return</span>          <span class="p">(</span><span class="nx">val</span> <span class="o">?</span> <span class="nx">t</span> <span class="o">:</span> <span class="nx">e</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">make_real_conditional</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">rmblock</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">block</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">block</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nx">block</span> <span class="o">=</span> <span class="nx">block</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">block</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="nx">block</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;block&quot;</span> <span class="p">];</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">block</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_lambda</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">)</span> <span class="p">];</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>this function does a few things:
1. discard useless blocks
2. join consecutive var declarations
3. remove obviously dead code
4. transform consecutive statements using the comma operator
5. if block_type == "lambda" and it detects constructs like if(foo) return ... - rewrite like if (!foo) { ... }</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">function</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">block_type</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">statements</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">walk</span><span class="p">);</span>

                <span class="nx">statements</span> <span class="o">=</span> <span class="nx">statements</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">stat</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                                        <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                                <span class="p">}</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stat</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
                <span class="p">},</span> <span class="p">[]);</span>

                <span class="nx">statements</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">prev</span><span class="p">){</span>
                        <span class="nx">statements</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cur</span><span class="p">){</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">)</span> <span class="o">||</span>
                                             <span class="p">(</span><span class="nx">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span><span class="p">)))</span> <span class="p">{</span>
                                        <span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
                                        <span class="nx">prev</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">});</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
                <span class="p">})([]);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">dead_code</span><span class="p">)</span> <span class="nx">statements</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">has_quit</span><span class="p">){</span>
                        <span class="nx">statements</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">st</span><span class="p">){</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">has_quit</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">||</span> <span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;defun&quot;</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span>
                                        <span class="p">}</span>
                                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span> <span class="o">||</span> <span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_warnings</span><span class="p">)</span>
                                                        <span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Variables declared in unreachable code&quot;</span><span class="p">);</span>
                                                <span class="nx">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">def</span><span class="p">){</span>
                                                        <span class="k">if</span> <span class="p">(</span><span class="nx">def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_warnings</span><span class="p">)</span>
                                                                <span class="nx">warn_unreachable</span><span class="p">([</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nx">def</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">],</span> <span class="nx">def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]);</span>
                                                        <span class="k">return</span> <span class="p">[</span> <span class="nx">def</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">];</span>
                                                <span class="p">});</span>
                                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span>
                                        <span class="p">}</span>
                                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_warnings</span><span class="p">)</span>
                                                <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">member</span><span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;return&quot;</span><span class="p">,</span> <span class="s2">&quot;throw&quot;</span><span class="p">,</span> <span class="s2">&quot;break&quot;</span><span class="p">,</span> <span class="s2">&quot;continue&quot;</span> <span class="p">]))</span>
                                                <span class="nx">has_quit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">});</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
                <span class="p">})([]);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">make_seqs</span><span class="p">)</span> <span class="nx">statements</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">statements</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cur</span><span class="p">){</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
                                        <span class="nx">prev</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">});</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                            <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span>
                            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span> <span class="o">||</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;throw&quot;</span><span class="p">)</span>
                            <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="p">{</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                         <span class="p">[</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="p">[</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">]]);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
                <span class="p">})([]);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>this increases jQuery by 1K.  Probably not such a good idea after all..
part of this is done in prepare_ifs anyway.
if (block_type == "lambda") statements = (function(i, a, stat){
        while (i &lt; statements.length) {
                stat = statements[i++];
                if (stat[0] == "if" &amp;&amp; !stat[3]) {
                        if (stat[2][0] == "return" &amp;&amp; stat[2][1] == null) {
                                a.push(make_if(negate(stat[1]), [ "block", statements.slice(i) ]));
                                break;
                        }
                        var last = last_stat(stat[2]);
                        if (last[0] == "return" &amp;&amp; last[1] == null) {
                                a.push(make_if(stat[1], [ "block", stat[2][1].slice(0, -1) ], [ "block", statements.slice(i) ]));
                                break;
                        }
                }
                a.push(stat);
        }
        return a;
})(0, []);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

                <span class="k">return</span> <span class="nx">statements</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_if</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">when_constant</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">val</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">t</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
                                <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                                <span class="k">return</span> <span class="nx">t</span> <span class="o">||</span> <span class="p">[</span> <span class="s2">&quot;block&quot;</span> <span class="p">];</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">e</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                                <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
                                <span class="k">return</span> <span class="nx">e</span> <span class="o">||</span> <span class="p">[</span> <span class="s2">&quot;block&quot;</span> <span class="p">];</span>
                        <span class="p">}</span>
                <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">make_real_if</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
                <span class="p">});</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">abort_else</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">e</span> <span class="p">]</span> <span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">walk</span><span class="p">([</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="nx">ret</span> <span class="p">]);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_real_if</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">c</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                <span class="nx">t</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
                <span class="nx">e</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">empty</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">c</span> <span class="o">=</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                        <span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
                        <span class="nx">e</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">empty</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">e</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>if we have both else and then, maybe it makes sense to switch them?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                                <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                                <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
                                        <span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
                                        <span class="nx">e</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
                                        <span class="nx">c</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">})();</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">empty</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="nx">c</span> <span class="p">];</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span> <span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;if&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">walk</span><span class="p">([</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">],</span> <span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span><span class="p">)</span>
                                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="nx">make_conditional</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]);</span>
                                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">aborts</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span>
                                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">abort_else</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">ret</span> <span class="o">=</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="nx">make_conditional</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span> <span class="o">||</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;throw&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="p">[</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">make_conditional</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">aborts</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">t</span> <span class="p">]</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">([</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="nx">ret</span> <span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">aborts</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">abort_else</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">_do_while</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">when_constant</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cond</span><span class="p">,</span> <span class="nx">val</span><span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">warn_unreachable</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;block&quot;</span> <span class="p">];</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">];</span>
                        <span class="p">}</span>
                <span class="p">});</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;sub&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">subscript</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">subscript</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">subscript</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">is_identifier</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
                                        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">name</span> <span class="p">];</span>
                                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^[1-9][0-9]*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
                                        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="p">[</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="p">]</span> <span class="p">];</span>
                        <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;if&quot;</span><span class="o">:</span> <span class="nx">make_if</span><span class="p">,</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;toplevel&quot;</span><span class="p">,</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;switch&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;switch&quot;</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">branch</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
                                <span class="kd">var</span> <span class="nx">block</span> <span class="o">=</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="nx">block</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">block</span><span class="p">[</span><span class="nx">block</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;break&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                <span class="nx">block</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                                <span class="p">}</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">block</span> <span class="p">];</span>
                        <span class="p">})</span> <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">_lambda</span><span class="p">,</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="nx">_lambda</span><span class="p">,</span>
                <span class="s2">&quot;block&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">rmblock</span><span class="p">([</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;binary&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">when_constant</span><span class="p">([</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="p">],</span> <span class="kd">function</span> <span class="nx">yes</span><span class="p">(</span><span class="nx">c</span><span class="p">){</span>
                                <span class="k">return</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">walk</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="k">this</span><span class="p">);</span>
                        <span class="p">},</span> <span class="kd">function</span> <span class="nx">no</span><span class="p">()</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
                                        <span class="k">if</span><span class="p">(</span><span class="nx">op</span> <span class="o">!=</span> <span class="s2">&quot;==&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">op</span> <span class="o">!=</span> <span class="s2">&quot;!=&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                                        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">right</span><span class="p">);</span>
                                        <span class="k">if</span><span class="p">(</span><span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;num&quot;</span><span class="p">)</span>
                                                <span class="nx">left</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="o">+!</span><span class="nx">l</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]];</span>
                                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;num&quot;</span><span class="p">)</span>
                                                <span class="nx">right</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="o">+!</span><span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]];</span>
                                        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">];</span>
                                <span class="p">}()</span> <span class="o">||</span> <span class="k">this</span><span class="p">;</span>
                        <span class="p">});</span>
                <span class="p">},</span>
                <span class="s2">&quot;conditional&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">make_conditional</span><span class="p">(</span><span class="nx">walk</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span>
                <span class="p">},</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">[</span>
                                <span class="s2">&quot;try&quot;</span><span class="p">,</span>
                                <span class="nx">tighten</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span>
                                <span class="nx">c</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                <span class="nx">f</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">tighten</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
                        <span class="p">];</span>
                <span class="p">},</span>
                <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">expr</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">expr</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">op</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">)</span>
                                <span class="nx">ret</span> <span class="o">=</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">negate</span><span class="p">(</span><span class="nx">expr</span><span class="p">));</span>
                        <span class="k">return</span> <span class="nx">when_constant</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">val</span><span class="p">){</span>
                                <span class="k">return</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span> <span class="c1">// it&#39;s either true or false, so minifies to !0 or !1</span>
                        <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ret</span> <span class="p">});</span>
                <span class="p">},</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s2">&quot;true&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]];</span>
                            <span class="k">case</span> <span class="s2">&quot;false&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;unary-prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]];</span>
                        <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;while&quot;</span><span class="o">:</span> <span class="nx">_do_while</span><span class="p">,</span>
                <span class="s2">&quot;assign&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">lvalue</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">lvalue</span><span class="p">);</span>
                        <span class="nx">rvalue</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">okOps</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">op</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">lvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;name&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">rvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;binary&quot;</span> <span class="o">&amp;&amp;</span>
                            <span class="o">~</span><span class="nx">okOps</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">rvalue</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;name&quot;</span> <span class="o">&amp;&amp;</span>
                            <span class="nx">rvalue</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">lvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">]</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span> <span class="p">];</span>
                <span class="p">}</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ast</span> <span class="o">=</span> <span class="nx">prepare_ifs</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                        <span class="nx">ast</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ast</span><span class="p">;</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="cm">/* -----[ re-generate code from the AST ]----- */</span>

<span class="kd">var</span> <span class="nx">DOT_CALL_NO_PARENS</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">array_to_hash</span><span class="p">([</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sub&quot;</span><span class="p">,</span>
        <span class="s2">&quot;call&quot;</span><span class="p">,</span>
        <span class="s2">&quot;regexp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;defun&quot;</span>
<span class="p">]);</span>

<span class="kd">function</span> <span class="nx">make_string</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">ascii_only</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\\\b\f\n\r\t\x22\x27\u2028\u2029\0]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s2">&quot;\\&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\\\&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\b&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\b&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\f&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\f&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\n&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\n&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\r&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\r&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\t&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\t&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\u2028&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\u2028&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\u2029&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\u2029&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">:</span> <span class="o">++</span><span class="nx">dq</span><span class="p">;</span> <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">:</span> <span class="o">++</span><span class="nx">sq</span><span class="p">;</span> <span class="k">return</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s2">&quot;\0&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;\\0&quot;</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ascii_only</span><span class="p">)</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">to_ascii</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">&gt;</span> <span class="nx">sq</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\x27/g</span><span class="p">,</span> <span class="s2">&quot;\\&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\x22/g</span><span class="p">,</span> <span class="s1">&#39;\\&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">to_ascii</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\u0080-\uffff]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
                <span class="k">while</span> <span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">;</span>
                <span class="k">return</span> <span class="s2">&quot;\\u&quot;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">;</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">SPLICE_NEEDS_BRACKETS</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">array_to_hash</span><span class="p">([</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;while&quot;</span><span class="p">,</span> <span class="s2">&quot;do&quot;</span><span class="p">,</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="s2">&quot;for-in&quot;</span><span class="p">,</span> <span class="s2">&quot;with&quot;</span> <span class="p">]);</span>

<span class="kd">function</span> <span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">indent_start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">indent_level</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="nx">quote_keys</span>   <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">space_colon</span>  <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">beautify</span>     <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">ascii_only</span>   <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">inline_script</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">beautify</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">beautify</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">newline</span> <span class="o">=</span> <span class="nx">beautify</span> <span class="o">?</span> <span class="s2">&quot;\n&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nx">space</span> <span class="o">=</span> <span class="nx">beautify</span> <span class="o">?</span> <span class="s2">&quot; &quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">encode_string</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">make_string</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ascii_only</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">inline_script</span><span class="p">)</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;\x2fscript([&gt;\/\t\n\f\r ])/gi</span><span class="p">,</span> <span class="s2">&quot;&lt;\\/script$1&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ascii_only</span><span class="p">)</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="nx">to_ascii</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">indent</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">line</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nx">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">beautify</span><span class="p">)</span>
                        <span class="nx">line</span> <span class="o">=</span> <span class="nx">repeat_string</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">indent_start</span> <span class="o">+</span> <span class="nx">indentation</span> <span class="o">*</span> <span class="nx">options</span><span class="p">.</span><span class="nx">indent_level</span><span class="p">)</span> <span class="o">+</span> <span class="nx">line</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">with_indent</span><span class="p">(</span><span class="nx">cont</span><span class="p">,</span> <span class="nx">incr</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">incr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">incr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">indentation</span> <span class="o">+=</span> <span class="nx">incr</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">cont</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">slice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span> <span class="p">}</span>
                <span class="k">finally</span> <span class="p">{</span> <span class="nx">indentation</span> <span class="o">-=</span> <span class="nx">incr</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">add_spaces</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">beautify</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                        <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span>
                            <span class="p">((</span><span class="sr">/[a-z0-9_\x24]$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toString</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="sr">/^[a-z0-9_\x24]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">toString</span><span class="p">()))</span> <span class="o">||</span>
                             <span class="p">(</span><span class="sr">/[\+\-]$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toString</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="sr">/^[\+\-]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">toString</span><span class="p">()))))</span> <span class="p">{</span>
                                <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">space</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">((</span><span class="nx">el</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">(</span><span class="nx">expr</span><span class="p">))</span> <span class="o">||</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">el</span><span class="p">)</span>
                                <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">gen</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">gen</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                        <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">a</span> <span class="o">:</span> <span class="nx">b</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">best_of</span><span class="p">([</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">]);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">needs_parens</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">||</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>dot/call on a literal function requires the
function literal itself to be parenthesized
only if it's the first "thing" in a
statement.  This means that the parent is
"stat", but it could also be a "seq" and
we're the first in this "seq" and the
parent is "stat", and so on.  Messy stuff,
but it worths the trouble.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">stack</span><span class="p">()),</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="k">while</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stat&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(((</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;seq&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dot&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sub&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;conditional&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">self</span><span class="p">)</span> <span class="o">||</span>
                                    <span class="p">((</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span> <span class="o">||</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-postfix&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">self</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="nx">self</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
                                        <span class="nx">p</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">DOT_CALL_NO_PARENS</span><span class="p">,</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_num</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^0\./</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="p">],</span> <span class="nx">m</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="o">===</span> <span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="c1">// probably pointless</span>
                                       <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span> <span class="c1">// same.</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;-0x&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">num</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="c1">// probably pointless</span>
                                       <span class="s2">&quot;-0&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">num</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span> <span class="c1">// same.</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">((</span><span class="nx">m</span> <span class="o">=</span> <span class="sr">/^(.*?)(0+)$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">num</span><span class="p">)))</span> <span class="p">{</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;e&quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">m</span> <span class="o">=</span> <span class="sr">/^0?\.(0+)(.*)$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">num</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;e-&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span><span class="p">),</span>
                               <span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)));</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">best_of</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">make</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                <span class="s2">&quot;string&quot;</span><span class="o">:</span> <span class="nx">encode_string</span><span class="p">,</span>
                <span class="s2">&quot;num&quot;</span><span class="o">:</span> <span class="nx">make_num</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="nx">make_name</span><span class="p">,</span>
                <span class="s2">&quot;debugger&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="s2">&quot;debugger&quot;</span> <span class="p">},</span>
                <span class="s2">&quot;toplevel&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">make_block_statements</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">newline</span> <span class="o">+</span> <span class="nx">newline</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;splice&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">SPLICE_NEEDS_BRACKETS</span><span class="p">,</span> <span class="nx">parent</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>we need block brackets in this case</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                <span class="k">return</span> <span class="nx">make_block</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">make_block_statements</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                                           <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>the first line is already indented</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                                   <span class="k">return</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">indent</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">:</span> <span class="nx">line</span><span class="p">;</span>
                                           <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="nx">newline</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;block&quot;</span><span class="o">:</span> <span class="nx">make_block</span><span class="p">,</span>
                <span class="s2">&quot;var&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="s2">&quot;var &quot;</span> <span class="o">+</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="nx">make_1vardef</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;const&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="s2">&quot;const &quot;</span> <span class="o">+</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="nx">make_1vardef</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;try&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tr</span><span class="p">,</span> <span class="nx">ca</span><span class="p">,</span> <span class="nx">fi</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;try&quot;</span><span class="p">,</span> <span class="nx">make_block</span><span class="p">(</span><span class="nx">tr</span><span class="p">)</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ca</span><span class="p">)</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;catch&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">ca</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make_block</span><span class="p">(</span><span class="nx">ca</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">fi</span><span class="p">)</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;finally&quot;</span><span class="p">,</span> <span class="nx">make_block</span><span class="p">(</span><span class="nx">fi</span><span class="p">));</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;throw&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;throw&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;new&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctor</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">){</span>
                                <span class="k">return</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">);</span>
                        <span class="p">}))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">ctor</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">){</span>
                                <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">(),</span> <span class="nx">has_call</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="k">try</span> <span class="p">{</span>
                                        <span class="nx">w</span><span class="p">.</span><span class="nx">with_walkers</span><span class="p">({</span>
                                                <span class="s2">&quot;call&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">has_call</span> <span class="p">},</span>
                                                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span> <span class="p">}</span>
                                        <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
                                                <span class="nx">w</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                                        <span class="p">});</span>
                                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">===</span> <span class="nx">has_call</span><span class="p">)</span>
                                                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                                        <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">})</span> <span class="o">+</span> <span class="nx">args</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;switch&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;switch&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make_switch_block</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;break&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s2">&quot;break&quot;</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">label</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                                <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;continue&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">label</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                                <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;conditional&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">co</span><span class="p">,</span> <span class="nx">th</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">co</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="s2">&quot;conditional&quot;</span><span class="p">),</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span>
                                            <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">th</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">),</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
                                            <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;assign&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">op</span> <span class="o">&amp;&amp;</span> <span class="nx">op</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="nx">op</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="p">;</span>
                        <span class="k">else</span> <span class="nx">op</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">make</span><span class="p">(</span><span class="nx">lvalue</span><span class="p">),</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;dot&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">),</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;num&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/\./</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                        <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">needs_parens</span><span class="p">(</span><span class="nx">expr</span><span class="p">))</span>
                                <span class="nx">out</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                                <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]);</span>
                        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;call&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;(&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">needs_parens</span><span class="p">(</span><span class="nx">func</span><span class="p">))</span>
                                <span class="nx">f</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">f</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">){</span>
                                <span class="k">return</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">);</span>
                        <span class="p">}))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">make_function</span><span class="p">,</span>
                <span class="s2">&quot;defun&quot;</span><span class="o">:</span> <span class="nx">make_function</span><span class="p">,</span>
                <span class="s2">&quot;if&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">co</span><span class="p">,</span> <span class="nx">th</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">co</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">el</span> <span class="o">?</span> <span class="nx">make_then</span><span class="p">(</span><span class="nx">th</span><span class="p">)</span> <span class="o">:</span> <span class="nx">make</span><span class="p">(</span><span class="nx">th</span><span class="p">)</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">el</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;for&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">init</span><span class="p">,</span> <span class="nx">cond</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;for&quot;</span> <span class="p">];</span>
                        <span class="nx">init</span> <span class="o">=</span> <span class="p">(</span><span class="nx">init</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">make</span><span class="p">(</span><span class="nx">init</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;*\s*$/</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span> <span class="o">+</span> <span class="nx">space</span><span class="p">);</span>
                        <span class="nx">cond</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cond</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">make</span><span class="p">(</span><span class="nx">cond</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;*\s*$/</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span> <span class="o">+</span> <span class="nx">space</span><span class="p">);</span>
                        <span class="nx">step</span> <span class="o">=</span> <span class="p">(</span><span class="nx">step</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">make</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;*\s*$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">init</span> <span class="o">+</span> <span class="nx">cond</span> <span class="o">+</span> <span class="nx">step</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span> <span class="o">==</span> <span class="s2">&quot;; ; &quot;</span><span class="p">)</span> <span class="nx">args</span> <span class="o">=</span> <span class="s2">&quot;;;&quot;</span><span class="p">;</span>
                        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">args</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">));</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;for-in&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vvar</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span>
                                            <span class="p">(</span><span class="nx">vvar</span> <span class="o">?</span> <span class="nx">make</span><span class="p">(</span><span class="nx">vvar</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;+$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">make</span><span class="p">(</span><span class="nx">key</span><span class="p">)),</span>
                                            <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                                            <span class="nx">make</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;while&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">condition</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;while&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">condition</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;do&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">condition</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;do&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">),</span> <span class="s2">&quot;while&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">condition</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;return&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;return&quot;</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">expr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">));</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;binary&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">lvalue</span><span class="p">,</span> <span class="nx">rvalue</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">lvalue</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>XXX: I'm pretty sure other cases will bite here.
     we need to be smarter.
     adding parens all the time is the safest bet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">member</span><span class="p">(</span><span class="nx">lvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span> <span class="p">])</span> <span class="o">||</span>
                            <span class="nx">lvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">PRECEDENCE</span><span class="p">[</span><span class="nx">operator</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">PRECEDENCE</span><span class="p">[</span><span class="nx">lvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">||</span>
                            <span class="nx">lvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">needs_parens</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">left</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">member</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span> <span class="p">])</span> <span class="o">||</span>
                            <span class="nx">rvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">PRECEDENCE</span><span class="p">[</span><span class="nx">operator</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">PRECEDENCE</span><span class="p">[</span><span class="nx">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;&amp;</span>
                            <span class="o">!</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">operator</span> <span class="o">&amp;&amp;</span> <span class="nx">member</span><span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span> <span class="p">])))</span> <span class="p">{</span>
                                <span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">right</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">inline_script</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">||</span> <span class="nx">operator</span> <span class="o">==</span> <span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">)</span>
                                 <span class="o">&amp;&amp;</span> <span class="nx">rvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;regexp&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^script/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                                <span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">right</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">right</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;unary-prefix&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;num&quot;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-prefix&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">OPERATORS</span><span class="p">,</span> <span class="nx">operator</span> <span class="o">+</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">||</span> <span class="o">!</span><span class="nx">needs_parens</span><span class="p">(</span><span class="nx">expr</span><span class="p">)))</span>
                                <span class="nx">val</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">operator</span> <span class="o">+</span> <span class="p">(</span><span class="nx">jsp</span><span class="p">.</span><span class="nx">is_alphanumeric_char</span><span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">?</span> <span class="s2">&quot; &quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">val</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;unary-postfix&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;num&quot;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unary-postfix&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">OPERATORS</span><span class="p">,</span> <span class="nx">operator</span> <span class="o">+</span> <span class="nx">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">||</span> <span class="o">!</span><span class="nx">needs_parens</span><span class="p">(</span><span class="nx">expr</span><span class="p">)))</span>
                                <span class="nx">val</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">val</span> <span class="o">+</span> <span class="nx">operator</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;sub&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">subscript</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">needs_parens</span><span class="p">(</span><span class="nx">expr</span><span class="p">))</span>
                                <span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">hash</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">hash</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">subscript</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;object&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">obj_needs_parens</span> <span class="o">=</span> <span class="nx">needs_parens</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="k">return</span> <span class="nx">obj_needs_parens</span> <span class="o">?</span> <span class="s2">&quot;({})&quot;</span> <span class="o">:</span> <span class="s2">&quot;{}&quot;</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">with_indent</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                                <span class="k">return</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>getter/setter.  The name is in p[0], the arg.list in p[1][2], the
body in p[1][3] and type ("get" / "set") in p[2].</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                                <span class="k">return</span> <span class="nx">indent</span><span class="p">(</span><span class="nx">make_function</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
                                        <span class="p">}</span>
                                        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;seq&quot;</span><span class="p">);</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">quote_keys</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="nx">key</span> <span class="o">=</span> <span class="nx">encode_string</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="o">+</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">==</span> <span class="nx">key</span><span class="p">)</span>
                                                   <span class="o">&amp;&amp;</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="nx">key</span> <span class="o">=</span> <span class="nx">make_num</span><span class="p">(</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_identifier</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                                                <span class="nx">key</span> <span class="o">=</span> <span class="nx">encode_string</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                                        <span class="p">}</span>
                                        <span class="k">return</span> <span class="nx">indent</span><span class="p">(</span><span class="nx">add_spaces</span><span class="p">(</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">space_colon</span>
                                                                 <span class="o">?</span> <span class="p">[</span> <span class="nx">key</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nx">val</span> <span class="p">]</span>
                                                                 <span class="o">:</span> <span class="p">[</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nx">val</span> <span class="p">]));</span>
                                <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">newline</span><span class="p">);</span>
                        <span class="p">})</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">indent</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">obj_needs_parens</span> <span class="o">?</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">:</span> <span class="nx">out</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;regexp&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rx</span><span class="p">,</span> <span class="nx">mods</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">mods</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="s2">&quot;array&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;[]&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;atom&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span> <span class="o">===</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="s2">&quot;,&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                                <span class="k">return</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">);</span>
                        <span class="p">})),</span> <span class="s2">&quot;]&quot;</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;stat&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stmt</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">make</span><span class="p">(</span><span class="nx">stmt</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;*\s*$/</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="s2">&quot;seq&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">slice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">make</span><span class="p">));</span>
                <span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;with&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;with&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">make</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">]);</span>
                <span class="p">},</span>
                <span class="s2">&quot;atom&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">make</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>The squeezer replaces "block"-s that contain only a single
statement with the statement itself; technically, the AST
is correct, but this can create problems when we output an
IF having an ELSE clause where the THEN clause ends in an
IF <em>without</em> an ELSE block (then the outer ELSE would refer
to the inner IF).  This function checks for this case and
adds the block brackets if needed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">function</span> <span class="nx">make_then</span><span class="p">(</span><span class="nx">th</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">th</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">th</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;do&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p><a href='https://github.com/mishoo/UglifyJS/issues/#issue/57'>https://github.com/mishoo/UglifyJS/issues/#issue/57</a>
IE croaks with "syntax error" on code like this:
    if (foo) do ... while(cond); else ...
we need block brackets around do/while</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">return</span> <span class="nx">make_block</span><span class="p">([</span> <span class="nx">th</span> <span class="p">]);</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">th</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>no else, we must add the block</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                                        <span class="k">return</span> <span class="nx">make</span><span class="p">([</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">th</span> <span class="p">]]);</span>
                                <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;while&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;do&quot;</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;for&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;for-in&quot;</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
                        <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">make</span><span class="p">(</span><span class="nx">th</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">keyword</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">keyword</span> <span class="o">||</span> <span class="s2">&quot;function&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">add_commas</span><span class="p">(</span><span class="nx">MAP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">make_name</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
                <span class="nx">out</span> <span class="o">=</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">make_block</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">]);</span>
                <span class="k">return</span> <span class="nx">needs_parens</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">:</span> <span class="nx">out</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">must_has_semicolon</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s2">&quot;with&quot;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s2">&quot;while&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// `with&#39; or `while&#39; with empty body?</span>
                    <span class="k">case</span> <span class="s2">&quot;for&quot;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s2">&quot;for-in&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">empty</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span> <span class="c1">// `for&#39; with empty body?</span>
                    <span class="k">case</span> <span class="s2">&quot;if&quot;</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">empty</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// `if&#39; with empty `then&#39; and no `else&#39;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">empty</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// `else&#39; present but empty</span>
                                <span class="k">return</span> <span class="nx">must_has_semicolon</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="c1">// dive into the `else&#39; branch</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">must_has_semicolon</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// dive into the `then&#39; branch</span>
                <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_block_statements</span><span class="p">(</span><span class="nx">statements</span><span class="p">,</span> <span class="nx">noindent</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">statements</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">last</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">statements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">make</span><span class="p">(</span><span class="nx">stat</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!=</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">must_has_semicolon</span><span class="p">(</span><span class="nx">stat</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;+\s*$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">noindent</span> <span class="o">?</span> <span class="nx">a</span> <span class="o">:</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">indent</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_switch_block</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;{}&quot;</span><span class="p">;</span>
                <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">MAP</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">branch</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">has_body</span> <span class="o">=</span> <span class="nx">branch</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">with_indent</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                                <span class="k">return</span> <span class="nx">indent</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                              <span class="o">?</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="s2">&quot;case&quot;</span><span class="p">,</span> <span class="nx">make</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="p">])</span>
                                              <span class="o">:</span> <span class="s2">&quot;default:&quot;</span><span class="p">);</span>
                        <span class="p">},</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">has_body</span> <span class="o">?</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">with_indent</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                                <span class="k">return</span> <span class="nx">make_block_statements</span><span class="p">(</span><span class="nx">branch</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">join</span><span class="p">(</span><span class="nx">newline</span><span class="p">);</span>
                        <span class="p">})</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">beautify</span> <span class="o">&amp;&amp;</span> <span class="nx">has_body</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">code</span><span class="p">;</span>
                <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="nx">newline</span><span class="p">)</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">indent</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_block</span><span class="p">(</span><span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">statements</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">statements</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;{}&quot;</span><span class="p">;</span>
                <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">with_indent</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                        <span class="k">return</span> <span class="nx">make_block_statements</span><span class="p">(</span><span class="nx">statements</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">newline</span><span class="p">);</span>
                <span class="p">})</span> <span class="o">+</span> <span class="nx">newline</span> <span class="o">+</span> <span class="nx">indent</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">make_1vardef</span><span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">def</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">def</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="nx">add_spaces</span><span class="p">([</span> <span class="nx">make_name</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="nx">parenthesize</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">)</span> <span class="p">]);</span>
                <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
        <span class="p">};</span>

<span class="p">};</span>

<span class="kd">function</span> <span class="nx">split_lines</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">max_line_length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">splits</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
        <span class="nx">jsp</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="kd">var</span> <span class="nx">next_token</span> <span class="o">=</span> <span class="nx">jsp</span><span class="p">.</span><span class="nx">tokenizer</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">last_split</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">prev_token</span><span class="p">;</span>
                <span class="kd">function</span> <span class="nx">current_length</span><span class="p">(</span><span class="nx">tok</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">tok</span><span class="p">.</span><span class="nx">pos</span> <span class="o">-</span> <span class="nx">last_split</span><span class="p">;</span>
                <span class="p">};</span>
                <span class="kd">function</span> <span class="nx">split_here</span><span class="p">(</span><span class="nx">tok</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">last_split</span> <span class="o">=</span> <span class="nx">tok</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
                        <span class="nx">splits</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">last_split</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="kd">function</span> <span class="nx">custom</span><span class="p">(){</span>
                        <span class="kd">var</span> <span class="nx">tok</span> <span class="o">=</span> <span class="nx">next_token</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                        <span class="nx">out</span><span class="o">:</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">prev_token</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">prev_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;keyword&quot;</span><span class="p">)</span> <span class="k">break</span> <span class="nx">out</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">current_length</span><span class="p">(</span><span class="nx">tok</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">max_line_length</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">switch</span> <span class="p">(</span><span class="nx">tok</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="k">case</span> <span class="s2">&quot;keyword&quot;</span><span class="o">:</span>
                                            <span class="k">case</span> <span class="s2">&quot;atom&quot;</span><span class="o">:</span>
                                            <span class="k">case</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span>
                                            <span class="k">case</span> <span class="s2">&quot;punc&quot;</span><span class="o">:</span>
                                                <span class="nx">split_here</span><span class="p">(</span><span class="nx">tok</span><span class="p">);</span>
                                                <span class="k">break</span> <span class="nx">out</span><span class="p">;</span>
                                        <span class="p">}</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="nx">prev_token</span> <span class="o">=</span> <span class="nx">tok</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">tok</span><span class="p">;</span>
                <span class="p">};</span>
                <span class="nx">custom</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">next_token</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="k">return</span> <span class="nx">custom</span><span class="p">;</span>
        <span class="p">}());</span>
        <span class="k">return</span> <span class="nx">splits</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">code</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">splits</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">code</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* -----[ Utilities ]----- */</span>

<span class="kd">function</span> <span class="nx">repeat_string</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">repeat_string</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">d</span> <span class="o">+=</span> <span class="nx">d</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">d</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">defaults</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">defs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">defs</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">defs</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">ret</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span> <span class="o">&amp;&amp;</span> <span class="nx">HOP</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="o">?</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">:</span> <span class="nx">defs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">is_identifier</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="sr">/^[a-z_$][a-z0-9_$]*$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
                <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;this&quot;</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">jsp</span><span class="p">.</span><span class="nx">KEYWORDS_ATOM</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">jsp</span><span class="p">.</span><span class="nx">RESERVED_WORDS</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">jsp</span><span class="p">.</span><span class="nx">KEYWORDS</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">HOP</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>some utilities</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">MAP</span><span class="p">;</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">MAP</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">top</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span><span class="p">;</span>
                <span class="kd">function</span> <span class="nx">doit</span><span class="p">()</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nx">AtTop</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">v</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nx">Splice</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">top</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">top</span><span class="p">,</span> <span class="nx">val</span><span class="p">.</span><span class="nx">v</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">top</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">!=</span> <span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nx">Splice</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">val</span><span class="p">.</span><span class="nx">v</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">};</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">doit</span><span class="p">();</span>
                <span class="k">else</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">a</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">HOP</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="nx">doit</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">top</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">MAP</span><span class="p">.</span><span class="nx">at_top</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">AtTop</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">};</span>
        <span class="nx">MAP</span><span class="p">.</span><span class="nx">splice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Splice</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">skip</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="kd">function</span> <span class="nx">AtTop</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">v</span> <span class="o">=</span> <span class="nx">val</span> <span class="p">};</span>
        <span class="kd">function</span> <span class="nx">Splice</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">v</span> <span class="o">=</span> <span class="nx">val</span> <span class="p">};</span>
<span class="p">})();</span>

<span class="cm">/* -----[ Exports ]----- */</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_walker</span> <span class="o">=</span> <span class="nx">ast_walker</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_mangle</span> <span class="o">=</span> <span class="nx">ast_mangle</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_squeeze</span> <span class="o">=</span> <span class="nx">ast_squeeze</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_lift_variables</span> <span class="o">=</span> <span class="nx">ast_lift_variables</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">gen_code</span> <span class="o">=</span> <span class="nx">gen_code</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_add_scope</span> <span class="o">=</span> <span class="nx">ast_add_scope</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">set_logger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span> <span class="p">{</span> <span class="nx">warn</span> <span class="o">=</span> <span class="nx">logger</span> <span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">make_string</span> <span class="o">=</span> <span class="nx">make_string</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">split_lines</span> <span class="o">=</span> <span class="nx">split_lines</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">MAP</span> <span class="o">=</span> <span class="nx">MAP</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>keep this last!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ast_squeeze_more</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./squeeze-more&quot;</span><span class="p">).</span><span class="nx">ast_squeeze_more</span><span class="p">;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
