<!DOCTYPE html>
<html>
<head>
  <title>XMLHttpRequest.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "node_modules/socket.io/node_modules/socket.io-client/node_modules/xmlhttprequest/lib/XMLHttpRequest.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>XMLHttpRequest.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.</p>
  </div>
  <div class="body"><p>This can be used with JS designed for browsers to improve reuse of code and
allow the use of existing libraries.</p>

<p>Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.</p>
  </div>
  <div class="details">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;child_process&quot;</span><span class="p">).</span><span class="nx">spawn</span>
  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Private variables</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Holds http.js objects</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">client</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">request</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">response</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Request settings</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Set some default headers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">defaultHeaders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;User-Agent&quot;</span><span class="o">:</span> <span class="s2">&quot;node-XMLHttpRequest&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Accept&quot;</span><span class="o">:</span> <span class="s2">&quot;*/*&quot;</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">defaultHeaders</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>These headers are not user setable.
The following are allowed but banned in the spec:
* user-agent</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">forbiddenRequestHeaders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;accept-charset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;accept-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access-control-request-headers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access-control-request-method&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;content-length&quot;</span><span class="p">,</span>
    <span class="s2">&quot;content-transfer-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cookie2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;expect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">,</span>
    <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;origin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;referer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;te&quot;</span><span class="p">,</span>
    <span class="s2">&quot;trailer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transfer-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;via&quot;</span>
  <span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>These request methods are not allowed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">forbiddenRequestMethods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;TRACE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CONNECT&quot;</span>
  <span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Send flag</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">sendFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Error flag, used when errors occur or abort is called</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">errorFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Event listeners</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Constants</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="k">this</span><span class="p">.</span><span class="nx">UNSENT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">LOADING</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">DONE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Public vars</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Current state</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">UNSENT</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>default ready state change handler in case one is not set or is set late</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Result &amp; response</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">responseXML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Private methods</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Check if the specified header is allowed.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>header Header to validate</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>boolean False if not allowed, otherwise true</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">isAllowedHttpHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">header</span> <span class="o">&amp;&amp;</span> <span class="nx">forbiddenRequestHeaders</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Check if the specified method is allowed.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>method Request method to validate</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>boolean False if not allowed, otherwise true</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">isAllowedHttpMethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">forbiddenRequestMethods</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Public methods</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Open the connection. Currently supports local server requests.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>method Connection method (eg GET, POST)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>url URL for the connection.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">boolean</span>
      <span>async Asynchronous connection. Default is true.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>user Username for basic authentication (optional)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>password Password for basic authentication (optional)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">async</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
    <span class="nx">errorFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Check for valid request method</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isAllowedHttpMethod</span><span class="p">(</span><span class="nx">method</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;SecurityError: Request method not allowed&quot;</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span>
      <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
      <span class="s2">&quot;async&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">async</span> <span class="o">!==</span> <span class="s2">&quot;boolean&quot;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="nx">async</span><span class="p">),</span>
      <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="nx">user</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s2">&quot;password&quot;</span><span class="o">:</span> <span class="nx">password</span> <span class="o">||</span> <span class="kc">null</span>
    <span class="p">};</span>

    <span class="nx">setState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Sets a header for the request.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>header Header name</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>value Header value</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isAllowedHttpHeader</span><span class="p">(</span><span class="nx">header</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Refused to set unsafe header &quot;&#39;</span> <span class="o">+</span> <span class="nx">header</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sendFlag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;INVALID_STATE_ERR: send flag is true&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">headers</span><span class="p">[</span><span class="nx">header</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Gets a header from the server response.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>header Name of header to get.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>string Text of the header or null if it doesn't exist.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">getResponseHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">header</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span>
      <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span>
      <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">header</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">errorFlag</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">header</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Gets all the response headers.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>string A string with all response headers separated by CR+LF</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span> <span class="o">||</span> <span class="nx">errorFlag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Cookie headers are excluded</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!==</span> <span class="s2">&quot;set-cookie&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="s2">&quot;set-cookie2&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Gets a request header</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>name Name of header to get</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>string Returns the request header or empty string if not set</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">getRequestHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>@TODO Make this case insensitive</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Sends the request to the server.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">string</span>
      <span>data Optional data to send as request body.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;INVALID_STATE_ERR: connection must be opened before send() is called&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sendFlag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;INVALID_STATE_ERR: send has already been called&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">ssl</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">local</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Determine the server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">protocol</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;https:&#39;</span><span class="o">:</span>
        <span class="nx">ssl</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>SSL &amp; non-SSL both need host, no break here.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">case</span> <span class="s1">&#39;http:&#39;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;file:&#39;</span><span class="o">:</span>
        <span class="nx">local</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="kc">undefined</span><span class="o">:</span>
      <span class="k">case</span> <span class="s1">&#39;&#39;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="s2">&quot;Protocol not supported.&quot;</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Load files off the local filesystem (file://)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;XMLHttpRequest: Only GET method is supported&quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
            <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
          <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Default to port 80. If accessing localhost on another port be sure
to use <a href='http://localhost:port/path'>http://localhost:port/path</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="p">(</span><span class="nx">ssl</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Add query string if one is used</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">search</span> <span class="o">?</span> <span class="nx">url</span><span class="p">.</span><span class="nx">search</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Set the Host header or the server may reject the request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Host&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">host</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="nx">ssl</span> <span class="o">&amp;&amp;</span> <span class="nx">port</span> <span class="o">===</span> <span class="mi">443</span><span class="p">)</span> <span class="o">||</span> <span class="nx">port</span> <span class="o">===</span> <span class="mi">80</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Host&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Set Basic Auth if necessary</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">password</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">authBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="nx">authBuf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Set content length header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&quot;GET&quot;</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text/plain;charset=UTF-8&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>For a post with no data set Content-Length: 0.
This is required by buggy servers that don't meet the specs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">host</span><span class="o">:</span> <span class="nx">host</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
      <span class="nx">path</span><span class="o">:</span> <span class="nx">uri</span><span class="p">,</span>
      <span class="nx">method</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">headers</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Reset error flag</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">errorFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Handle async requests</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Use the proper protocol</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">doRequest</span> <span class="o">=</span> <span class="nx">ssl</span> <span class="o">?</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span> <span class="o">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Request is being sent, set send flag</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">sendFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>As per spec, this is called here for historical reasons.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;readystatechange&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Create the request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">request</span> <span class="o">=</span> <span class="nx">doRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">);</span>

        <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Make sure there's some data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
          <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Don't emit state changes if the connection has been aborted.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sendFlag</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">LOADING</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sendFlag</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Discard the 'end' event if the connection has been aborted</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
            <span class="nx">sendFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Node 0.4 and later won't accept empty data. Make sure it's needed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;loadstart&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Synchronous</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Create a temporary file for communication with the other Node process</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">syncFile</span> <span class="o">=</span> <span class="s2">&quot;.node-xmlhttprequest-sync-&quot;</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="p">;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">syncFile</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>The async request the other Node process executes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">execString</span> <span class="o">=</span> <span class="s2">&quot;var http = require(&#39;http&#39;), https = require(&#39;https&#39;), fs = require(&#39;fs&#39;);&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;var doRequest = http&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ssl</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.request;&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;var options = &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;var responseText = &#39;&#39;;&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;var req = doRequest(options, function(response) {&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;response.setEncoding(&#39;utf8&#39;);&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;response.on(&#39;data&#39;, function(chunk) {&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;responseText += chunk;&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;});&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;response.on(&#39;end&#39;, function() {&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;fs.writeFileSync(&#39;&quot;</span> <span class="o">+</span> <span class="nx">syncFile</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;NODE-XMLHTTPREQUEST-STATUS:&#39; + response.statusCode + &#39;,&#39; + responseText, &#39;utf8&#39;);&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;});&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;response.on(&#39;error&#39;, function(error) {&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;fs.writeFileSync(&#39;&quot;</span> <span class="o">+</span> <span class="nx">syncFile</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;NODE-XMLHTTPREQUEST-ERROR:&#39; + JSON.stringify(error), &#39;utf8&#39;);&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;});&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;}).on(&#39;error&#39;, function(error) {&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;fs.writeFileSync(&#39;&quot;</span> <span class="o">+</span> <span class="nx">syncFile</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;NODE-XMLHTTPREQUEST-ERROR:&#39; + JSON.stringify(error), &#39;utf8&#39;);&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;});&quot;</span>
        <span class="o">+</span> <span class="p">(</span><span class="nx">data</span> <span class="o">?</span> <span class="s2">&quot;req.write(&#39;&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;/g</span><span class="p">,</span> <span class="s2">&quot;\\&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;);&quot;</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;req.end();&quot;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Start the other Node Process, executing this string</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">syncProc</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="nx">execString</span><span class="p">]);</span>
      <span class="k">while</span><span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">syncFile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Wait while the file is empty</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Kill the child process once the file has data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">syncProc</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Remove the temporary file</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="nx">syncFile</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^NODE-XMLHTTPREQUEST-ERROR:/</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>If the file returned an error, handle it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">errorObj</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^NODE-XMLHTTPREQUEST-ERROR:/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">errorObj</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>If the file returned okay, parse its data and move to the DONE state</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span><span class="p">);</span>
        <span class="nx">setState</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Called when an error is encountered to deal with it.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">503</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">;</span>
    <span class="nx">errorFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">setState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Aborts a request.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">abort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="nx">request</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">headers</span> <span class="o">=</span> <span class="nx">defaultHeaders</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responseXML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="nx">errorFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">UNSENT</span>
        <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">OPENED</span> <span class="o">||</span> <span class="nx">sendFlag</span><span class="p">)</span>
        <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sendFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">setState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">UNSENT</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Adds an event listener. Preferred method of binding to events.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">event</span> <span class="k">in</span> <span class="nx">listeners</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Currently allows duplicate callbacks. Should it?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Remove an event callback that has already been bound.
Only works on the matching funciton, cannot be a copy.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="k">in</span> <span class="nx">listeners</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Filter will return a new array with the callback removed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ev</span> <span class="o">!==</span> <span class="nx">callback</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Dispatch any events, including both "on" methods and events attached using addEventListener.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">[</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">[</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">]();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="k">in</span> <span class="nx">listeners</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">listeners</span><span class="p">[</span><span class="nx">event</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Changes readyState and calls onreadystatechange.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">int</span>
      <span>state New state</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">setState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">async</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">OPENED</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;readystatechange&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">self</span><span class="p">.</span><span class="nx">DONE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">errorFlag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>@TODO figure out InspectorInstrumentation::didLoadXHR(cookie)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;loadend&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
